/* (C) 2012 AOL Inc. All Rights Reserved */
dojo._xdResourceLoaded(function(){return{depends:[["provide","ws.address.ComposeAddressField"],["provide","ws.AboutMe"],["provide","ws.mail.SendConfirmationCard"],["provide","ws.mail.SendConfirmationPage"],["provide","ws.pictures.PictureEditControl"],["provide","ws.widget.SmileyPalette"],["provide","ws.widget.ColorPalette"],["provide","ws.widget.LinkEditor"],["provide","ws.mail.funmail"],["provide","ws.widget.LayoutContainer"],["provide","ws.widget.WSEditor"],["provide","ws.widget.SpellCheckEditor"],
["provide","ws.pictures.PictureEditor"],["provide","ws.mail.ComposeMessageWidget"],["provide","ws.layers.ComposeMessage"]],defineResource:function(e,k,q){e._hasResource["ws.address.ComposeAddressField"]||(e._hasResource["ws.address.ComposeAddressField"]=!0,e.provide("ws.address.ComposeAddressField"),e.declare("ws.address.ComposeAddressField",ws.address.AddressField,{templateString:"<div class='caf wsInput'><div class='addressLabel' dojoAttachPoint='contactSelector2' style='line-height:${lineHeight}px;'>${ghostText}:</div><div dojoAttachPoint='contactSelector' class='contactSelector'><div class='csIcon mainSprite' style='line-height:${lineHeight}px;'></div></div><div dojoAttachPoint='scrollContainer' style='overflow:hidden;'><textarea dojoAttachPoint='field' dojoAttachEvent='onkeydown: onKeyDown, onkeypress: onKeyPress, onfocus: onFocus, onblur: onBlur' tabindex='${tabindex}' class='${className}' style='overflow:hidden;height: ${baseSize}px; width: 100%'>${value}</textarea></div></div>",
css:{templateString:""},ghostText:"",ghostTextPersistent:!0,maxHeight:0,minHeight:0,numOfLines:0,startingNumOfLines:0,padding:7,baseSize:12,lineHeight:0,width:0,postMixInProperties:function(){if(this.startingNumOfLines>this.numOfLines)this.startingNumOfLines=this.numOfLines;this.lineHeight=this.lineHeight!=0?this.lineHeight:this.baseSize;this.maxHeight=this.numOfLines!=0?this.numOfLines*this.lineHeight:this.lineHeight*4;this.minHeight=this.lineHeight*(this.startingNumOfLines?this.startingNumOfLines:
1)},postCreate:function(){this.inherited(arguments);e.addClass(this.field,"wsInputBare");if(!this.ghostText)this.contactSelector2.style.display="none";if(this.width!=0)this.domNode.style.width=this.width+"px";this.connect(this.contactSelector,"onclick",this.showPeoplePicker);this.ghostText&&!this.ghostTextPersistent?this.connect(this.contactSelector2,"onmousedown",this.showPeoplePicker):this.connect(this.contactSelector2,"onclick",this.showPeoplePicker);this.anchorNode=this.domNode;this.connect(this,
"onClick","handleClick")},onKeyPress:function(a){a.ctrlKey&&window.setTimeout(e.hitch(this,"resizeSelf",!0),100);this.inherited(arguments)},showPeoplePicker:function(a){e.stopEvent(a);this.togglePeoplePicker(this.domNode)},handleClick:function(a){a.target&&(!e.hasClass(a.target,"addressField")&&!e.hasClass(a.target,"csIcon")&&this.field.focus(),(e.hasClass(a.target,"csIcon")||e.hasClass(a.target,"addressLabel"))&&a.preventDefault())},reset:function(){this.setValue("");this.ghostText?e.query(".addressLabel",
this.domNode)[0].style.display="":e.query(".addressLabel",this.domNode)[0].style.display="none"},createMeasureNode:function(){if(!this.measureNode)this.measureNode=e.create("div",{style:{position:"absolute",visibility:"hidden",top:"-10000px",left:"10000px",fontSize:this.baseSize+"px",lineHeight:this.lineHeight+"px"}},e.body()),this.field.style.fontSize=this.baseSize+"px",this.field.style.lineHeight=this.lineHeight+"px"},resizeSelf:function(a){this.createMeasureNode();var c=e.coords(this.field).w;
this.measureNode.innerHTML=this.field.value.replace(/\n/g,"<br>");this.measureNode.style.width=parseInt(c)+"px";var c=e.contentBox(this.measureNode),c=Math.max(this.minHeight,c.h),d=Math.min(this.maxHeight,c);this.field.style.height=c+"px";if(a)this.domNode.style.height=d+this.padding+"px",this.repositionPicker();d==this.maxHeight?c>d?this.domNode.style.overflowY="auto":(this.domNode.style.height=d+this.padding-4+"px",this.repositionPicker()):(this.domNode.style.overflowY="hidden",this.domNode.style.height=
d+"px",this.repositionPicker())},onFocus:function(){if(this.ghostText&&!this.ghostTextPersistent)e.query(".addressLabel",this.domNode)[0].style.display="none";this.inherited(arguments)},onBlur:function(){ws.lang.setTimeout(this,function(){if(this.ghostText&&!this.ghostTextPersistent&&this.getValue()=="")e.query(".addressLabel",this.domNode)[0].style.display=""},50);this.inherited(arguments)},repositionPicker:function(){this._pickerActive&&this.peoplePicker.move(this.domNode,{offsetHeight:-1});this.onResizedSelf()},
scrollToEnd:function(){this.domNode.scrollTop=1E4;this.scrollContainer.scrollTop=1E4;this.field.scrollTop=1E4}}));if(!e._hasResource["ws.AboutMe"])e._hasResource["ws.AboutMe"]=!0,e.provide("ws.AboutMe"),ws.AboutMe={alreadySeenMap:{},clearSeenTimer:null,ownerCheckDone:!1,ownerHasProfile:!1,ownerProfile:null,search:function(a,c,d){if(!this.clearSeenTimer)this.clearSeenTimer=setInterval(function(){ws.AboutMe.alreadySeenMap={}},Config.AboutMeExcludeTimeout*1E3);for(var f=[],g={},i=0;i<a.length;i++){var j=
a[i].toLowerCase();if(!this.alreadySeenMap[j]&&!g[j]&&(g[j]=!0,f.push(j),f.length>=Config.AboutMeMaxEmailReq))break}this.ownerCheckDone||(f=[Settings.ActiveUserEmailAddress].concat(f));f.length==0?c&&c(null):(a=f.join(","),e.io.script.get({callbackParamName:"callback",timeout:d?Config.AboutMeRPCLongTimeout:Config.AboutMeRPCTimeout,url:Config.AboutMeJSONPurl,content:{email:a},load:e.hitch(this,function(a){a&&a.status==200&&a.result?this.processResults(a.result,c):c&&c(null)}),error:function(){c&&c(null)}}))},
addToSeenMap:function(a){a&&(this.alreadySeenMap[a]=!0)},processResults:function(a,c){if(!this.ownerCheckDone){this.ownerCheckDone=!0;for(var d=Settings.ActiveUserEmailAddress.toLowerCase(),e=0;e<a.length;e++)if(a[e].email_address&&a[e].email_address==d){this.ownerHasProfile=!0;this.ownerProfile=a[e];a.splice(e,1);break}}for(e=0;e<a.length;e++)d=a[e],d.thumbnail1==null&&d.thumbnail2==null&&a.splice(e,1);c&&c(a)}};e._hasResource["ws.mail.SendConfirmationCard"]||(e._hasResource["ws.mail.SendConfirmationCard"]=
!0,e.provide("ws.mail.SendConfirmationCard"),e.declare("ws.mail.SendConfirmationCard",[k._Widget,k._Templated],{templateString:e.cache("ws.mail","SendConfirmationCard.html",'<div>\r\n\t<\!--\r\n\t<div dojoType="ws.widget.Pane" dojoAttachPoint="invitePane" style="display: none;">\r\n\t\t<table class="sendConfirmationTable" border="0" cellpadding="4" cellspacing="1">\r\n\t\t\t<tr>\r\n\t\t\t\t<td colspan="10"><span class="inputLabels">${To}: </span></td>\r\n\t\t\t\t<td colspan="40"><input type="text" class="wsInput regularInput" dojoAttachPoint="toInput" /></td>\r\n\t\t\t</tr>\r\n\t\t\t<tr>\r\n\t\t\t\t<td colspan="10"><span class="inputLabels">${Subject}: </span></td>\r\n\t\t\t\t<td colspan="40"><input type="text" class="wsInput regularInput" dojoAttachPoint="subjectInput" /></td>\r\n\t\t\t</tr>\r\n\t\t\t<tr>\r\n\t\t\t\t<td colspan="50">\r\n\t\t\t\t\t<textarea class="contentText" dojoAttachPoint="inviteContent" rows="5" wrap="virtual"></textarea>\r\n\t\t\t\t</td>\r\n\t\t\t</tr>\r\n\t\t\t<tr>\r\n\t\t\t\t<td colspan="25" align="right">\r\n\t\t\t\t\t<div dojoType="ws.widget.Button" dojoAttachEvent="onClick: sendInvite">${Invite}</div>\r\n\t\t\t\t</td>\r\n\t\t\t\t<td colspan="25" align="left">\r\n\t\t\t\t\t<div dojoType="ws.widget.Button" dojoAttachEvent="onClick: hide">${Cancel}</div>\r\n\t\t\t\t</td>\r\n\t\t\t</tr>\r\n\t\t</table>\r\n\t</div>\r\n\t--\>\r\n\t<div dojoType="ws.widget.Pane" dojoAttachPoint="createListPane" style="display: none; overflow: auto;">\r\n\t\t<div dojoType="ws.widget.Pane" dojoAttachPoint="creatingList" class="creatingList" style="display:none">\r\n\t\t\t<img src="${spacer}" class="mainSprite wsCloseBtn" dojoAttachEvent="onclick: closeCard">\r\n\t\t\t<table class="createListTable" dojoAttachPoint="createListTable">\r\n\t\t\t\t<tr>\r\n\t\t\t\t\t<td valign="top" dojoAttachPoint="listNameInputRow">\r\n\t\t\t\t\t\t<input type="text" class="wsInput listNameInput" dojoAttachPoint="listNameInput" dojoAttachEvent="onkeypress: onKeyPress"/>\r\n\t\t\t\t\t\t<div dojoAttachPoint="error" class="error"></div>\r\n\t\t\t\t\t</td>\r\n\t\t\t\t</tr>\r\n\t\t\t\t<tr dojoAttachPoint="errorRow">\r\n\t\t\t\t\t<td valign="top" class="error" dojoAttachPoint="errorMsg">\r\n\t\t\t\t\t</td>\r\n\t\t\t\t</tr>\r\n\t\t\t\t<tr>\r\n\t\t\t\t\t<td valign="top">\r\n\t\t\t\t\t\t<div class="listContacts" dojoAttachPoint="listContacts"></div>\r\n\t\t\t\t\t</td>\r\n\t\t\t\t</tr>\r\n\t\t\t\t<tr>\r\n\t\t\t\t\t<td>\r\n\t\t\t\t\t\t<div dojoAttachPoint="okToolBar" dojoType="ws.widget.WSToolbar" vizType="Bare">\r\n\t\t\t\t\t\t\t<div dojoType="ws.widget.Button" dojoAttachPoint="createListButton" dojoAttachEvent="onClick: checkRequiredFields" toolbarPosition="left">${Create}</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</td>\r\n\t\t\t\t</tr>\r\n\t\t\t</table>\r\n\t\t</div>\r\n\t\t<div dojoType="ws.widget.Pane" dojoAttachPoint="listCreated"  class="listCreated">\r\n\t\t\t<div class="listCreatedText"><span>${ListCreated}</span></div>\r\n\t\t\t<div dojoType="ws.widget.WSToolbar" dojoAttachPoint="listCreatedTB" vizType="Bare">\r\n\t\t\t\t<div dojoType="ws.widget.Button" dojoAttachEvent="onClick:closeCard" toolbarPosition="center">${OK}</div>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t</div>\r\n</div>\r\n'),
css:{templateString:""},widgetsInTemplate:!0,_earlyTemplatedStartup:!0,confirmationWidget:null,model:null,from:null,addresses:null,maxEmailsToDisplay:10,startup:function(){this.addressModel=new ws.address.AddressModel},fillOutList:function(a,c,d){this.createListPane.show();this.creatingList.show();this.listCreated.hide();this.createListButton.enable();this.domNode.className="createListPane";this.addresses=[];for(this.addresses=a.concat(c,d);this.listContacts.childNodes.length;)e._destroyElement(this.listContacts.firstChild);
this.errorMsg.innerHTML="";this.errorRow.style.display="none";e.style(this.listContacts,{overflow:"visible",maxHeight:"none",height:"auto",width:"auto"});this.listNameInput.style.width="auto";this.createListTable.style.width="auto";this.show();ws.widget.fixFFCursor(this.createListPane);for(a=0;a<this.addresses.length;a++)this["listItem"+a]=ws.widget.Checkbox({label:this.addresses[a],checked:!0}),this["listItem"+a].startup(),this.listContacts.appendChild(this["listItem"+a].domNode);this.listNameInput.value=
Config.Strings.EnterListName;ws.lang.setTimeout(this,function(){if(this.addresses.length>this.maxEmailsToDisplay-1){var a=e._getMarginSize(this.listItem0.domNode).h*this.maxEmailsToDisplay;this.listContacts.style.height=a+"px";var c=e._getMarginSize(this.listContacts).w;e.style(this.listContacts,{overflow:"auto",maxHeight:a+"px",height:a+"px",width:c+20+"px"});this.listNameInput.style.width=c+16+"px";this.createListTable.style.width=c+20+"px"}else this.listNameInput.style.width=e._getMarginSize(this.listContacts).w+
"px",this.createListTable.style.width=e._getMarginSize(this.listContacts).w+"px";this.listNameInput.select();this.okToolBar.layout()},0)},onKeyPress:function(a){if(this.errorRow.style.display!="none")this.errorMsg.innerHTML="",this.errorRow.style.display="none";a.keyCode==e.keys.ENTER&&this.checkRequiredFields();a.stopPropagation()},checkRequiredFields:function(){var a=this.listNameInput.value,a=a.replace(/^\s+/,"");(a=a.replace(/\s+$/,""))&&a!=Config.Strings.EnterListName?this.saveDistributionList(a):
(this.errorMsg.innerHTML=Config.Strings.NameDistList,this.errorRow.style.display="block")},saveDistributionList:function(a){for(var c=[],d=0;d<this.addresses.length;d++)this["listItem"+d].checked&&c.push(this.addresses[d]);c.length==0?(this.errorMsg.innerHTML=Config.Strings.IncludeEmailDistList,this.errorRow.style.display="block"):this.addressModel.searchDLName(a)!=null?(this.errorMsg.innerHTML=Config.Strings.DuplicateDistributionList,this.errorRow.style.display="block"):(this.createListButton.disable(),
this.addressModel.createOrModifyDistributionList({uid:0,name:a,contactUids:[],addresses:c,load:e.hitch(this,function(){this.creatingList.hide();this.listCreated.show();ws.lang.setTimeout(this,function(){this.listCreatedTB.layout()})},0),error:e.hitch(this,function(a){this.createListButton.enable();window.ws_ErrLgr&&!a&&ws_ErrLgr.logError(ws_ErrLgr.cat.UserVisErr,"Dialogs.ok shown - Error Handler for addressModel.createOrModifyDistributionList-saveDistributionList file:SendConfirmationCard.js");ws.widget.Dialogs.ok(a||
Config.Strings.ErrorSavingDistList)})}))},closeCard:function(){this.creatingList.hide();this.listCreated.hide();this.createListPane.hide();this.hide();ws.widget.popup.close(this)}}));e._hasResource["ws.mail.SendConfirmationPage"]||(e._hasResource["ws.mail.SendConfirmationPage"]=!0,e.provide("ws.mail.SendConfirmationPage"),e.declare("ws.mail.SendConfirmationPage",[k._Widget,k._Templated],{templateString:e.cache("ws.mail","SendConfirmationPage.html",'<div>\r\n\t<div dojotype="dijit.layout.LayoutContainer" class="sendConfirmation" dojoattachpoint="layoutWidget">\r\n\t\t<div dojotype="ws.widget.Pane" class="confirmationHeader" layoutalign="top">\r\n\t\t\t<div dojoType="ws.widget.Pane"  class="searchInfo" layoutAlign="top" >\r\n\t\t\t\t<img src="${spacer}" class="mainSprite icon" />\r\n\t\t\t\t<div class="confirmMessage">\r\n\t\t\t\t\t${ComposeSentTitle}\r\n\t\t\t\t</div>\r\n\t\t\t\t<img src="${spacer}" class="pipe" />\r\n\t\t\t\t<div dojoattachpoint="backToButton" dojoattachevent="onclick: cancel" class="linkButton"></div>\r\n\t\t\t\t<img dojoattachpoint="backToMessagePipe" src="${spacer}" class="pipe" style="display:none" />\r\n\t\t\t\t<div dojoattachpoint="backToMessage" dojoattachevent="onclick: cancelToMessage" class="linkButton" style="display:none">${BackToMessageBtn}</div>\r\n\t\t\t\t<img dojoattachpoint="createDistPipe" src="${spacer}" class="pipe" style="display:none"/>\r\n\t\t\t\t<div dojoattachpoint="createDistributionListButton" title="${CreateListFromRecipsTip}" dojoattachevent="onclick: createDistributionList" class="createListLink" style="display:none"><img src="${spacer}" class="mainSprite createListIcon">${CreateDistListButton}</div>\r\n\t\t\t</div>\r\n\t\t\t<div dojotype="ws.widget.Pane" dojoattachpoint="AddToTopContacts" layoutalign="top" class="confirmationHeader">\r\n\t\t\t\t<div class="confirmAddTopContactsText">\r\n\t\t\t\t\t${TopContacts_AddToTopContacts}<span dojoattachpoint="addTopContactSuggest"></span>\r\n\t\t\t\t</div>\r\n\t\t\t\t<div dojotype="ws.widget.Button" type="Alt3" dojoattachpoint="addToTopContactsButton" dojoattachevent="onClick: addSuggestionToTopContacts">\r\n\t\t\t\t\t${Add}</div>\r\n\t\t\t\t<div dojotype="ws.widget.Button" type="Alt3" dojoattachpoint="addNegativeToTopContactsButton" dojoattachevent="onClick: addNegativeToTopContacts">\r\n\t\t\t\t\t${NoThanks}</div>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t\t<\!-- End of header, start content variants --\>\r\n\t\t<div dojotype="dijit.layout.StackContainer" dojoattachpoint="sendConfPages" layoutalign="client" style="overflow:hidden">\r\n\t\t\t<div dojotype="dijit.layout.LayoutContainer" dojoattachpoint="emptyPage">\r\n\t\t\t</div>\r\n\t\t\t<div dojotype="dijit.layout.LayoutContainer" dojoattachpoint="sendConfHistoric">\r\n\t\t\t\t<div dojotype="ws.widget.Advertisement" layoutalign="bottom" adtype="sendconfirmtext" dojoattachpoint="confirmationTxtAdvertisement">\r\n\t\t\t\t</div>\r\n\t\t\t\t<div dojotype="ws.widget.Pane" class="feedbackPane" layoutalign="left" dojoattachpoint="feedbackPane">\r\n\t\t\t\t\t<div dojoattachpoint="sendConfirmationPane">\r\n\t\t\t\t\t\t<iframe src="about:blank" frameborder="0" scrolling="no" style="width: 340px; height: 270px;"></iframe>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t\t<div dojotype="ws.widget.Advertisement" layoutalign="client" adtype="sendconfirm" dojoattachpoint="confirmationAdvertisement">\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t\t<div dojotype="dijit.layout.LayoutContainer" dojoattachpoint="fullSendConfirmationPage">\r\n\t\t\t\t<div dojotype="ws.widget.Pane" dojoattachpoint="fullSendConfirmationPane" layoutalign="client">\r\n\t\t\t\t\t<iframe dojoattachpoint="fullSendConfirmationPaneFrame" src="about:blank" frameborder="0" style="width: 100%; height: 100%;"></iframe>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t\t<div dojotype="dijit.layout.LayoutContainer" dojoattachpoint="aboutMe" class="headerDropShadow">\r\n\t\t\t<div dojotype="ws.widget.Pane" layoutalign="client">\r\n\t\t\t\t<div dojoattachpoint="aboutMeHeader" class="aboutMeHeader">\r\n\t\t\t\t</div>\r\n\t\t\t\t<div dojoattachpoint="aboutMeSubHeader" class="aboutMeSubHeader">\r\n\t\t\t\t</div>\r\n\t\t\t\t<div dojoattachpoint="imageProfiles" class="imageProfiles">\r\n\t\t\t\t</div>\r\n\t\t\t\t<div dojoattachpoint="textProfiles" class="txtProfiles">\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t</div>\r\n</div>\r\n'),
css:{templateString:""},widgetsInTemplate:!0,_earlyTemplatedStartup:!0,composeWidget:null,defaultSendConf:null,enabledPluginsToggle:!1,openSidePanelAfterSendConf:!1,_isShowing:!1,startup:function(){this.subscribe("Theme/Change","updateFullSendConfirmationIFrame");this.subscribe(this.composeWidget.stackWidget.id+"-selectChild","handleComposeStackSelect");this.subscribe("ws_view-selectChild","handleComposeStackSelect");if(Config.EnableFullSendConfirmationPage){this.defaultSendConf=this.fullSendConfirmationPage;
if(this.confirmationTxtAdvertisement)this.confirmationTxtAdvertisement.destroy(),this.confirmationTxtAdvertisement=null;if(this.confirmationAdvertisement)this.confirmationAdvertisement.destroy(),this.confirmationAdvertisement=null}else this.defaultSendConf=this.sendConfHistoric,this.confirmationTxtAdvertisement.domNode.style.height=e.isMozilla?"45px":"25px",Config.AdFeedbackURL&&Config.AdFeedbackURL.length>0&&Settings.SendConfirmAdMagic!=0&&this.confirmationAdvertisement.addAdFeedBack(Config.AdFeedbackURL)},
setupSendConfirmation:function(a,c,d,f){this.sendConfPages.selectedChildWidget!=this.emptyPage&&this.sendConfPages.selectChild(this.emptyPage);this.layoutWidget.layout();this.toAddresses=[];this.ccAddresses=[];this.bccAddresses=[];c=!this.composeWidget.isPopup&&!this.composeWidget.isStandAlone;d=d&&ws.WebSuite.composeSrc=="display"&&c?!0:!1;ws.html.setShowing(this.backToMessage,d);ws.html.setShowing(this.backToMessagePipe,d);this.topContactSuggest=f||null;d=null;f&&(f.isEmail?d="&nbsp;("+f.email1+
")"||null:(f.firstName&&f.lastName?d="&quot;"+f.firstName+"&nbsp;"+f.lastName+"&quot;":f.screenName&&(d="&quot;"+f.screenName+"&quot;"),f.email1?d=(d?d:"")+"&nbsp;("+f.email1+")":f.email2&&(d=(d?d:"")+"&nbsp;("+f.email2+")")));d?(this.addTopContactSuggest.innerHTML="&nbsp;"+d,this.AddToTopContacts.domNode.style.display=""):this.AddToTopContacts.domNode.style.display="none";this.backToButton.innerHTML=a;this.toAddresses=this.composeWidget.addressListToArray(this.composeWidget.toField);this.ccAddresses=
this.composeWidget.addressListToArray(this.composeWidget.ccField);this.bccAddresses=this.composeWidget.addressListToArray(this.composeWidget.bccField);d=this.toAddresses.length+this.ccAddresses.length+this.bccAddresses.length>1?!0:!1;ws.html.setShowing(this.createDistributionListButton,d);ws.html.setShowing(this.createDistPipe,d);Settings.UserHash>=Config.AboutMeThreshold?(a=this.toAddresses.concat(this.ccAddresses,this.bccAddresses),ws.AboutMe.search(a,e.hitch(this,this.selectSendConfPage))):this.selectSendConfPage(null)},
selectSendConfPage:function(a){this.isFullSendConfirmationShwowing=!1;ws.lang.setTimeout(this,function(a){var d=!1;a&&a.length&&(a.length==1?a[0].thumbnail1&&(d=!0):d=!0);d?(this.sendConfPages.selectedChildWidget!=this.aboutMe&&this.sendConfPages.selectChild(this.aboutMe),this.setAboutMePage(a)):(this.sendConfPages.selectedChildWidget!=this.defaultSendConf&&this.sendConfPages.selectChild(this.defaultSendConf),this.setDefaultPage())},5,a)},setAboutMePage:function(a){var c=function(a,c,d){if(c)if(c=
document.createElement("img"),e.addClass(c,"aboutMeImgProfile"),d){if(e.addClass(c,"aboutMeImgProfileLarge"),a.thumbnail1)c.src=a.thumbnail1}else c.src=a.thumbnail2;else c=document.createElement("span"),e.addClass(c,"wsLink"),d=document.createTextNode(e.trim(a.display_name)),c.appendChild(d);a.email_address&&ws.AboutMe.addToSeenMap(a.email_address);return c};ws.reporting.report("Send Confirmation - AboutMe","Mail");this.layoutWidget.layout();this.imageProfiles.innerHTML="";this.textProfiles.innerHTML=
"";this.enabledPluginsToggle=!0;if(!this.composeWidget.isPopup&&!this.composeWidget.isStandAlone&&ws.WebSuite.SidePanel&&!ws.WebSuite.SidePanel.isClosed())ws.WebSuite.SidePanel.hide(),this.openSidePanelAfterSendConf=!0;var d=Config.Strings.AboutMe_Header,f=Config.Strings.AboutMe_SubHeader;if(a.length==1&&a[0].display_name){var g=e.trim(a[0].display_name).split(" ");g.length&&(f=g[0],d=ws.string.substituteParams(Config.Strings.AboutMe_HeaderNamed,f),f=ws.string.substituteParams(Config.Strings.AboutMe_SubHeaderNamed,
f))}this.aboutMeHeader.innerHTML=d;this.aboutMeSubHeader.innerHTML=f+"  ";ws.AboutMe.ownerHasProfile||(d=document.createElement("span"),e.addClass(d,"wsLink"),f=document.createTextNode(Config.Strings.AboutMe_CreateProfile),d.appendChild(f),this.aboutMeSubHeader.appendChild(d),this.connect(d,"onclick",e.hitch(this,"aboutMeCreateProfile")));if(a.length==1){var i=c(a[0],!0,!0);this.imageProfiles.appendChild(i);this.connect(i,"onclick",e.hitch(this,"handleProfileClick",a[0].profile))}else for(var d=e.marginBox(this.aboutMe.domNode).w-
25,d=Math.max(Math.min(Math.floor(d/281),6),1),f=Math.min(Math.max(a.length-d,0),10),g=!0,j=0;j<a.length;j++)if(d)i=c(a[j],!0),this.imageProfiles.appendChild(i),this.connect(i,"onclick",e.hitch(this,"handleProfileClick",a[j].profile)),d&&d--;else if(f){if(g)this.textProfiles.innerHTML="<span class=''>"+Config.Strings.AboutMe_ExtraProfiles+"</span> ",g=!1;i=c(a[j]);this.textProfiles.appendChild(i);this.connect(i,"onclick",e.hitch(this,"handleProfileClick",a[j].profile));i=null;f>2?i=document.createTextNode(", "):
f>1&&(i=document.createTextNode(" "+Config.Strings.AboutMe_and+" "));i&&this.textProfiles.appendChild(i);f&&f--}else break},aboutMeCreateProfile:function(){var a=ws.io.openWindow(Config.AboutMeCreateUrl,null,"");a&&a.focus()},handleProfileClick:function(a){(a=ws.io.openWindow(a,null,""))&&a.focus()},updateFullSendConfirmationIFrame:function(){if(this._isShowing&&this.isFullSendConfirmationShwowing){var a=Settings.MailboxTier.length>0?Config.SendConfirmationLinkPremium:Config.SendConfirmationLink||
Config.BaseResourcesURL+"SendConfirmation.htm";if(Config.SendConfPageIsRichContent&&!this.composeWidget.isPopup&&!this.composeWidget.isStandAlone&&ws.WebSuite.SidePanel&&!ws.WebSuite.SidePanel.isClosed())this.enabledPluginsToggle=!0,ws.WebSuite.SidePanel.hide(),this.openSidePanelAfterSendConf=!0;if(Config.SendConfPageIsRichContent){var c=a.indexOf("?")==-1?"?":"&";a+=c+"ts="+encodeURIComponent(e.date.stamp.toISOString(new Date));document.location.host&&(a+="&retHst="+encodeURIComponent(document.location.host))}else ws.reporting.report("Send Confirmation",
"Mail");Config.EnableThemes&&(a+=(a.indexOf("?")>0?"&":"?")+this._getThemeColor());window._g_WS_WebFont&&window._g_WS_WebFont.fontMode&&(a+=(a.indexOf("?")>0?"&":"?")+"fontCss="+window._g_WS_WebFont.webFontsMap[window._g_WS_WebFont.fontMode]);ws.html.recreateIframe(this.fullSendConfirmationPane.domNode,a)}},setDefaultPage:function(){this.layoutWidget.layout();this.openSidePanelAfterSendConf=!1;if(Config.EnableFullSendConfirmationPage)this.isFullSendConfirmationShwowing=!0,this.updateFullSendConfirmationIFrame();
else{var a=Settings.MailboxTier.length>0?Config.SendConfirmationLinkPremium:Config.SendConfirmationLink||Config.BaseResourcesURL+"SendConfirmation.htm";ws.reporting.report("Send Confirmation","Mail");this.enabledPluginsToggle=!1;if(a=="about:blank")this.feedbackPane.domNode.style.display="none",this.layoutWidget.layout();this.confirmationAdvertisement&&this.confirmationAdvertisement.domNode&&(e.addClass(this.confirmationAdvertisement.domNode,"confirmationAdvertisement"),this.confirmationAdvertisement.block(!1,
!0));this.confirmationTxtAdvertisement&&this.confirmationTxtAdvertisement.domNode&&this.confirmationTxtAdvertisement.block(!1,!0);ws.html.recreateIframe(this.sendConfirmationPane,a)}},_getThemeColor:function(){this.themeColorsDone=!0;var a=window._ws_theme.getThemeColorQueryString(!1,!0,!1);a||(a="lightest=A5D8ED&midlightlight=46B9E9&midlight=46B9E9&darkest=077BA6&link=46B9E9");return a},createCard:function(){if(!this.sendConfirmationCard)this.sendConfirmationCard=new ws.mail.SendConfirmationCard({confirmationWidget:this,
model:this.composeWidget.model}),this._supportingWidgets.push(this.sendConfirmationCard),this.sendConfirmationCard.startup()},createDistributionList:function(){this.createCard();ws.widget.popup.closeAllPopups();ws.widget.popup({popup:this.sendConfirmationCard,around:this.createDistributionListButton,padding:[60,ws.widget.pointerHeight]});this.sendConfirmationCard.fillOutList(this.toAddresses,this.ccAddresses,this.bccAddresses);ws.widget.pointer({node:this.sendConfirmationCard.domNode,side:"top",target:this.createDistributionListButton})},
handleComposeStackSelect:function(a){a&&a.id&&a.id!=this.id&&this._onHide();this.testShowConfirmationAd(a)},testShowConfirmationAd:function(a){this.confirmationAdvertisement&&a&&a.id&&(a.id==this.id?this.confirmationAdvertisement.blocked&&this.confirmationAdvertisement.block(!1):this.confirmationAdvertisement.blocked||this.confirmationAdvertisement.block(!0))},addSuggestionToTopContacts:function(){if(this.topContactSuggest){if(!this.addressModel)this.addressModel=new ws.address.AddressModel;this.topContactSuggest.isEmail&&
this.topContactSuggest.email?this.addressModel.addAddressToTopContacts({address:this.topContactSuggest.email,load:e.hitch(this,function(a){a.tcdluid?(this.AddToTopContacts.domNode.style.display="none",this.topContactSuggest=null,ws.WebSuite.theMailModel.resetCachedLists(),e.publish("WSFeedbackStart",[Config.Strings.TopContacts_AddressAdded,!0])):ws.widget.Dialogs.ok(Config.Strings.TopContacts_AddressNotAdded)}),error:e.hitch(this,function(a){window.ws_ErrLgr&&!a&&ws_ErrLgr.logError(ws_ErrLgr.cat.UserVisErr,
"Dialogs.ok shown - Error Handler for addressModel.addAddressToTopContacts-addSuggestionToTopContacts file:SendConfirmationCard.js");ws.widget.Dialogs.ok(a||Config.Strings.TopContacts_AddressNotAdded)})}):!this.topContactSuggest.isEmail&&this.topContactSuggest.uid?this.addressModel.addContactToTopContacts({uid:this.topContactSuggest.uid,load:e.hitch(this,function(a){a.tcdluid?(this.AddToTopContacts.domNode.style.display="none",this.topContactSuggest=null,ws.WebSuite.theMailModel.resetCachedLists(),
e.publish("WSFeedbackStart",[Config.Strings.TopContacts_ContactAdded,!0])):ws.widget.Dialogs.ok(Config.Strings.TopContacts_ContactNotAdded)}),error:e.hitch(this,function(a){window.ws_ErrLgr&&!a&&ws_ErrLgr.logError(ws_ErrLgr.cat.UserVisErr,"Dialogs.ok shown - Error Handler for addressModel.addContactToTopContacts-addSuggestionToTopContacts file:SendConfirmationCard.js");ws.widget.Dialogs.ok(a||Config.Strings.TopContacts_ContactNotAdded)})}):(this.AddToTopContacts.domNode.style.display="none",this.topContactSuggest=
null)}},addNegativeToTopContacts:function(){if(this.topContactSuggest){if(!this.addressModel)this.addressModel=new ws.address.AddressModel;this.topContactSuggest.isEmail&&this.topContactSuggest.email?this.addressModel.addAddressToNegativeTopContacts({address:this.topContactSuggest.email,load:e.hitch(this,function(){this.AddToTopContacts.domNode.style.display="none";this.topContactSuggest=null}),error:e.hitch(this,function(){this.AddToTopContacts.domNode.style.display="none";this.topContactSuggest=
null})}):!this.topContactSuggest.isEmail&&this.topContactSuggest.uid?this.addressModel.addContactToNegativeTopContacts({uid:this.topContactSuggest.uid,load:e.hitch(this,function(){this.AddToTopContacts.domNode.style.display="none";this.topContactSuggest=null}),error:e.hitch(this,function(){this.AddToTopContacts.domNode.style.display="none";this.topContactSuggest=null})}):(this.AddToTopContacts.domNode.style.display="none",this.topContactSuggest=null)}},cancel:function(){this.cancelCB&&this.cancelCB()},
cancelToMessage:function(){this.cancelCB&&this.cancelCB(!0)},onShow:function(){this.inherited(arguments);e.publish("SendConf/show");this._isShowing=!0},_onHide:function(){if(this._isShowing)this._isShowing=!1,e.publish("SendConf/hide"),Config.SendConfPageIsRichContent&&ws.html.recreateIframe(this.fullSendConfirmationPane.domNode,"about:blank"),this.sendConfPages.selectedChildWidget!=this.emptyPage&&this.sendConfPages.selectChild(this.emptyPage)}}));e._hasResource["ws.pictures.PictureEditControl"]||
(e._hasResource["ws.pictures.PictureEditControl"]=!0,e.provide("ws.pictures.PictureEditControl"),e.declare("ws.pictures.PictureEditControl",[k._Widget,k._Templated],{templateString:e.cache("ws.pictures","PictureEditControl.html",'<div class="pictureEditControl" style="display: none;" dojoAttachEvent="onmouseover: onMouseOver, onmouseout: onMouseOutControls">\r\n    <div class="bkgndLayer" dojoAttachPoint="bkgndLayerNode"></div>\r\n\t<div class="buttons" dojoAttachPoint="buttons">\r\n\t\t<a href="#" dojoAttachPoint="optionsBtn" class="mainSprite options" dojoAttachEvent="onclick: showMenu"></a>\r\n\t\t<a href="#" class="mainSprite delete" dojoAttachPoint="deleteButton"></a>\r\n\t</div>\r\n</div>\r\n\r\n'),
css:{templateString:""},editor:null,hoveredImage:null,bkgndLayerNode:null,imageConnections:null,options:[{value:"small",display:Config.Strings.Compose_small,action:"size"},{value:"medium",display:Config.Strings.Compose_medium,action:"size"},{value:"large",display:Config.Strings.Compose_large,action:"size"},{isSeparator:!0},{value:"right",display:Config.Strings.Compose_alignRight,action:"align"},{value:"center",display:Config.Strings.Compose_alignCenter,action:"align"},{value:"left",display:Config.Strings.Compose_alignLeft,
action:"align"},{isSeparator:!0},{value:"none",display:Config.Strings.Compose_noWrap,action:"wrap"},{value:"right",display:Config.Strings.Compose_wrapRight,action:"wrap"},{value:"left",display:Config.Strings.Compose_wrapLeft,action:"wrap"}],startup:function(){this.imageConnections={};this.createMenu();this.connect(this.optionsMenu.menu,"onMouseDown","setSelectedOption");this.connect(this.optionsMenu.menu,"onMouseOut","onMouseOutControls");this.connect(this.buttons,"onmouseout",function(a){a.relatedTarget&&
a.relatedTarget.tagName.toLowerCase()=="iframe"&&this.closeControls()});this.handledImages=[];this.connect(this.deleteButton,"onclick",e.hitch(this,"execCommand","remove"))},closeControls:function(){this.closeMenu();this.domNode.style.display="none";this.bkgndLayerNode.style.display="none";this.hoveredImage=null},setSelectedOption:function(a){if(a.target&&(a=k.getEnclosingWidget(a.target),a.caption))for(var c in this.options)a.caption==this.options[c].display&&this.execCommand(this.options[c].action,
this.options[c].value)},createMenu:function(){if(!this.optionsMenu)this.optionsMenu=new ws.widget.WSSelect({options:this.options}),this.optionsMenu.startup(),this.optionsMenu.getMenu()},openMenu:function(){this.optionsMenu.menu.open(this.optionsBtn)},closeMenu:function(){this.optionsMenu.menu&&this.optionsMenu.menu.close()},removeEventHandlers:function(a,c){var d=this.imageConnections[a];d&&(d[c]?this.disconnect(d[c]):(d.onmouseover&&this.disconnect(d.onmouseover),d.onload&&this.disconnect(d.onload),
delete this.imageConnections[a]))},installEventHandlers:function(){for(var a=this.editor.doc().getElementsByTagName("img"),c=0;c<a.length;c++)if(a[c].id&&a[c].id.indexOf("AOLP")!=-1&&this.editor.imageIdMap[a[c].id]&&e.indexOf(this.handledImages,a[c])==-1)this.imageConnections[a[c].id]=this.imageConnections[a[c].id]||{},this.imageConnections[a[c].id].onmouseover=this.connect(a[c],"onmouseover",e.hitch(this,"onMouseOverImage",a[c])),this.imageConnections[a[c].id].onload=this.connect(a[c],"onload",e.hitch(this,
"onImageLoaded",a[c])),this.handledImages.push(a[c]);this.hoveredImage&&!this.hoveredImage.parentNode&&this.closeControls()},onImageLoaded:function(a){if(a&&(this.removeEventHandlers(a.id,"onload"),this.bkgndLayerNode&&e.style(this.bkgndLayerNode,"display")!="none"))this.onMouseOverImage(a)},onMouseOverImage:function(a){var c=e.contentBox(a).w,d=e.contentBox(a).h,f=e._abs(this.editor.iframe),g=this.editor.doc().body.clientWidth,i=this.editor.doc().body.clientHeight,j=e._abs(a);j.x+=f.x;j.y+=f.y;if(j.x<
f.x)c-=f.x-j.x,j.x=f.x;j.x+c>f.x+g&&(c=f.x+g-j.x);if(j.y<f.y)d-=f.y-j.y,j.y=f.y;j.y+d>f.y+i&&(d=f.y+i-j.y);e.style(this.domNode,{left:j.x+(e.isIE==7?2:0)+"px",top:j.y+(e.isIE==7?2:0)+"px",width:c+"px",display:""});j.y<=f.y+15?(f=f.y+15-j.y,this.buttons.style.top=f<15?f+"px":"15px"):this.buttons.style.top="0px";e.style(this.bkgndLayerNode,{display:"block",width:c+"px",height:d+"px"});this.buttons.style.width=c+"px";this.hoveredImage=a},onMouseOutControls:function(a){a=a?a.relatedTarget:null;if(!a||
!(a==this.deleteButton||a==this.optionsBtn||a==this.buttons||a==this.bkgndLayerNode||e.hasClass(a,"dijitPopup"))){for(;a;){if(a==e.body())break;if(e.hasClass(a,"wsMenu"))return;a=a.parentNode}this.closeControls()}},onMouseOver:function(){this.domNode.style.display=""},showMenu:function(){this.updateMenuState(this.hoveredImage);this.openMenu()},execCommand:function(a,c){this.bkgndLayerNode.style.display="none";this.domNode.style.display="none";var d=this.hoveredImage;switch(a){case "size":this.setSize(d,
c);break;case "align":this.setAlign(d,c);break;case "wrap":this.setWrap(d,c);break;case "remove":this.removeImage(d)}},sizes:{small:Config.InsertedPictureLongestEdge,medium:600,large:1200},setSize:function(a,c){var d=this.editor.imageIdMap[a.id];if(c=="small")a.src=d.smallUrl;else if(c=="medium")a.src=d.mediumUrl;else if(c=="large")a.src=d.largeUrl;a.width=this.sizes[c];a.style.height="";a.style.width=""},setAlign:function(a,c){var d=this.envelopImage(a);d.align=c;ws.html.setFloat(d,"none")},setWrap:function(a,
c){var d={left:"right",right:"left",none:"none"}[c],e=this.envelopImage(a);ws.html.setFloat(e,d);if(c=="none")e.align="left"},removeImage:function(a){this.removeEventHandlers(a.id);a.parentNode.removeChild(a);e.isMoz&&this.editor.insertHTML("<span></span>");this.installEventHandlers();e.publish("InlineImageRemoved")},envelopImage:function(a){var c=this.getEnvelope(a);if(c)return c;c=this.editor.doc().createElement("div");c.className="envelope";var d=a.cloneNode(!1);c.appendChild(d);a.parentNode.replaceChild(c,
a);return c},getEnvelope:function(a){return(a=a.parentNode)&&a.className=="envelope"&&a.childNodes.length==1?a:null},updateMenuState:function(a){var c=this.getEnvelope(a),a=e.contentBox(a),d=c?c.align:"left",c=c?ws.html.getFloat(c):"none",f=c!="left"&&c!="right",a={sizesmall:a.w==this.sizes.small,sizemedium:a.w==this.sizes.medium,sizelarge:a.w==this.sizes.large,alignleft:f&&(d=="left"||d==""),aligncenter:f&&d=="center",alignright:f&&d=="right",wrapright:c=="left",wrapleft:c=="right",wrapnone:f};this.optionsMenu.menu||
this.createMenu();d=this.optionsMenu.menu.getChildren();for(c=0;c<d.length;c++)d[c].isSeparator||d[c].setChecked(a[this.options[c].action+this.options[c].value])}}));e._hasResource["ws.widget.SmileyPalette"]||(e._hasResource["ws.widget.SmileyPalette"]=!0,e.provide("ws.widget.SmileyPalette"),e.declare("ws.widget.SmileyPalette",[k._Widget,k._Templated],{templateString:"<div class='wsMenu' style='width:103px;height:89px;overflow:hidden;background: #fff url(${images}smileyPalette.png)!important;cursor:pointer;display:none' dojoAttachEvent='onmousedown:onClick'></div>",
imageNames:[["smile","wink","kiss","bigkiss"],["cry","frown","indecision","shame"],["grin","greed","shock","yell"],["cool","foot","halo","tongue"]],altTexts:[[":-)",";-)",":-*",":-X"],[":'(",":-(",":-\\",":-["],[":-D",":-$","=-O",">:O"],["8-)",":-!","O:-)",":-P"]],onClick:function(a){var c=e._abs(this.domNode),d=Math.floor((a.pageY-c.y)/this.smileyHeight),f=Math.floor((a.pageX-c.x)/this.smileyWidth);d>3&&(d=3);f>3&&(f=3);c=this.altTexts[d][f];d=Config.SmileyImageURL+this.imageNames[d][f]+Config.SmileyImageExt;
e.stopEvent(a);this.onSmileyClicked(c,d)},smileyHeight:25,smileyWidth:25,onSmileyClicked:function(){}}));e._hasResource["ws.widget.ColorPalette"]||(e._hasResource["ws.widget.ColorPalette"]=!0,e.provide("ws.widget.ColorPalette"),e.declare("ws.widget.ColorPalette",[k._Widget,k._Templated],{templateString:"<div class='wsMenu' style='width:206px;height:130px;overflow:hidden;background: #fff url(${baseimages}common/colors7x10.png)!important;cursor:pointer;display:none' dojoAttachEvent='onclick:onClick'></div>",
colorNames:[["white","seashell","cornsilk","lemonchiffon","lightyellow","palegreen","paleturquoise","lightcyan","lavender","plum"],["lightgrey","pink","bisque","moccasin","khaki","lightgreen","lightseagreen","lightskyblue","cornflowerblue","violet"],["silver","lightcoral","sandybrown","orange","palegoldenrod","chartreuse","mediumturquoise","skyblue","mediumslateblue","orchid"],["gray","red","orangered","darkorange","yellow","limegreen","darkseagreen","royalblue","slateblue","mediumorchid"],["dimgray",
"crimson","chocolate","coral","gold","forestgreen","seagreen","blue","blueviolet","darkorchid"],["darkslategray","firebrick","saddlebrown","sienna","olive","green","darkcyan","mediumblue","darkslateblue","darkmagenta"],["black","darkred","maroon","brown","darkolivegreen","darkgreen","midnightblue","navy","indigo","purple"]],onClick:function(a){var c=e._abs(this.domNode),d=Math.floor((a.pageY-c.y)/this.colorHeight),a=Math.floor((a.pageX-c.x)/this.colorWidth);d>6&&(d=6);a>9&&(a=9);this.onPaletteClicked(this.colorNames[d][a]);
ws.widget.popup.close(this)},colorHeight:20,colorWidth:20,onPaletteClicked:function(){}}));e._hasResource["ws.widget.LinkEditor"]||(e._hasResource["ws.widget.LinkEditor"]=!0,e.provide("ws.widget.LinkEditor"),e.declare("ws.widget.LinkEditor",[k._Widget,k._Templated],{templateString:e.cache("ws.widget","LinkEditor.html",'<div class="wsMenu" style="background:#fff;width:290px;padding:8px 5px">\r\n  <img src="${spacer}" class="mainSprite wsCloseBtn" dojoAttachEvent="onclick: handleCloseX">\r\n  <div class="contentDiv" dojoAttachPoint="contentDiv">\r\n\t<table dojoAttachPoint="inputTable">\r\n\t  <tbody>\r\n\t\t<tr>\r\n\t\t  <td>${LinkText}</td>\r\n\t\t</tr>\r\n\t\t<tr>\r\n\t\t  <td><div dojoType="ws.widget.DefaultTextbox" maxlength="255" fieldWidth="250px" dojoAttachPoint="linkText" tabindex="232"></div></td>\r\n\t\t</tr>\r\n\t\t<tr>\r\n\t\t  <td>${LinkTo}:&nbsp;<br style="display:none">\r\n\t\t\t<input name="scheme" value="${WebSite}" tabindex="233" type="radio" checked>&nbsp;${WebSite}\r\n\t\t\t<input name="scheme" value="${EmailAddress}" tabindex="234" type="radio">&nbsp;${EmailAddress}\r\n\t\t  </td>\r\n\t  </tr>\r\n\t\t<tr>\r\n\t\t  <td><div dojoType="ws.widget.DefaultTextbox" maxlength="1024" fieldWidth="250px" dojoAttachPoint="link" tabindex="235"></div></td>\r\n\t\t</tr>\r\n\t\t<tr>\r\n\t\t  <td style="margin-top:2px"><div dojoType="ws.widget.Button" toolbarPosition="right" style="float: right;" tabindex="236" dojoAttachPoint="okButton">${OK}</div></td>\r\n\t\t</tr>\r\n\t  </tbody>\r\n\t</table>\r\n  </div>\r\n</div>\r\n\r\n'),
widgetsInTemplate:!0,_earlyTemplatedStartup:!0,callbackFunc:null,startup:function(a){this.bookmark=a;e.toggleClass(this.linkText.textbox,"wsInputDefault",!1);this.linkText.textbox.style.paddingLeft="2px";this.linkText._updateClass=function(){};this.linkText._onFocus=function(){};e.toggleClass(this.link.textbox,"wsInputDefault",!1);this.link.textbox.style.paddingLeft="2px";this.link._updateClass=function(){};this.link._onFocus=function(){}},show:function(a,c){this.destroyOnClose=!0;this.editorWindow=
a;e.isWebKit&&a.focus();this.editorDoc=a.document;this.selection=e.isIE?this.editorDoc.selection:this.editorWindow.getSelection();this.range=this.createRange();this.schemes=e.query('[name="scheme"]',this.domNode);this.schemes.every(e.hitch(this,function(a){e.connect(a,"onclick",e.hitch(this,"schemeChosen"));return!0}));this.url=this.email="";var d=null,d=e.isIE?this.selection.type=="Control"?"":this.range.text:this.range.toString();this.linkText.textbox.value=d;this.currentScheme=0;var f=this.findAnchorNode();
if(f){this.link.textbox.value=f.href;if(f.href.match(/mailto:/i)&&this.schemes)this.schemes[1].checked=!0,this.currentScheme=1;if(d=="")this.linkText.textbox.value=e.isIE?f.innerText:f.textContent}ws.widget.popup({popup:this,around:c,padding:[0,0]});(Config.PageLocale=="fi-fi"||Config.PageLocale=="ru-ru")&&e.query("br",this.domNode).style("display","block");d?this.link.textbox.focus():this.linkText.textbox.focus();this.link.connect(this.link,"onKeyPress",e.hitch(this,"keyPressed",f));this.okButton.connect(this.okButton.domNode,
"ondijitclick",e.hitch(this,"createOrCancelLink",f,1));e.publish("popup/open",[])},schemeChosen:function(){if(this.schemes[0].checked){if(this.currentScheme==1)this.currentScheme=0,this.email=this.link.textbox.value,this.link.textbox.value="",this.link.textbox.value=this.url}else if(this.currentScheme==0)this.currentScheme=1,this.url=this.link.textbox.value,this.link.textbox.value="",this.link.textbox.value=this.email;this.link.textbox.focus()},keyPressed:function(a,c){c.keyCode==13&&this.createOrCancelLink(a,
1)},onClose:function(){this.destroyRecursive()},close:function(a){ws.widget.popup.close(this);this.callbackFunc&&this.callbackFunc(a)},handleCloseX:function(){e.isIE&&this.range&&this.range.select();this.close(!0)},createOrCancelLink:function(a,c){switch(c){case 1:var d=this.link.textbox.value;if(d==""){this.createOrCancelLink(a,2);this.close();break}!this.schemes||this.schemes[0].checked?d.match(/^http:/i)||(d="http://"+d):d.match(/^mailto:/i)||(d="mailto:"+d);if(a)a.href=d;var f=this.linkText.textbox.value;
f==""&&this.selection.type!="Control"&&(f=d,f.match(/^mailto:/)&&(f=f.replace(/^mailto:/,"")));if(e.isIE){if(this.editorWindow.lastSelType=="Control")this.range.execCommand("createlink",!1,d);else if(f!="")if(this.range.text==f)this.range.execCommand("createlink",!1,d);else if(this.range.text)a?a.innerHTML=f:(this.range.text=f,this.range.moveStart("character",-f.length),this.range.select(),this.range.execCommand("createlink",!1,d),this.range.collapse(!1),this.range.select());else{if(!this.editorWindow.lastSelRange)this.bookmark?
(this.range=this.editorDoc.body.createTextRange(),this.range.moveToBookmark(this.bookmark)):(this.editorWindow.focus(),this.range=this.editorDoc.selection.createRange());this.range.text=f;this.range.moveStart("character",-f.length);this.range.select();this.range.execCommand("createlink",!1,d)}this.editorWindow.lastSelType!="Control"&&(this.range.collapse(!1),this.range.select())}else f==this.range.toString()?a||(this.editorDoc.execCommand("createlink",!1,d),this.selection.collapseToEnd()):a?a.innerHTML=
f:(a=this.editorWindow.document.createElement("a"),a.href=d,this.range.deleteContents(),d=this.editorDoc.createTextNode(f),a.appendChild(d),this.range.insertNode(a)),a&&this.selection.selectAllChildren(a),this.selection.collapseToEnd(),this.range.detach(),this.editorDoc.execCommand("unlink",!1,null);this.close();break;case 2:if(a)if(e.isIE)this.range.select(),this.editorDoc.execCommand("unlink"),this.editorDoc.execCommand("unselect"),this.selection.type!="Control"&&(this.range.collapse(!1),this.range.select());
else try{for(var d=a.childNodes.length,f=a.parentNode,g=0;g<d;g++)f.insertBefore(a.firstChild,a);f.removeChild(a)}catch(i){}}},createRange:function(){if(!this.selection)return null;var a;if(e.isIE)a=this.editorWindow.lastSelRange?this.editorWindow.lastSelRange:this.selection.createRange();else try{a=this.selection.getRangeAt(0)}catch(c){a=this.editorDoc.createRange()}return a},findAnchorNode:function(){var a=null;if(e.isIE)if(this.editorWindow.lastSelType=="None"){if(a=this.detectAnchorAtPoint())this.range.moveToElementText(a),
this.range.select()}else if(this.editorWindow.lastSelType=="Control")a=this.editorWindow.lastSelNode.parentNode,a.href||(a=null);else{if(this.editorWindow.lastSelType=="Text"){var c=this.range.htmlText.match(/href="(.+?)"/i);c&&c.length>1&&this.range.findText(this.range.text,0,0);this.range.collapse(!0);a=this.detectAnchorAtPoint();if(!a)this.range=this.selection.createRange(),this.range.collapse(!1),a=this.detectAnchorAtPoint();this.range=this.selection.createRange()}}else{var c=this.editorDoc.body,
d=this.range.startContainer;do if(d.nodeName.toLowerCase()=="a"){a=d;break}while(d!=c&&(d=d.parentNode));if(!a&&!this.range.collapsed){d=this.range.endContainer;do if(d.nodeName.toLowerCase()=="a"){a=d;break}while(d!=c&&(d=d.parentNode))}!a&&!this.range.collapsed&&this.range.commonAncestorContainer.childNodes.length>0&&e.query("a",this.range.commonAncestorContainer).every(e.hitch(this,function(c){if(this.selection.containsNode(c,!0))return a=c,!1;return!0}))}return a},detectAnchorAtPoint:function(){var a=
null;this.range.pasteHTML('<span id="le:tmp.id"></span>');var c=e.byId("le:tmp.id",this.editorDoc);if(c){a=c.parentNode;for(c.parentNode.removeChild(c);a&&a.tagName.toLowerCase()!="a";)a=a.tagName.toLowerCase()=="body"?null:a.parentNode}return a}}));if(!e._hasResource["ws.mail.funmail"]){e._hasResource["ws.mail.funmail"]=!0;e.provide("ws.mail.funmail");var l=function(){this.init()};l.prototype.init=function(){this._type=this._document=null;this._xmlHttp=new XmlHttp;this._savedContentMap=null};l.prototype.setDocument=
function(a){this._document=a};l.prototype.setStationery=function(a){this._xmlHttp.fetchAsynchronous(a,this.createDelegate(this,this.stationeryHandler))};l.prototype.setPostcard=function(a){this._xmlHttp.fetchAsynchronous(a,this.createDelegate(this,this.postcardHandler))};l.prototype.setPhotoAlbum=function(a){this._xmlHttp.fetchAsynchronous(a,this.createDelegate(this,this.photoAlbumHandler))};l.prototype.getFinalizedDocument=function(){var a=null;this._document&&(a=this._document.cloneNode(!0))&&this.finalizeNode(a.body);
return a};l.prototype.finalizeNode=function(a){if(a){var c=a.id;if(c&&(c=c.toLowerCase(),c.search(/^role_/)==0||c.search(/^rolx_/)==0))a.removeAttribute("contentEditable"),a.removeAttribute("id"),this.isContentVolatile(a)&&(a.removeAttribute("comp_state"),a.removeAttribute("comp_original_text"));for(c=0;c<a.childNodes.length;c++){var d=a.childNodes[c];d&&this.finalizeNode(d)}}};l.prototype.createDelegate=function(a,c){return function(){return c.apply(a,arguments)}};l.prototype.cleanupRoleAttributes=
function(a){try{a.removeAttribute("comp_role")}catch(c){}for(var d=0;d<a.childNodes.length;d++){var e=a.childNodes[d];e&&this.cleanupRoleAttributes(e)}};l.prototype.loadTemplateForDocument=function(a,c,d){if(a&&(a=a.body,this.loadTemplateForNode(a,d),c==1)){this.cleanupRoleAttributes(a);for(var e in d){var c=d[e],a=c.getAttribute("contentEditable"),g=this.innerText(c);a!=null&&a.toLowerCase()=="true"&&g!=""&&(c.setAttribute("comp_state","volatile"),c.setAttribute("comp_original_text",g))}}};l.prototype.loadTemplateForNode=
function(a,c){if(a&&!(a.nodeType==3||a.nodeType==8)){var d=a.getAttribute("comp_role"),e=null;if(d)e="role_"+d,a.id=e,a.removeAttribute("comp_role");if(e!="role_ornament")if(e&&e!="role_layout")c[e]=a;else for(d=0;d<a.childNodes.length;d++)(e=a.childNodes[d])&&this.loadTemplateForNode(e,c)}};l.prototype.stationeryHandler=function(a){this.applyTemplate(a,0)};l.prototype.postcardHandler=function(a){this.applyTemplate(a,1)};l.prototype.saveContentForNode=function(a,c){if(a){var d=a.id?a.id.toLowerCase():
"";if(d.search(/^role_/)!=-1)if(d=="role_ornament"||d=="role_document"||d=="role_title")return;else if(d!="role_layout"&&d!="role_document"){var e=a.innerHTML;e&&this.isContentVolatile(a)&&!this.isContentModified(a)&&(e="<DIV>&nbsp;</DIV>");c[d]=e;return}for(d=0;d<a.childNodes.length;d++)(e=a.childNodes[d])&&this.saveContentForNode(e,c)}};l.prototype.saveContentForDocument=function(a,c){if(a){this.saveContentForNode(a.body,c);var d=!1;for(key in c){d=!0;break}if(!d)c.role_body=a.body.innerHTML}};
l.prototype.applyTemplate=function(a,c){this._savedContentMap=[];this.saveContentForDocument(this._document,this._savedContentMap);if(a)a=a.replace(/(\r|\n)/g,""),a=a.replace(/.*<body[^>]*>/i,""),a=a.replace(/<\/body>.*/i,""),this._document.body.innerHTML=a;this._document.body.setAttribute("contentEditable","false");this._document.body.setAttribute("unselectable","on");var d=[];this.loadTemplateForDocument(this._document,c,d);if(typeof d.role_body!="undefined")d.role_body.innerHTML=c!=1?"<DIV>&nbsp;</DIV>":
"",this.moveContent(this._savedContentMap,d),d=e.isIE?400:0,ws.lang.setTimeout(e.hitch(this,function(){this.moveCursorToBodyRole(this._document);if(e.isIE)this._document.body.scrollTop=0}),d)};l.prototype.moveContent=function(a,c){for(toElementId in c)if(!(toElementId=="role_ornament"||toElementId=="role_layout")&&typeof a[toElementId]!="undefined"&&a[toElementId]!=""){var d=c[toElementId].innerHTML;c[toElementId].innerHTML=a[toElementId];this.isWhitespace(this.innerText(c[toElementId]))&&c[toElementId].getElementsByTagName("img").length==
0?c[toElementId].innerHTML=d:(c[toElementId].removeAttribute("comp_state"),c[toElementId].removeAttribute("comp_original_text"))}};l.prototype.moveCursorToBodyRole=function(a,c,d){if(a){var c=!!c,e=a.getElementById("role_body");if(e)if(typeof window!="undefined"&&window.getSelection)e.focus(),this.isContentVolatile(e)&&!this.isWhitespace(this.innerText(e))?(d=a.defaultView?a.defaultView.getSelection():a.parentWindow.getSelection(),a=a.createRange(),a.selectNodeContents(e),d.removeAllRanges(),d.addRange(a)):
(d=a.defaultView?a.defaultView.getSelection():a.parentWindow.getSelection(),d.collapseToStart());else{c||a.selection.empty();a=a.body.createTextRange();a.moveToElementText(e);d?a.collapse(!1):this.isContentVolatile(e)&&!this.isWhitespace(this.innerText(e))?a.select():a.collapse(!0);try{e.focus()}catch(g){if(e.childNodes.length>0)try{e.childNodes[0].focus()}catch(i){}}}}};l.prototype.isContentVolatile=function(a){if(!a)return!1;return a.getAttribute("comp_state")=="volatile"};l.prototype.isContentModified=
function(a){if(!a)return!0;var c=a.getAttribute("comp_original_text");return this.innerText(a)!=c};l.prototype.isWhitespace=function(a){return a.search(/^(\s|\xA0)*$/)==0};l.prototype.cleanupDocument=function(){};l.prototype.innerText=function(a){return typeof a.innerHTML!="undefined"?a.innerHTML:null};e.declare("ws.mail.funmail",[l],{init:function(){this._savedContentMap=this._type=this._document=null},loadTemplateForNode:function(){this.inherited(arguments);e.query("div",this._document.body).forEach(function(a){a.style.outline=
"none"})},finalizeTemplate:function(){this.finalizeNode(this._document.body)}})}e._hasResource["ws.widget.LayoutContainer"]||(e._hasResource["ws.widget.LayoutContainer"]=!0,e.provide("ws.widget.LayoutContainer"),e.declare("ws.widget.LayoutContainer",k.layout.LayoutContainer,{layout:function(){this.layoutChildren(this.domNode,this._contentBox,this.getChildren())},capitalize:function(a){return a.substring(0,1).toUpperCase()+a.substring(1)},size:function(a,c){a.resize?a.resize(c):e.marginBox(a.domNode,
c);e.mixin(a,e.marginBox(a.domNode));e.mixin(a,c)},layoutChildren:function(a,c,d,f,g){c=e.mixin({},c);e.addClass(a,"dijitLayoutContainer");d=e.filter(d,function(a){return a.region!="center"&&a.layoutAlign!="client"}).concat(e.filter(d,function(a){return a.region=="center"||a.layoutAlign=="client"}));e.forEach(d,function(a){var d=a.domNode,h=a.region||a.layoutAlign,m=d.style,p=0;a.domNode.getAttribute("offsetY")&&!isNaN(a.domNode.getAttribute("offsetY"))&&(p=parseInt(a.domNode.getAttribute("offsetY")));
c.t+=p;c.h-=p;m.left=c.l+"px";m.top=c.t+"px";m.bottom=m.right="auto";e.addClass(d,"dijitAlign"+this.capitalize(h));d={};f&&f==a.id&&(d[a.region=="top"||a.region=="bottom"?"h":"w"]=g);h=="top"||h=="bottom"?(d.w=c.w,this.size(a,d),c.h-=a.h,h=="top"?c.t+=a.h:m.top=c.t+c.h+"px"):h=="left"||h=="right"?(d.h=c.h,this.size(a,d),c.w-=a.w,h=="left"?c.l+=a.w:m.left=c.l+c.w+"px"):(h=="client"||h=="center")&&this.size(a,c)},this)}}));if(!e._hasResource["ws.widget.WSEditor"])e._hasResource["ws.widget.WSEditor"]=
!0,e.provide("ws.widget.WSEditor"),ws.widget.fontOptions=[{value:"Arial, Helvetica, sans-serif",display:'<b style="font-weight: normal; font-family: Arial,Helvetica,sans-serif">Arial</b>',selected:!0,checked:!0},{value:"Comic Sans MS, sans-serif",display:'<b style="font-weight: normal; font-family: Comic Sans MS, sans-serif">Comic Sans MS</b>'},{value:"Courier New, Courier, mono",display:'<b style="font-weight: normal; font-family: Courier New, Courier, mono">Courier New</b>'},{value:"Georgia, Times New Roman, Times, Serif",
display:'<b style="font-weight: normal; font-family: Georgia, Times New Roman, Times, Serif">Georgia</b>'},{value:"impact, sans-serif",display:'<b style="font-weight: normal; font-family: impact, sans-serif">Impact</b>'},{value:"Tahoma, Arial, Helvetica, sans-serif",display:'<b style="font-weight: normal; font-family: Tahoma, Arial, Helvetica, sans-serif">Tahoma</b>'},{value:"Times New Roman, Times, serif",display:'<b style="font-weight: normal; font-family: Times New Roman, Times, serif">Times New Roman</b>'},
{value:"Verdana, Arial, Helvetica, sans-serif",display:'<b style="font-weight: normal; font-family: Verdana, Arial, Helvetica, sans-serif">Verdana</b>'},{value:"WingDings",display:'<b style="font-weight: normal;">WingDings</b>'}],e.isFF>=3&&ws.widget.fontOptions.splice(ws.widget.fontOptions.length-1,1),ws.widget.fontSizePicker=[{value:"1",display:"<span style='font-size:8pt;'>8 pt</span>",safari:"10px",other:"8pt"},{value:"2",display:"<span style='font-size:10pt;'>10 pt</span>",safari:"13px",other:"10pt",
selected:!0,checked:!0},{value:"3",display:"<span style='font-size:12pt;'>12 pt</span>",safari:"16px",other:"12pt"},{value:"4",display:"<span style='font-size:14pt;'>14 pt</span>",safari:"18px",other:"14pt"},{value:"5",display:"<span style='font-size:18pt;'>18 pt</span>",safari:"24px",other:"18pt"},{value:"6",display:"<span style='font-size:24pt;'>24 pt</span>",safari:"32px",other:"24pt"},{value:"7",display:"<span style='font-size:36pt;'>36 pt</span>",safari:"48px",other:"36pt"}],e.declare("ws.widget.WSEditor",
[k._Widget,k._Templated],{templateString:e.cache("ws.widget","WSEditor.html",'<div style="height:100%;width:100%;">\r\n<div class="wsEditor" dojoType="ws.widget.LayoutContainer" dojoAttachPoint="layoutWidget">\r\n    <div dojoType="ws.widget.Pane" dojoAttachPoint="toolbarPaneParent" layoutAlign="top" class="toolbarContainer">\r\n        <div class="toolbar" dojoAttachPoint="toolbarPane">\r\n            <\!-- we need to use &nbsp; as innerHTML for the anchor tags otherwise, IE8/7 will show the text overlayed on top of the icons. Using transparent css color\r\n            for the text does not work neither --\>\r\n            <a href="#" class="attachBtn" dojoAttachPoint="attachButton" title="${ChooseFileTooltip}" dojoAttachEvent="onClick: openAttachFileDialog"></a>\r\n            <\!-- Insert Pictures button is dynamically inserted here, by PictureEditor.js --\>\r\n            <a href="#" class="wsLink enableRTE" dojoAttachPoint="richTextButton" title="${Basic_SwitchToRichEditor}" dojoAttachEvent="onclick: enableRichText"><span class="wsLink">${Basic_SwitchToRichEditor}</span></a>\r\n            <a href="#" dojoType="ws.widget.WSSelect" dojoAttachPoint="fontPicker" disableMouseStates="true" title="${FontType}" className="fontfamilyIcon" >&nbsp;</a>\r\n            <a href="#" dojoType="ws.widget.WSSelect" dojoAttachPoint="fontSizePicker" disableMouseStates="true" title="${FontSize}" className="fontsizeIcon" >&nbsp;</a>\r\n            <a href="#" dojoAttachPoint="boldItem" title="${Bold}" dojoAttachEvent="onclick: boldClick" class="boldIcon">&nbsp;</a>\r\n            <a href="#" dojoAttachPoint="italicItem" title="${Italic}" dojoAttachEvent="onclick: italicClick" class="italicIcon">&nbsp;</a>\r\n            <a href="#" dojoAttachPoint="underlineItem" title="${Underline}" dojoAttachEvent="onclick: underlineClick" class="underlineIcon">&nbsp;</a>\r\n            <a href="#" dojoAttachPoint="forecolorItem" title="${FontColor}" dojoAttachEvent="onclick: fontColorClick" class="forecolorIcon" dojoAttachPoint="forecolorButton">&nbsp;</a>\r\n            <a href="#" dojoAttachPoint="hilitecolorItem" title="${BackgroundColor}" dojoAttachEvent="onclick: backgroundColorClick" class="hilitecolorIcon">&nbsp;</a>\r\n            <a href="#" dojoType="ws.widget.WSSelect" dojoAttachPoint="justifyPicker" disableMouseStates="true" title="${Alignment}" className="justifyIcon" >&nbsp;</a>\r\n            <a href="#" dojoType="ws.widget.WSSelect" dojoAttachPoint="listPicker" disableMouseStates="true" title="${Lists}" className="insertListIcon" >&nbsp;</a>\r\n            <a href="#" dojoType="ws.widget.WSSelect" dojoAttachPoint="indentPicker" disableMouseStates="true" title="${Indentation}" className="indentPickerIcon" >&nbsp;</a>\r\n            <a href="#" title="${HorizontalRule}" dojoAttachEvent="onclick: horizontalRuleClick" class="insertHorizontalRuleIcon">&nbsp;</a>\r\n            <a href="#" title="${InsertSmiley}" dojoAttachEvent="onclick: smileyClick" class="smileyIcon" dojoAttachPoint="smileyButton">&nbsp;</a>\r\n            <a href="#" title="${InsertLink}" dojoAttachEvent="onclick: linkClick" class="linkIcon" dojoAttachPoint="linkButton">&nbsp;</a>\r\n            <\!-- Stationery button is dynamically inserted here, by WSEditor.js --\>\r\n            <a href="#" dojoAttachPoint="htmlmodeItem" title="${ViewHTMLSource}" dojoAttachEvent="onclick: htmlModeClick" class="htmlmodeIcon">&nbsp;</a>\r\n        </div>\r\n    </div>\r\n\t<div class="wsInput iframePane" dojoType="ws.widget.Pane" layoutAlign="client" dojoAttachPoint="iframePane">\r\n\t\t<iframe border="none" frameBorder="0" dojoAttachPoint="iframe" width="100%" height="100%" src="about:blank" tabindex="${tabindex}" name="${id}_body" allowtransparency="true" dojoAttachEvent="onload: onIframeLoaded"></iframe>\r\n\t</div>\r\n\t<div class="wsInput textareaPane" dojoType="ws.widget.Pane" layoutAlign="client" dojoAttachPoint="textareaPane" style="display: none; overflow: hidden;">\r\n\t\t<textarea class="wsInputBare" dojoAttachPoint="textarea" tabindex="105"></textarea>\r\n\t</div>\r\n</div>\r\n</div>\r\n'),
css:{templateString:""},bodyCss:{templateString:e.cache("ws.widget","WSEditorDocument.css",'html, body {padding: 0 0 0 0; margin: 0; border: none; background-color: transparent; font-family: Helvetica,Arial,sans-serif; font-size: 10pt;}body {padding: 15px 15px 15px 15px;}p {margin: 0; padding: 0;}a.spell {padding-bottom: 2px; background: yellow url("${images}bg_spellingErr.gif") bottom left repeat-x; color: #000; text-decoration: none; cursor: pointer;}a.spell:hover {color: #b00;}img.wsThumbnail {display: none;}img.wsPlaceholder {background: #F4F4F4 url("${baseimages}common/progressAnimation_lg.gif") center center no-repeat; border: 1px solid #DADAD6 !important;}.AOLPicturesFullSizeLink {height: 1px; width: 1px; overflow: hidden;}\r\n')},
widgetsInTemplate:!0,_earlyTemplatedStartup:!0,rng:null,currentCommand:null,htmlMode:!1,isStationeryMode:!1,showAttachFile:!1,showRichTextButton:!0,blankLine:"",tabindex:500,doForceRichMode:!1,addNewLinesToRichContent:!0,addDefaultFontStyles:!0,auxDirty:!1,fontPicker:null,fontSizePicker:null,justifyPicker:null,listPicker:null,indentPicker:null,startup:function(){if(!this._started){this._started=!0;this.connect(this.fontPicker,"valueChanged","changeFont");this.connect(this.fontPicker.domNode,"onmousedown",
"setRange");this.connect(this.fontSizePicker,"valueChanged","changeFontSize");this.connect(this.fontSizePicker.domNode,"onmousedown","setRange");this.connect(this.justifyPicker,"valueChanged","changeJustify");this.connect(this.justifyPicker.domNode,"onmousedown","setRange");this.connect(this.listPicker,"valueChanged","changeList");this.connect(this.listPicker.domNode,"onmousedown","setRange");this.connect(this.indentPicker,"valueChanged","changeIndent");this.connect(this.indentPicker.domNode,"onmousedown",
"setRange");this.connect(this.textarea,"onfocus","onFocusHandler");if(!this.showAttachFile||!Config.HasLocalFileSystem)this.attachButton.style.display="none";this.richTextButton.style.display="none";if(!Config.ShowRichTextHtml)this.htmlmodeItem.style.display="none";this.fontPicker.setOptions(ws.widget.fontOptions);if(typeof Settings.ComposeFont!="undefined")for(var a=0;a<this.fontPicker.options.length;a++)if(this.compareFontFamilyStr(this.fontPicker.options[a].value,Settings.ComposeFont)){for(var c=
0;c<this.fontPicker.options.length;c++)this.fontPicker.options[c].checked=!1;this.fontPicker.options[a].checked=!0;break}this.fontSizePicker.setOptions(ws.widget.fontSizePicker);if(typeof Settings.ComposeFontSize!="undefined")for(a=0;a<this.fontSizePicker.options.length;a++)if(this.fontSizePicker.options[a].value==Settings.ComposeFontSize){for(c=0;c<this.fontSizePicker.options.length;c++)this.fontSizePicker.options[c].checked=!1;this.fontSizePicker.options[a].checked=!0;break}this.justifyPicker.setOptions([{value:"justifyleft",
display:'<div class="iconMenuItem"><img src="'+Config.SpacerImageURL+'" class="justifyleftIcon"><span>'+Config.Strings.JustifyLeft+"</span></div>",selected:!0,checked:!0},{value:"justifycenter",display:'<div class="iconMenuItem"><img src="'+Config.SpacerImageURL+'" class="justifycenterIcon"><span>'+Config.Strings.JustifyCenter+"</span></div>"},{value:"justifyright",display:'<div class="iconMenuItem"><img src="'+Config.SpacerImageURL+'" class="justifyrightIcon"><span>'+Config.Strings.JustifyRight+
"</span></div>"}]);this.connect(this.justifyPicker,"createMenu",function(){e.addClass(this.justifyPicker.menu.domNode,"iconMenu");e.toggleClass(this.justifyPicker.domNode,"activated",!0)});this.listPicker.setOptions([{value:"insertorderedlist",display:'<div class="iconMenuItem"><img src="'+Config.SpacerImageURL+'" class="insertorderedlistIcon"><span>'+Config.Strings.OrderedList+"</span></div>"},{value:"insertunorderedlist",display:'<div class="iconMenuItem"><img src="'+Config.SpacerImageURL+'" class="insertunorderedlistIcon"><span>'+
Config.Strings.BulletedList+"</span></div>"}]);this.connect(this.listPicker,"createMenu",function(){e.addClass(this.listPicker.menu.domNode,"iconMenu")});this.indentPicker.setOptions([{value:"outdent",display:'<div class="iconMenuItem"><img src="'+Config.SpacerImageURL+'" class="indentIcon"><span>'+Config.Strings.DecreaseIndent+"</span></div>"},{value:"indent",display:'<div class="iconMenuItem"><img src="'+Config.SpacerImageURL+'" class="outdentIcon"><span>'+Config.Strings.IncreaseIndent+"</span></div>"}]);
this.resizeToolBar()}},resizeToolBar:function(a){if(e.isIE==7&&(this.richMode||a)){a=e.query(">*",this.toolbarPane);this.toolbarPane.style.visibility="hidden";var c=[],d=[];a.forEach(function(a){e.hasClass(a,"rttLabel")?a.style.display!="none"&&d.push(a):a.style.display!="none"&&c.push(a)});for(var a=c.length*32+c.length*2,f=0,g=0,g=0;g<d.length;g++)f+=e.coords(d[g]).w+2;this.toolbarPane.style.width=a+f-1+"px";this.toolbarPane.style.visibility="visible";this.toolbarPane.style.display="none";this.toolbarPane.style.display=
""}},setAuxDirty:function(a){this.auxDirty=a},isAuxDirty:function(){return this.auxDirty},fixWebKitContentInit:function(){if(e.isWebKit){this.doc().body&&!this.doc().body.firstChild&&this.doc().body.appendChild(document.createTextNode(""));var a=this.doc().createRange();a.selectNode(this.doc().body.firstChild);a.collapse(!0);var c=this.win().getSelection();c.removeAllRanges();c.addRange(a)}},setContent:function(a,c,d,f,g,i){this.updateMode();if(this.richMode)if(this.designModeEnabled){this.doc().body.innerHTML=
a;this.fixWebKitContentInit();if(!e.isIE)this.doc().designMode="off",this.doc().designMode="on";this.updateToolbar(null,!0);(!i||i&&!this.isStationeryMode)&&this.fixEditorForStationery();c&&c()}else this.enableDesignMode(a,c);else this.textarea.value=f?a:d?a:ws.html.getText(a),c&&c();this.win().lastSelType=null;this.win().lastSelRange=null;this.ieEditorBookmark=this.win().lastSelNode=null;this.setAuxDirty(!1)},_setup:function(){},getStationeryDefaults:function(){var a=Settings.StationeryDefaults;
if(a&&!e.isObject(a))Settings.StationeryDefaults=e.fromJson(a);return Settings.StationeryDefaults?Settings.StationeryDefaults:null},hasStationeryDefaults:function(){var a=Settings.StationeryDefaults;return a&&a.pluginId&&a.name},enableDesignMode:function(a,c){var d=e.hitch(this,function(){this._enableDesignMode(a);c&&c()});e.isIE||this.iframe._loaded?ws.lang.setTimeout(d,10):this.iframe.onload=d},_enableDesignMode:function(a){var c=this.win(),d=this.doc();try{d.body.innerHTML=a,this.bodyCss.templateString?
e.withGlobal(c,"insertCssText",ws.widget,[this.bodyCss.templateString,!0]):e.withGlobal(c,"insertCssText",ws.widget,[e._getText(this.bodyCss.templatePath),!0])}catch(f){}if(e.isIE)d.body.contentEditable="true",this.connect(d,"onbeforedeactivate","onBeforeDeactivate");else try{d.designMode="on"}catch(g){e.isMoz&&ws.lang.setTimeout(e.hitch(this,function(){this.enableDesignMode(a)}),10);return}ws.widget.popup.registerWin(this.win());d=this.doc();e.isFF?this.connect(d,"onfocus","onFocusHandler"):this.connect(c,
"onfocus","onFocusHandler");this.connect(d,"onkeyup","updateToolbar");this.connect(d,"onmouseup","updateToolbar");e.isIE?this.connect(d,"onkeydown","ieKeyDown"):e.isMoz?this.connect(d,"onkeypress","geckoKeyPress"):e.isWebKit&&this.connect(d,"onkeydown","webkitKeyPress");this.connect(d,"onclick",function(a){e.publish("WSEditor/BodyClick",[{event:a}])});this.connect(d,"ondblclick",function(a){e.publish("WSEditor/BodyDblClick",[{event:a}])});if(e.isWebKit)this.webkitCursorFixFocus=this.connect(this.win(),
"onfocus","fixWebKitCursor");this.designModeEnabled=!0;this.reset(null,!1);if(e.isWebKit)d.designMode="off",d.designMode="on",d.body.setAttribute("contentEditable","true"),d.body.setAttribute("unselectable","off"),d.body.innerHTML=a,this.fixWebKitContentInit(),this.focus()},fixWebKitCursor:function(){var a=this.doc();if(a.body.contentEditable=="false"){if((a=e.query("[contenteditable=true]",a.body))&&a.length!=0&&a[0].innerHTML=="<span></span>")a[0].innerHTML="",this.disconnect(this.webkitCursorFixFocus)}else if(a.body.innerHTML==
"<span></span>")a.body.innerHTML="",this.disconnect(this.webkitCursorFixFocus)},isEmpty:function(){if(e.isWebKit)if(this.richMode){var a=this.doc().body.innerHTML;if(a==""||a=="<span>&nbsp;</span>"||a=="<span></span>")return!0}else if(!e.trim(this.textarea.value))return!0;return!1},getEmptyHtml:function(){return e.isWebKit?"<span></span>":""},openAttachFileDialog:function(){},enableRichText:function(){},showAttachFileButtonInToolBar:function(){if(Config.HasLocalFileSystem&&(e.query(">",this.toolbarPane).forEach(function(a){a.style.display=
"none"},this),this.showAttachFile))this.attachButton.style.display=""},showAllInToolBar:function(){Config.HasLocalFileSystem&&(e.query(">",this.toolbarPane).forEach(function(a){if((a!=this.htmlmodeItem||Config.ShowRichTextHtml)&&(a!=this.richTextButton||this.showRichTextButton)&&(a!=this.attachButton||this.showAttachFile))a.style.display=""},this),this.positionAttachFileButton(!1))},positionAttachFileButton:function(){},positionRichTextButton:function(){},updateMode:function(){if(this.richMode=this.useRichMode()){this.textareaPane.hide();
this.showAllInToolBar();if(e.isIE>=9)this.iframePane.domNode.style.overflow="hidden";this.iframePane.show()}else this.textareaPane.show(),this.showAttachFileButtonInToolBar(),this.iframePane.hide();this.toolbarPaneParent.domNode.style.height="26px";this.positionRichTextButton();this.onResized()},useRichMode:function(){if(this.doForceRichMode)return!0;if(!Settings.UseRichEditor)return!1;return!(e.isIE&&ws.browser.ns8)},getBlankLine:function(){if(!this.blankLine)this.blankLine=e.isFF>=9?"<br>":e.isMoz?
"<div> <br></div>":e.isIE>=9?"<div></div>":"<br>";return this.useRichMode()?this.blankLine:"<br>"},getRichContent:function(){var a="";if(this.htmlMode)a=ws.html.renderedTextContent(this.doc().body);else if(e.isIE&&Config&&Config.IESanitizeTagsForSend&&Config.IESanitizeTagsForSend.length>0){var c=this.doc().body;if(c){var a=c.innerHTML,d=/([^"'\s>]+)\=(('[^']*')|("[^"]*")|([^"'\s>]+))/g,f=Config.IESanitizeTagsForSend.split(","),g=[];e.forEach(f,function(a){g=g.concat(e.query(a,c))});e.forEach(g,function(c){var e=
c.outerHTML.toLowerCase(),f=e.indexOf("<"+c.nodeName.toLowerCase());if(f>=0&&(e=e.indexOf(">"),e>=0&&e>f)){for(var f=c=c.outerHTML.slice(f,e+1),e=null,g=0;(e=d.exec(c))!=null;)if(e.length>=5&&e[2]&&e[2].length>0&&e[2].charAt(0)!="'"&&e[2].charAt(0)!='"'){var i=e.index+e[1].length+1+g,f=f.slice(0,i)+'"'+f.slice(i);g++;i+=e[2].length+1;f=f.slice(0,i)+'"'+f.slice(i);g++}f!=c&&(e=a.indexOf(c),e>=0&&(a=a.slice(0,e)+f+a.slice(e+c.length)))}})}}else a=this.doc().body.innerHTML;var f="<font",i=!1;typeof Settings.ComposeColor!=
"undefined"&&(i=!0,f+=" color='"+Settings.ComposeColor+"'");typeof Settings.ComposeFontSize!="undefined"&&(i=!0,f+=" size='"+Settings.ComposeFontSize+"'");typeof Settings.ComposeFont!="undefined"&&(i=!0,f+=" face='"+Settings.ComposeFont+"'");f+=">";this.addDefaultFontStyles&&i&&(a=f+a+"</font>");a=a.replace(/<p /gi,"<div ").replace(/<p>/gi,"<div>").replace(/<\/p>/gi,"</div>");this.addNewLinesToRichContent&&(a=a.replace(/<div/gi,"\n<div").replace(/<\/div>/gi,"</div>\n").replace(/<br>/gi,"<br>\n"));
e.isIE&&(a=a.replace(/alt=">:O"/gi,'alt="&gt;:O"'));return a},getPlainContent:function(a){if(this.richMode){a||(a=!1);var c=this.isStationeryMode?this.doc().getElementById("role_body"):this.doc().body;(a=ws.html.renderedTextContent(c,a))&&a.length>0&&(a=a.replace(/\u00a0/g," "));return a}else return this.textarea.value},getStationeryContent:function(){if(this.isStationeryMode){var a=this.doc().getElementById("role_body");if(a)return a.innerHTML}return this.getContent()},getContent:function(){return this.richMode?
this.getRichContent():this.getPlainContent()},processBeforeSend:function(){return!1},boldClick:function(a){a.preventDefault();this.command("bold")},italicClick:function(a){a.preventDefault();this.command("italic")},underlineClick:function(a){a.preventDefault();this.command("underline")},horizontalRuleClick:function(a){a.preventDefault();this.command("inserthorizontalrule")},fontColorClick:function(a){a.preventDefault();this.dlgColorPalette("forecolor")},backgroundColorClick:function(a){a.preventDefault();
this.dlgColorPalette("hilitecolor")},smileyClick:function(a){a.preventDefault();this.dlgSmileyPalette()},linkClick:function(a){a.preventDefault();this.linkEditor=new ws.widget.LinkEditor({callbackFunc:e.hitch(this,this.linkEditorDone)});this.linkEditor.startup(this.ieEditorBookmark);this.linkEditor.show(this.win(),this.linkButton);ws.reporting.reportAction("Link Click")},linkEditorDone:function(a){a||this.setAuxDirty(!0);this.updateToolbar();this.refocusAfterPopup()},command:function(a,c,d,f){var g=
this.win();if(e.isMoz)try{g.document.execCommand("useCSS",!1,!0),(a=="hilitecolor"||a=="indent"||a=="outdent")&&g.document.execCommand("useCSS",!1,!1)}catch(i){}try{g.focus(),e.isIE&&this.isStationeryMode&&!f&&this.getFunmail().moveCursorToBodyRole(this.doc(),!0),g.document.execCommand(a,!1,c),g.focus()}catch(j){if(e.isFF==3&&this.isStationeryMode&&(a=="indent"||a=="outdent"||a.indexOf("justify")==0||a.indexOf("orderedlist")!=-1)&&j&&j.result==2147500037){var h=this.win().getSelection().getRangeAt(0),
c=g.document.createElement("br");c.style.lineHeight="0px";for(h=h.startContainer.parentNode;h&&h.contentEditable!="true";)h=h.parentNode;if(!h)throw"Selected node is not editable!";h.insertBefore(c,h.childNodes[0]);g.document.execCommand(a,!1,null);c.parentNode.removeChild(c)}}this._fixMe(a,f);d||(this.updateToolbar(),this.setAuxDirty(!0));return!0},changeFont:function(){e.isIE&&this.rng&&this.rng.select();this.fontPicker.menu&&this.fontPicker.menu.setChecked([this.fontPicker.currentIndex],!0);this.command("fontname",
this.fontPicker.currentValue)},changeFontSize:function(){e.isIE&&this.rng&&this.rng.select();this.fontSizePicker.menu&&this.fontSizePicker.menu.setChecked([this.fontSizePicker.currentIndex],!0);this.command("fontsize",this.fontSizePicker.currentValue)},changeJustify:function(){e.isIE&&this.rng&&this.rng.select();this.justifyPicker.menu.setChecked([this.justifyPicker.currentIndex],!0);this.command(this.justifyPicker.currentValue)},changeList:function(){e.isIE&&this.rng&&this.rng.select();this.listPicker.menu.setChecked([this.listPicker.currentIndex],
!0);this.command(this.listPicker.currentValue)},changeIndent:function(){e.isIE&&this.rng&&this.rng.select();this.command(this.indentPicker.currentValue)},htmlModeClick:function(){if(this.htmlMode){if(e.isIE){var a=escape(this.doc().body.innerText),a=a.replace("%3CP%3E%0D%0A%3CHR%3E","%3CHR%3E"),a=a.replace("%3CHR%3E%0D%0A%3C/P%3E","%3CHR%3E");this.doc().body.innerHTML=unescape(a)}else{var a=this.doc(),c=a.body.ownerDocument.createRange();c.selectNodeContents(a.body);a.body.innerHTML=c.toString()}this.htmlMode=
!1;e.removeClass(this.htmlmodeItem,"activated");if(this.isStationeryMode)this.doc().designMode="Off"}else if(c=this.getRichContent(),e.isIE?this.doc().body.innerText=c:(a=this.doc(),c=a.createTextNode(c),a.body.innerHTML="",a.body.appendChild(c)),this.htmlMode=!0,e.addClass(this.htmlmodeItem,"activated"),this.isStationeryMode)this.doc().designMode="On";this.focus()},dlgSmileyPalette:function(){this.setRange();if(!this.smileyPalette)this.smileyPalette=new ws.widget.SmileyPalette,this._supportingWidgets.push(this.smileyPalette),
this.smileyPalette.startup(),this.connect(this.smileyPalette,"onSmileyClicked","insertSmiley");this.smileyPalette.isShowing()?ws.widget.popup.close(this.smileyPalette):ws.widget.popup({popup:this.smileyPalette,around:this.smileyButton})},insertSmiley:function(a,c){ws.widget.popup.close(this.smileyPalette);var d=Config.SmileyImageExt==".gif"?19:25;this.insertHTML("<img src='"+c+"' alt='"+a+"' height="+d+" width="+d+">",e.isWebKit?!0:!1)},dlgColorPalette:function(a){this.setRange();this.palette=this[a+
"Palette"];if(!this.palette)this.palette=this[a+"Palette"]=new ws.widget.ColorPalette,this._supportingWidgets.push(this.palette),this.palette.startup(),this.connect(this.palette,"onPaletteClicked","setColor");this.palette.isShowing()?ws.widget.popup.close(this.palette):(ws.widget.popup({popup:this.palette,around:this[a+"Item"]}),this.currentCommand=a)},setColor:function(a){var c=this.currentCommand;if(e.isIE){c=="hilitecolor"&&(c="backcolor");var d=this.win();if(d.lastSelRange&&d.lastSelType!="Control")d=
d.lastSelRange,d.select(),this.command(c,a),d.collapse(!1),d.select()}else this.command(c,a)},createStationeryBtn:function(){if(Config.HasLocalFileSystem&&!this.stationaryItem)this.stationaryItem=e.create("a",{title:Config.Strings.StationeryTooltip,id:"stationeryBtn",className:"stationeryIcon rttLabel"},this.linkButton,"after"),e.create("div",{className:"rttIcon"},this.stationaryItem),e.create("span",{innerHTML:Config.Strings.Stationery,className:"rttLabel2"},this.stationaryItem),this.connect(this.stationaryItem,
"onclick","onClickStationeryBtn"),this.subscribe("stationery/close","onClickStationeryBtn"),e.publish("WSEditor/StationeryBtnCreated",[])},onClickStationeryBtn:function(a,c){this.loadServicePlugin({serviceId:"stationery",pluginId:"STATIONERY_AOL",apiMessage:"selectStationery",apiArgs:{name:c}})},updateServiceBtn:function(){},loadServicePlugin:function(a){if(a||a.pluginId)ws.WebSuite.SidePanel.showStationery()?e.addClass(this.stationaryItem,"activated"):e.removeClass(this.stationaryItem,"activated")},
initStationery:function(){this.subscribe("WSEditor/BodyClick",function(a){if(this.isStationeryMode&&a.event.target.contentEditable!="true"){var a=!0,c,d=null;if(e.isIE){if(c=this.doc().selection)try{var f=c.createRange(),d=c.type=="Control"?"":f.text}catch(g){}}else(c=this.win().getSelection())&&(d=c.toString());d!=null&&d!=""&&(a=!1);if(a)this._bodyClickTO=setTimeout(e.hitch(this,function(){this.getFunmail().moveCursorToBodyRole(this.doc())}),400)}});this.subscribe("WSEditor/BodyDblClick",function(){clearTimeout(this._bodyClickTO)})},
getFunmail:function(){if(!this.funmail)this.funmail=new ws.mail.funmail,this.funmail.setDocument(this.doc());return this.funmail},handleFeaturesDraft:function(){this.convertPicturesInMail();this.handleStationeryDraft()},handleStationeryDraft:function(){this.getContent();var a=e.query("table#role_layout",this.doc()),c=!1;a&&(a=a[0]);if(a)try{var d=a.parentNode.parentNode,c=e.query("> div",d.parentNode)[0]==d}catch(f){}if(c)this.isStationeryMode=!0,this.fixEditorForStationery(),this.getFunmail().postcardHandler(this.doc().body.innerHTML),
Config.UseOMS&&(a=this.doc().getElementById("role_body"))&&a.setAttribute("contentEditable","true"),ws.lang.setTimeout(this,"updateToolbar",500)},resetStationeryState:function(){this.isStationeryMode=!1;this.stationeryState=null},clearStationery:function(){if(this.hasStationeryDefaults())Settings.StationeryDefaults={name:null,swatchUrl:null,pluginId:null},ws.settings.saveNow({StationeryDefaults:Settings.StationeryDefaults});var a=this.getStationeryContent();this.resetStationeryState();this.setContent(a,
null,!1,!1,"");this.setAuxDirty(!0)},resetPlugins:function(a){if(this.richMode){var c=this.doc(),d;if(!e.isFF)this.focus(),c.body.scrollTop=0,c.body.scrollLeft=0,c.queryCommandState("bold")&&this.command("bold",null,!0),c.queryCommandState("italic")&&this.command("italic",null,!0),c.queryCommandState("underline")&&this.command("underline",null,!0),c.queryCommandState("justifyRight")?this.command("justifyRight",null,!0):c.queryCommandState("justifyCenter")&&this.command("justifyCenter",null,!0),c.queryCommandState("insertOrderedList")?
this.command("insertOrderedList",null,!0):c.queryCommandState("insertUnorderedList")&&this.command("insertUnorderedList",null,!0);if(a.ComposeFontSize)for(d=0;d<this.fontSizePicker.options.length;d++){if(this.fontSizePicker.options[d].value==a.ComposeFontSize){d=e.isSafari?this.fontSizePicker.options[d].safari:this.fontSizePicker.options[d].other;c.body.style.fontSize=d.replace(/ /g,"");break}}else d=e.isSafari?this.fontSizePicker.options[0].safari:this.fontSizePicker.options[0].other,c.body.style.fontSize=
d.replace(/ /g,"");c.body.style.fontFamily=a.ComposeFont?a.ComposeFont:this.fontPicker.options[0].value;c.body.style.color=a.ComposeColor?a.ComposeColor:"rgb(0, 0, 0)";e.isFF||(this.command(e.isIE?"backcolor":"hilitecolor","transparent",!0),this.updateToolbar(null,!0),this.setAuxDirty(!1))}},resetCursor:function(a){a==void 0&&(a=!1);var c=this.doc(),d;d=this.win();if(this.richMode)if(e.isIE)d=c.body.createTextRange(),d.collapse(a),d.select();else{var f=d.getSelection();d=c.createRange();if((b=c.body||
c.getElementsByTagName("body"))&&b.length)d.selectNode(b[0]),d.collapse(a),f.removeAllRanges(),f.addRange(d)}else if(!(e.isIE&&e.isIE<=8)&&(c=this.textarea)&&c.style.display!="none")this.textarea.focus(),a?this.textarea.setSelectionRange(0,0):(a=c.value.length)?this.textarea.setSelectionRange(--a,a):this.textarea.setSelectionRange(0,0)},reset:function(a,c){var d=a?a:Settings;if(this.richMode)this.resetPlugins(d);else{if(e.isIE==7)this.toolbarPane.style.width=e.coords(this.richTextButton).w+34+"px";
this.richTextButton.style.borderRightWidth=0}c&&this.resetCursor(!0);this.resizeToolBar()},insertStationery:function(a){if(a.url=="")return this.clearStationery();e.xhrGet({url:Config.BasePagesURL+"common/proxy.aspx/stationery",content:{url:a.url},timeout:5E3,handleAs:"text",load:e.hitch(this,function(c){this._loadStationeryTemplate(c,a)}),error:function(){}})},_loadStationeryTemplate:function(a,c){this.isStationeryMode=!0;this.stationeryState=c;this.fixEditorForStationery();this.getFunmail().postcardHandler(a);
this.setAuxDirty(!0);ws.lang.setTimeout(this,"updateToolbar",500)},fixEditorForStationery:function(){try{if(this.isStationeryMode){this.doc().body.style.padding="0";if(e.isIE){if(!this.win().lastSelRange){var a=this.doc().getElementById("role_body");a&&(a.focus(),this.onBeforeDeactivate())}}else this.doc().designMode="on",this.doc().designMode="off";this.doc().body.setAttribute("contentEditable","false");this.doc().body.setAttribute("unselectable","on")}else{this.doc().body.style.padding="15px 15px 15px 15px";
if(!e.isIE)this.doc().designMode="off",this.doc().designMode="on";this.doc().body.setAttribute("contentEditable","true");this.doc().body.setAttribute("unselectable","off")}}catch(c){}},insertHTML:function(a,c,d){var f=this.win();f.focus();e.isIE?(this.isStationeryMode&&!c&&this.getFunmail().moveCursorToBodyRole(this.doc(),!0,!0),f=c&&f.lastSelRange?f.lastSelRange:f.document.selection.createRange(),this.win().lastSelType!="Control"&&(f.pasteHTML(a),f.collapse(!1),f.select())):(this.isStationeryMode&&
(!e.isWebKit||!c)&&this.doc().getElementById("role_body").focus(),d&&!e.isFF?(c=f.getSelection(),c.isCollapsed||c.deleteFromDocument(),c=c.getRangeAt(0),!c.collapsed&&c.collapse(),a.charAt(0)!="<"&&(a="<span>"+a+"</span>"),a=e._toDom(a,f.document),d=a.firstChild.firstChild,c.insertNode(a.firstChild),c.selectNode(d),f=f.getSelection(),f.removeAllRanges(),f.addRange(c),f.collapseToEnd()):f.document.execCommand("insertHTML",!1,a));this.setAuxDirty(!0);this.updateToolbar(null,!0,!0);this.refocusAfterPopup()},
refocusAfterPopup:function(){e.isWebKit?ws.lang.setTimeout(e.hitch(this,function(){document.body.focus();ws.lang.setTimeout(e.hitch(this,function(){this.win().focus()}),100)}),100):e.isFF>=3&&this.win().focus()},setRange:function(){var a=this.win();this.focus();if(e.isIE){if(a=a.document.selection,a!=null)this.rng=a.createRange()}else a=a.getSelection(),this.rng=a.getRangeAt(a.rangeCount-1).cloneRange();return this.rng},onBeforeDeactivate:function(){this.ieEditorBookmark=null;var a=this.doc().selection,
c=a.createRange();a.type=="Control"?this.win().lastSelNode=c.item(0):this.ieEditorBookmark=c.getBookmark();this.win().lastSelType=a.type;this.win().lastSelRange=c},ieKeyDown:function(){var a=this.win().event,c=!1;if(a.keyCode==8){var d=this.doc().selection;d&&d.type=="Control"&&((c=d.createRange().item(0))&&c.parentNode&&c.parentNode.removeChild(c),c=!0)}if(a.ctrlKey&&a.keyCode==13)this.sendMessage(),c=!0;else if(a.altKey&&a.keyCode==187)this.spellCheck(),c=!0;else if(a.altKey)switch(String.fromCharCode(a.keyCode).toLowerCase()){case Config.Strings.KeyComposeClose:this.cancel(),
c=!0}else if(a.ctrlKey&&a.keyCode>=65&&a.keyCode<=90)switch(String.fromCharCode(a.keyCode).toLowerCase()){case Config.Strings.KeyComposeBold:this.command("bold",null);c=!0;break;case Config.Strings.KeyComposeItalic:this.command("italic",null);c=!0;break;case Config.Strings.KeyComposeUnderline:this.command("underline",null),c=!0}else if(a.keyCode==13&&e.isIE==9){var d=this.doc().selection,f=(d=d.createRange())?d.parentElement():null;f&&f.tagName=="P"&&!f.firstChild&&(d.pasteHTML("<br />"),c=!0)}else!a.shiftKey&&
a.keyCode===e.keys.TAB&&(this.insertTab(),c=!0);if(c)return a.cancelBubble=!0,a.returnValue=!1},webkitKeyPress:function(a){var c=!1,d=ws.html.fixKeyCodeForMac(a);a.ctrlKey?d==e.keys.ENTER&&(this.sendMessage(),c=!0):a.altKey&&(d==187?(this.spellCheck(),c=!0):d==88&&(this.cancel(),c=!0));c&&e.stopEvent(a)},geckoKeyPress:function(a){var c=!1;if(a.ctrlKey){switch(String.fromCharCode(a.charCode).toLowerCase()){case Config.Strings.KeyComposeBold:this.command("bold",null);c=!0;break;case Config.Strings.KeyComposeItalic:this.command("italic",
null);c=!0;break;case Config.Strings.KeyComposeUnderline:this.command("underline",null),c=!0}if(a.keyCode==13||a.keyCode==77&&e.isMac)this.sendMessage(),c=!0}else if(a.altKey)switch(a.keyChar.toLowerCase()){case Config.Strings.KeyComposeClose:this.cancel();c=!0;break;case "=":this.spellCheck(),c=!0}else!a.shiftKey&&a.keyCode===e.keys.TAB&&(this.insertTab(),c=!0);c&&(a.preventDefault(),a.stopPropagation())},insertTab:function(){this.insertHTML("&nbsp;&nbsp;&nbsp;&nbsp;",!1)},cancel:function(){},sendMessage:function(){},
updateToolbar:function(a,c){var d=!1;a&&a.type=="mouseup"&&(d=!0);var f=ws.WebSuite.SidePanel;this.stationaryItem&&f&&(f.isSelectedPanel(f.stationery)?e.addClass(this.stationaryItem,"activated"):e.removeClass(this.stationaryItem,"activated"));this.updateToolbarTimeout&&clearTimeout(this.updateToolbarTimeout);c?this._updateToolbar(d):this.updateToolbarTimeout=ws.lang.setTimeout(e.hitch(this,"_updateToolbar",d),300)},compareFontFamilyStr:function(a,c){var d=a.toLowerCase().split(","),f=c.toLowerCase().split(","),
g=e.trim(d[0]),i=e.trim(f[0]);if(g==i)return!0;else if(g=="arial"&&f[1]&&e.trim(f[1])==g&&i=="helvetica"&&d[1]&&e.trim(d[1])==i)return!0;else if(g=="helvetica"&&f[1]&&e.trim(f[1])==g&&i=="arial"&&d[1]&&e.trim(d[1])==i)return!0;return!1},_updateToolbar:function(a){try{var c=this.doc(),d=!0,f,g=null;if(e.isIE){if(f=this.doc().selection)var i=f.createRange(),g=f.type=="Control"?"":i.text}else(f=this.win().getSelection())&&(g=f.toString());g!=null&&g!=""&&(d=!1);var j=c.queryCommandValue("fontname");
f=!1;g=0;if(j)for(var h=0;h<this.fontPicker.options.length;h++)this.fontPicker.options[h].checked=!1,!f&&this.compareFontFamilyStr(this.fontPicker.options[h].value,j)&&(g=h,f=!0);if(!f){if(typeof Settings.ComposeFont!="undefined")for(h=0;h<this.fontPicker.options.length;h++)if(this.compareFontFamilyStr(this.fontPicker.options[h].value,Settings.ComposeFont)){g=h;break}this.addDefaultFontStyles&&d&&this.command("fontname",this.fontPicker.options[g].value,!0,a)}this.fontPicker.setOption(g);this.fontPicker.menu?
this.fontPicker.menu.setChecked([g],!0):(this.fontPicker.options[0].checked=!1,this.fontPicker.options[g].checked=!0);var m=c.queryCommandValue("fontsize");f=!1;var l=this.isStationeryMode?2:1;if(!(m==null||m==""))for(h=0;h<this.fontSizePicker.options.length;h++){this.fontSizePicker.options[h].checked=!1;var k=e.isSafari?this.fontSizePicker.options[h].safari:this.fontSizePicker.options[h].value;!f&&m==k&&(l=h,f=!0)}if(!f&&typeof Settings.ComposeFontSize!="undefined")for(h=0;h<this.fontSizePicker.options.length;h++)if(this.fontSizePicker.options[h].value==
Settings.ComposeFontSize){l=h;break}this.fontSizePicker.setOption(l);!f&&this.addDefaultFontStyles&&d&&this.command("fontsize",this.fontSizePicker.currentValue,!0,a);this.fontSizePicker.menu?this.fontSizePicker.menu.setChecked([l],!0):(this.fontSizePicker.options[1].checked=!1,this.fontSizePicker.options[l].checked=!0);a=["justifyleft","justifycenter","justifyright"];this.justifyPicker.menu&&this.justifyPicker.menu.setUnchecked();for(h=0;h<a.length;h++)if(c.queryCommandState(a[h])){this.justifyPicker.menu&&
this.justifyPicker.menu.setChecked([h],!0);this.justifyPicker.domNode.className="wsSelect "+a[h]+"Icon";break}else this.justifyPicker.menu&&this.justifyPicker.menu.setChecked([0],!0),this.justifyPicker.domNode.className="wsSelect justifyleftIcon";e.toggleClass(this.justifyPicker.domNode,"activated",!0);h=["bold","italic","underline"];for(a=0;a<h.length;a++){var o=this[h[a]+"Item"],n=c.queryCommandState(h[a]);e.toggleClass(o,"activated",n)}o=["insertorderedlist","insertunorderedlist"];this.listPicker.menu&&
this.listPicker.menu.setUnchecked();for(n=0;n<o.length;n++)if(c.queryCommandState(o[n])){this.listPicker.menu&&this.listPicker.menu.setChecked([n],!0);this.listPicker.domNode.className="wsSelect "+o[n]+"Icon";e.toggleClass(this.listPicker.domNode,"activated",!0);break}else e.toggleClass(this.listPicker.domNode,"activated",!1)}catch(r){}},onResized:function(){this.inherited(arguments);if(this.stationaryItem&&this.richMode)if(ws.WebSuite.widthMode==1)e.style(this.stationaryItem,"display","none");else{e.style(this.stationaryItem,
"display","");var a=e.marginBox(this.toolbarPaneParent.domNode).w,c=e.marginBox(this.toolbarPane).w;this.stationaryLabelNode=this.stationaryLabelNode||e.query(".rttLabel2",this.stationaryItem)[0];this.stationeryButtonWidth=this.stationeryButtonWidth||e.marginBox(this.stationaryItem).w;if(this.stationaryLabelNode.style.display!="none"){if(a-c<=0)this.stationaryLabelNode.style.display="none",e.replaceClass(this.stationaryItem,"rttLabelOff","rttLabel")}else if(a-(c-32+this.stationeryButtonWidth)>0)e.replaceClass(this.stationaryItem,
"rttLabel","rttLabelOff"),this.stationaryLabelNode.style.display=""}this.resizeToolBar();this.richMode||(c=e.coords(this.textarea.parentNode),a=c.w-(e.isFF?18:28),c=c.h-15,e.isFF&&(c-=10),e.style(this.textarea,{width:(a<=0?0:a)+"px",height:(c<=0?0:c)+"px",margin:"0",padding:"15px 10px",overflow:"auto",fontFamily:"Helvetica,Arial,sans-serif"}))},focus:function(){this.richMode?this.win().focus():this.textarea.focus()},onFocusHandler:function(){e.publish("WSEditor/focus",[])},selectNode:function(a){if(a)if(e.isIE){var c=
this.doc().body.createTextRange();try{c.moveToElementText(a),c.collapse(!0),c.select()}catch(d){}}else{var f=this.win().getSelection(),c=this.doc().createRange();c.selectNode(a);c.collapse(!0);f.removeAllRanges();f.addRange(c)}},_fixMe:function(a,c){e.isIE&&this.isStationeryMode&&!c&&this.getFunmail().moveCursorToBodyRole(this.doc(),!0)},win:function(){return this.iframe.contentWindow},doc:function(){return e.io.iframe.doc(this.iframe)},onIframeLoaded:function(){this.iframe._loaded=!0}});e._hasResource["ws.widget.SpellCheckEditor"]||
(e._hasResource["ws.widget.SpellCheckEditor"]=!0,e.provide("ws.widget.SpellCheckEditor"),e.declare("ws.widget.SpellCheckEditor",ws.widget.WSEditor,{css:{templateString:""},spellNodeCount:0,misspellings:0,spellChecking:!1,startup:function(){this.inherited(arguments);e.addClass(this.domNode,"spellCheckEditor")},_enableDesignMode:function(){this.inherited(arguments);this.connect(this.doc(),"onkeypress","endSpellCheck")},toggleSpellCheck:function(){this.spellChecking?this.endSpellCheck():this.spellCheck()},
spellCheck:function(a){var c=this.richMode?ws.html.renderedTextContent(this.doc().body):this.textarea.value;ws.io.rpc({action:"SpellCheck",content:{check:c},error:function(a){window.ws_ErrLgr&&!a&&ws_ErrLgr.logError(ws_ErrLgr.cat.UserVisErr,"Dialogs.ok shown - Error Handler for SpellCheck-spellCheck file:SpellCheckEditor.js");ws.widget.Dialogs.ok(a||Config.Strings.ErrorSpellChecking)},load:e.hitch(this,"handleSpellCheckResult",a)})},handleSpellCheckResult:function(a,c){if(ws.lang.isEmptyObject(c.sets))a||
ws.widget.Dialogs.ok(Config.Strings.PerfectSpelling),this.onPerfectSpelling();else{this.onImperfectSpelling();this.spellChecking=!0;this.misspellings=this.spellNodeCount=0;this.sets=c.sets;if(this.richMode){if(this.iframe.style.backgroundColor="#FDF6E4",this.spellDoc=this.doc(),this.spellWin=this.win(),this.spellBody=this.doc().body,e.isIE&&this.spellBody.innerHTML.charAt(0)!="<")this.spellBody.innerHTML="<wbr>"+this.spellBody.innerHTML}else{if(!this.spellBodyPane)this.spellBodyPane=new ws.widget.Pane({layoutAlign:"client"}),
this.spellBodyPane.domNode.className="spellBody wsInput",this.spellBodyPane.hide(),this.layoutWidget.addChild(this.spellBodyPane);var d=this.textarea.value.replace(/&/g,"&amp;").replace(/</g,"&lt;"),d=d.replace(/\r?\n/g,"<br />\n");this.spellBodyPane.domNode.innerHTML=d;this.textareaPane.hide();this.spellBodyPane.show();this.layoutWidget.resize();this.spellDoc=document;this.spellWin=window;this.spellBody=this.spellBodyPane.domNode;e.isSafari&&(this.hide(),ws.lang.setTimeout(this,"show",0))}this.highlightErrors()}},
onPerfectSpelling:function(){},onImperfectSpelling:function(){},highlightErrors:function(){var a=[],c;for(c in this.sets)a.push(c);var d=RegExp("\\b("+a.join("|")+")\\b");ws.dom.forEachNode(this.spellBody,null,e.hitch(this,function(a){if(a.nodeType!=3)return 0;if(a.parentNode.id!=null&&a.parentNode.id.substr(0,3)=="sp-")return 0;for(var c=0,i=d.exec(a.nodeValue);i;){var j=i[0],h=this.sets[j],a=a.splitText(i.index),i=a.splitText(j.length),j=this.spellDoc.createElement("a");j.href="#";j.id="sp-"+this.spellNodeCount;
j.title=h.length?Config.Strings.ClickToReplaceWith+(e.isIE?"\n":"")+h.join(", "):Config.Strings.NoSpellingSuggestions;j.className="spell";this.connect(j,"onclick","showSpellMenu");a.parentNode.replaceChild(j,a);j.appendChild(a);a=i;this.spellNodeCount++;this.misspellings++;c+=2;i=null;try{i=d.exec(a.nodeValue)}catch(m){}}return c}))},closeSpellMenu:function(){this.spellMenu&&this.spellMenu.isShowing()&&this.spellMenu.close()},showSpellMenu:function(a){var a=e.fixEvent(a||this.spellWin.event),c=a.target,
d=this.sets[c.childNodes[0].nodeValue];this.spellMenu?(this.spellMenu.close(),e.forEach(this.spellMenu.getChildren(),function(a){a.destroy()})):(this.spellMenu=new ws.widget.WSMenu,this.spellMenu.startup());for(var f=e.hitch(this,function(a,c){var d=new ws.widget.WSMenuItem({caption:a});d.onClick=c;this.spellMenu.addChild(d)}),g=0;g<d.length;g++)f(d[g],e.hitch(this,"correctWord",c,d[g]));d.length>0&&this.spellMenu.addChild(new ws.widget.WSMenuSeparator);f(d.length?Config.Strings.IgnoreWord:Config.Strings.NoSuggestions,
e.hitch(this,"ignoreWord",c));f(Config.Strings.IgnoreAll,e.hitch(this,"ignoreAll",c));this.richMode?(f=e._abs(this.iframe),d=e.withGlobal(this.win(),"_abs",e,[c])):(f={x:0,y:0},d={x:a.clientX,y:a.clientY});c=e.contentBox(c);this.spellMenu.open(f.x+d.x,f.y+d.y+c.h);a.stopPropagation()},changeWord:function(a,c){if(c==null)if(a&&a.childNodes[0]){var d=a.childNodes[0];(c=d.nodeValue)||(c=e.isIE?d.innerText:d.textContent)}else c="";d=this.spellDoc.createTextNode(c);e.place(d,a,"before");e._destroyElement(a)},
correctWord:function(a,c){this.changeWord(a,c);this.misspellings--;this.misspellings==0&&this.endSpellCheck()},ignoreWord:function(a){this.correctWord(a,null)},ignoreAll:function(a){for(var a=a.childNodes[0].nodeValue.toLowerCase(),c=0;c<this.spellNodeCount;c++){var d=this.spellDoc.getElementById("sp-"+c);d&&d.childNodes.length==1&&d.childNodes[0].nodeType==3&&d.childNodes[0].nodeValue.toLowerCase()==a&&this.correctWord(d,null)}},isSpellCheckRunning:function(){return this.spellChecking},endSpellCheck:function(){if(this.spellChecking){for(var a=
0;a<this.spellNodeCount;a++){var c=this.spellDoc.getElementById("sp-"+a);c&&c.innerHTML!=""&&this.changeWord(c,null)}this.spellMenu&&this.spellMenu.hide();if(this.richMode)this.iframe.style.backgroundColor="white";else{this.textarea.value=ws.html.renderedTextContent(this.spellBody);this.spellBodyPane.hide();this.textareaPane.show();a=e._getPadBorderExtents(this.textarea);with(this.textarea.style)width=parseInt(this.textareaPane.domNode.style.width)-a.w+"px",height=parseInt(this.textareaPane.domNode.style.height)-
a.h+"px"}this.spellChecking=!1;this.onEndSpellCheck()}},onEndSpellCheck:function(){}}));e._hasResource["ws.pictures.PictureEditor"]||(e._hasResource["ws.pictures.PictureEditor"]=!0,e.provide("ws.pictures.PictureEditor"),e.declare("ws.pictures.PictureEditor",ws.widget.SpellCheckEditor,{hasAccessTokenToPicturePlugin:!1,startup:function(){this.inherited(arguments);this.imageIdMap={}},setContent:function(a,c,d){this.inherited(arguments);this.richMode&&this.createInsertPicsBtn(d)},convertPicturesInMail:function(){for(var a=
this.doc().getElementsByTagName("img"),c=0;c<a.length;c++)if(a[c].id&&a[c].id.indexOf("AOLP")!=-1){var d=a[c].id,f=a[c].src;this.imageIdMap[d]={id:d,placeholder:!1,altText:a[c].alt,srcUrl:f,smallUrl:f,mediumUrl:f,largeUrl:f}}if(a.length&&!this.editControl)this.editControl=new ws.pictures.PictureEditControl({editor:this}),this._supportingWidgets.push(this.editControl),e.body().appendChild(this.editControl.domNode),this.editControl.startup()},updateImageUrlsAfterSave:function(a){if(a)for(var c=this.doc().getElementsByTagName("img"),
d=0;d<c.length;d++)if(c[d].id&&c[d].id.indexOf("AOLP")!=-1)for(var e=0;e<a.length;e++){var g=a[e];if(c[d].id==g.id)c[d].src=g.url}},createInsertPicsBtn:function(){if(Config.EnablePictures&&!(Settings.UserHash<Config.UserHashThresholds.pictures)&&!this.insertPicsBtn)this.insertPicsBtn=new ws.widget.DropDownButton({label:"<img class='picturesIcon' src='"+Config.SpacerImageURL+"'>",title:Config.Strings.YGP_OpenPickerTooltip,onClick:e.hitch(this,"onClickPicturesBtn"),menuClassName:"wsMenuInsertPics",
size:"Small",className:"attachInlineBtn"}),this._supportingWidgets.push(this.insertPicsBtn),e.place(this.insertPicsBtn.domNode,this.attachButton,"after"),this.insertPicsBtn.startup(),e.removeClass(this.insertPicsBtn.domNode,"btn"),e.removeClass(this.insertPicsBtn.domNode,"btnSmall"),this.constructEmbedImageFormHolder(!1),this.insertPicsBtn.enableArrow(!1),this.positionEmbedImageForm(this.insertPicsBtn.domNode,!0)},constructEmbedImageFormHolder:function(a){this.embedImageFormHolder=document.createElement("div");
a?e.body().appendChild(this.embedImageFormHolder):this.insertPicsBtn.domNode.appendChild(this.embedImageFormHolder);this.embedImageFormHolder.style.position="relative";this.embedImageFormHolder.style.zIndex=a?3E3:997;this.embedImageFormHolder.style.visibility="hidden";a&&this.connect(this.embedImageFormHolder,"onclick","hideFileInput");this.connect(this.embedImageFormHolder,"onmouseover","redirectInsertPicsEvent");this.connect(this.embedImageFormHolder,"onmouseout","redirectInsertPicsEvent");this.connect(this.embedImageFormHolder,
"onmouseenter","redirectInsertPicsEvent");this.connect(this.embedImageFormHolder,"onmouseleave","redirectInsertPicsEvent");this.constructEmbedImageForm()},redirectInsertPicsEvent:function(a){var c=this.insertPicsBtn.domNode;if(this.insertPicsBtn.isArrowEnabled())c=this.insertPicsBtn.menu.getChildren()[0].domNode;if(e.isIE){var d=document.createEventObject();d.altKey=a.altKey;d.altLeft=a.altLeft;d.button=a.button;d.clientX=a.clientX;d.clientY=a.clientY;d.ctrlKey=a.ctrlKey;d.ctrlLeft=a.ctrlLeft;d.dataFld=
a.dataFld;d.offsetX=a.offsetX;d.offsetY=a.offsetY;d.reason=a.reason;d.repeat=a.repeat;d.screenX=a.screenX;d.screenY=a.screenY;d.shiftKey=a.shiftKey;d.shiftLeft=a.shiftLeft;d.type=a.type;d.x=a.x;d.y=a.y;c.fireEvent("on"+a.type,d)}else d=document.createEvent("MouseEvents"),d.initMouseEvent(a.type,a.bubbles,a.cancelable,a.view,a.detail,a.screenX,a.screenY,a.clientX,a.clientY,!1,!1,!1,!1,a.button,a.relatedTarget),c.dispatchEvent(d)},onClickPicturesBtn:function(){},positionEmbedImageForm:function(a,c){var d=
e.position(a);if(d){if(!c)this.embedImageFormHolder.style.marginLeft=d.x+"px",this.embedImageFormHolder.style.marginTop=d.y+"px";var f=d.w;this.embedImageFormHolder.style.clip="rect(0px "+f+"px "+d.h+"px 0px)";this.embedImageFormHolder.style.visibility="visible";this.insertPicsBtn.isArrowEnabled()&&this.insertPicsBtn.menu.connect(this.insertPicsBtn.menu,"onClose",e.hitch(this,"hideFileInput"));this.embedImageFileInput.style.marginLeft=0;d=e.position(this.embedImageFileInput);this.embedImageFileInput.style.marginLeft=
-(d.w-f)+"px"}},hideFileInput:function(){this.embedImageFormHolder.style.clip="rect(0px 0px 0px 0px)";this.insertPicsBtn.isArrowEnabled()&&this.insertPicsBtn.menu.isShowing()&&this.insertPicsBtn.menu.close();return!1},onSelectFile:function(){ws.reporting.reportAction("Click Insert Pictures");if(this.embedImageFileInput.value!=""){var a=this.embedImageFileInput.value,a=this.getFileName(a),c="AOLP."+(new Date).getTime()%1E6;try{this.insertEmbeddedImage(c,!0,a,"",!0)}catch(d){}var f=this,g=this.embedImageFileInput.parentNode;
ws.io.rpc({action:"ComposeMessageImageStore",content:{id:c},formNode:g,async:!0,load:function(d){e.body().removeChild(g);f.insertEmbeddedImage(c,!1,a,d.url,!0);f.tornEditor&&f.tornEditor.insertEmbeddedImage(c,!1,a,d.url,!0)},error:function(d){e.body().removeChild(g);f.insertEmbeddedImage(c,!1,a,d,!1);f.tornEditor&&f.tornEditor.insertEmbeddedImage(c,!1,a,d,!0)}});this.constructEmbedImageForm();this.embedImageFileInput.value="";e.publish("InlineImageInserted")}},constructEmbedImageForm:function(){var a=
0;if(this.embedImageFileInput){var a=this.embedImageFileInput.style.marginLeft,c=this.embedImageFileInput.parentNode;e.body().appendChild(c)}this.embedImageFormHolder.innerHTML='<form method="post" enctype="multipart/form-data"><input type="file" name="file0" class="trueEmbedFileInput"/></form>';this.embedImageFileInput=e.query("input",this.embedImageFormHolder)[0];this.embedImageFileInput.style.marginLeft=a;this.connect(this.embedImageFileInput,"onchange","onSelectFile")},insertEmbeddedImage:function(a,
c,d,f,g){var i='<div class="envelope" align="left" style="float: none;"><img src="%{0}" width="'+Config.InsertedPictureLongestEdge+'" id="%{1}" style="%{2}" alt="%{3}" class="%{4}" title="%{3}"></div><div><span></span></div>';if(!this.editControl)this.editControl=new ws.pictures.PictureEditControl({editor:this}),e.body().appendChild(this.editControl.domNode),this.editControl.startup();this.imageIdMap[a]={id:a,placeholder:c,altText:d,srcUrl:f,smallUrl:f,mediumUrl:f,largeUrl:f};if(c)this.insertHTML(ws.string.substituteParams(i,
Config.BaseImagesURL+"common/progressAnimation_lg.gif",a,"margin: 5px; vertical-align: middle; border: 1px solid #0066CC;",d,"wsPlaceholder"),!0,!0);else if(c=this.doc().getElementById(a))g?(c.src=f,c.className="AOLInlineImage",c.style.border=""):(this.editControl&&(this.editControl.removeEventHandlers(a),this.editControl.closeControls()),e.isWebKit?e.query('[id="'+a+'"]',this.doc()).orphan():c.parentNode.parentNode.removeChild(c.parentNode),delete this.imageIdMap[a],a="Upload failed",a=f?ws.string.substituteParams("{0}: {1}",
"<b>"+d+"</b>",f):ws.string.substituteParams(Config.Strings.ImageEmbed_UploadFailed,"<b>"+d+"</b>"),ws.widget.Dialogs.ok(a));this.editControl.installEventHandlers();this.callWhenReadyForSaveOrSend(this.sendReadyCallback)},insertImage:function(a){var c='<div class="envelope" align="left" style="float: none;"><img src="%{0}" width="'+Config.InsertedPictureLongestEdge+'" id="%{1}" style="%{2}" _viewlink="%{3}" class="%{4}" title="%{5}"></div><div><span></span></div>';if(a.placeholder)a.id&&(this.imageIdMap[a.id]=
a,a=ws.string.substituteParams(c,Config.BaseImagesURL+"common/progressAnimation_lg.gif",a.id,"margin: 5px; vertical-align: middle; border: 1px solid #0066CC;","","wsPlaceholder","Your image is being uploaded"),this.insertHTML(a));else if(a.id){if(this.imageIdMap[a.id])this.imageIdMap[a.id]=a,(c=this.doc().getElementById(a.id))?a.mediumUrl?(c.src=a.mediumUrl,c.className="AOLInlineImage",c.setAttribute("_viewlink",a.largeUrl),c.setAttribute("title",ws.string.escapeXml(a.caption||"")),c.parentNode.href=
a.largeUrl?a.largeUrl:a.mediumUrl):(c.parentNode.parentNode.removeChild(c.parentNode),delete this.imageIdMap[a.id],c="Upload failed, please try again later",a.caption&&(c=ws.string.substituteParams("File size for {0} exceeds the allowed limit and will not be uploaded",a.caption)),ws.widget.Dialogs.ok(c)):delete this.imageIdMap[a.id]}else a.id="AOLP."+(new Date).getTime()%1E5,this.imageIdMap[a.id]=a,a=ws.string.substituteParams(c,a.mediumUrl,a.id,"margin: 5px; vertical-align: middle; border: 1px solid #0066CC;",
a.largeUrl,"AOLInlineImage",ws.string.escapeXml(a.caption||"")),this.insertHTML(a);if(!this.editControl)this.editControl=new ws.pictures.PictureEditControl({editor:this}),e.body().appendChild(this.editControl.domNode),this.editControl.startup();this.editControl.installEventHandlers()},isReadyForSend:function(){for(var a in this.imageIdMap)if(this.imageIdMap[a].placeholder&&this.doc().getElementById(a))return!1;return!0},callWhenReadyForSaveOrSend:function(a){if((this.sendReadyCallback=a)&&this.isReadyForSend())this.sendReadyCallback(),
this.sendReadyCallback=null},cancelCallWhenReadyForSaveOrSend:function(){this.sendReadyCallback=null},messageHasEmbeddedImages:function(){return e.query('img[class="AOLInlineImage"]',this.win().document.body).length>0?!0:!1},refetchMissingImages:function(a){if(a)for(var c=0;c<a.length;++c){var d=a[c].replace(/^AOLP/,"TIE");if(d=this.doc().getElementById(d))d.removeAttribute("alt"),d.src=""}},prepareForSaveOrSend:function(a){for(var c in this.imageIdMap)if(this.imageIdMap[c].placeholder){var d=this.doc().getElementById(c);
d&&(d.parentNode.parentNode.removeChild(d.parentNode),delete this.imageIdMap[c])}else if(a&&c.indexOf("AOLP")>=0&&(d=this.doc().getElementById(c)))if(d.id=d.id.replace(/^AOLP/,"TIE"),d.getAttribute("_viewlink")){var f=d.ownerDocument.createElement("a");f.setAttribute("target","_blank");f.href=d.getAttribute("_viewlink");f.appendChild(e.clone(d));d.parentNode.replaceChild(f,d)}},getFileName:function(a){return a.indexOf("/")>-1?a.substring(a.lastIndexOf("/")+1):a.substring(a.lastIndexOf("\\")+1)},notifyUploadCompletions:function(a){this.tornEditor=
a},cleanUp:function(){this.editControl&&this.editControl.closeControls();this.sendReadyCallback=null},containsInlineImage:function(){for(var a=this.doc().getElementsByTagName("img"),c=0;c<a.length;c++)if(a[c].id&&a[c].id.indexOf("AOLP")!=-1&&e.hasClass(a[c],"AOLInlineImage"))return!0;return!1},clean:function(){if(this.editControl)this.editControl.destroy(),this.editControl=null}}));e._hasResource["ws.mail.ComposeMessageWidget"]||(e._hasResource["ws.mail.ComposeMessageWidget"]=!0,e.provide("ws.mail.ComposeMessageWidget"),
e.declare("ws.mail.ComposeMessageWidget",[k._Widget,k._Templated],{templateString:e.cache("ws.mail","ComposeMessageWidget.html",'<div dojoAttachEvent="onkeydown: onKeyPressInputField">\r\n\t<div dojoType="dijit.layout.StackContainer" class="composeMessage" dojoAttachPoint="stackWidget">\r\n\t\t<div dojoType="dijit.layout.LayoutContainer" dojoAttachPoint="layoutWidget" id="composeLayout" class="composeLayout">\r\n\t\t\t<div dojoType="ws.widget.WSToolbar" layoutAlign="top" dojoAttachPoint="toolbar" vizType="Controls">\r\n\t\t\t\t<div dojoType="ws.widget.Button" dojoAttachEvent="onClick:sendMessage" dojoAttachPoint="sendButton" tip="${ComposeSendButton}" iconClassName="sendIcon">${Button_Label_Send}</div>\r\n\t\t\t\t<div dojoType="ws.widget.Button" dojoAttachEvent="onClick:saveMessage" dojoAttachPoint="saveDraftButton" title="${SaveDraftTip}" tip="${ComposeSaveAsDraftButton}" iconClassName="draftIcon">${Save}</div>\r\n\t\t\t\t<div dojoType="ws.widget.Button" dojoAttachEvent="onClick:spellCheck" dojoAttachPoint="spellCheckButton" iconClassName="spellIcon">${ComposeSpellingButton}</div>\r\n\t\t\t\t<div dojoType="ws.widget.Button" dojoAttachEvent="onClick:deleteDraft" dojoAttachPoint="deleteDraftButton" iconClassName="delIcon">${ComposeDeleteDraftButton}</div>\r\n\r\n                <div dojoType="ws.widget.Button" dojoAttachEvent="onClick:cancel" dojoAttachPoint="cancelButton" title="${Cancel}" iconClassName="cancelIcon" toolbarPosition="right"></div>\r\n                <div dojoType="ws.widget.Button" dojoAttachEvent="onClick:onClickNewWindow" dojoAttachPoint="newWindowLink" title="${NewWindowTip}" iconClassName="newWindowIcon" toolbarPosition="right">${NewWindow}</div>\r\n\t\t\t</div>\r\n\t\t\t\r\n\t\t\t<div dojoType="ws.widget.Pane" layoutAlign="top" class="header" dojoAttachPoint="headerWidget">\r\n                <div style="padding-right: 0;" class="field">\r\n                    <div style="display:none" dojoAttachPoint="fromAddressEditBoxDiv">\r\n                        <div dojoType="ws.widget.DefaultTextbox" dojoAttachPoint="fromAddressEditBox" dojoAttachEvent="onKeyPress:processEditBoxKeyPress, onBlur:saveFriendlyName" style="width:20%;float:left;padding:5px;" tabindex="99"></div>\r\n                    </div>\r\n                    <div>\r\n                        <a href="#" class="fnameA" dojoAttachEvent="onclick:fromAddressEdit" dojoAttachPoint="fromAddressSpan" >${friendlyFromName}</a>\r\n                        <div dojoType="ws.widget.WSSelect" dojoAttachPoint="fromSelect" size="byValue"></div>\r\n                    </div>\r\n                    <div class="emailEntryLinks">\r\n                        <span dojoAttachEvent="onclick:showCc" class="bccLink" dojoAttachPoint="showCcLink"\r\n                              title="${ShowCcTip}">${Cc}</span>&nbsp;\r\n                        <span dojoAttachEvent="onclick:showBcc" class="ccLink" dojoAttachPoint="showBccLink"\r\n                              title="${ShowBccTip}">${Bcc}</span>\r\n                    </div>\r\n\t\t\t\t\t<div class="feedback" dojoAttachPoint="feedbackNode"><span class="feedbackSpin" dojoAttachPoint="feedbackSpin" dojoAttachPoint="feedbackSpin"></span><span class="feedbackMsg" dojoAttachPoint="feedbackMsg"></span></div>\r\n                   <span class="newWindowLink" dojoAttachEvent="onclick:onClickNewWindow" dojoAttachPoint="newWindowLink" title="${NewWindowTip}"></span>\r\n               </div>\r\n                <div ghostText="${To}" class="toField" dojoType="ws.address.ComposeAddressField" dojoAttachPoint="toField"\r\n                     lineHeight="14" tabindex="100"></div>\r\n                <div ghostText="${Cc}" class="ccField" dojoType="ws.address.ComposeAddressField" dojoAttachPoint="ccField"\r\n                     lineHeight="14" style="display:none" tabindex="101"></div>\r\n                <div ghostText="${Bcc}" class="bccField" dojoType="ws.address.ComposeAddressField" dojoAttachPoint="bccField"\r\n                     lineHeight="14" style="display:none" tabindex="102"></div>\r\n                <div class="subjectContainer field wsInput">\r\n                    <div class="subjectLabel">${Subject}:</div>\r\n                    <div style="overflow: hidden;"><input class="subject" type="text" name="Subject" id="subjectField" dojoAttachPoint="subjectInput" tabindex="103" /></div>\r\n                </div>\r\n                <div dojoAttachPoint="attachmentRow" style="display:none; position: relative;">\r\n                    <div class="attachmentContainer">\r\n                        <span dojoAttachPoint="attachmentDisplay"></span>\r\n                    </div>\r\n                </div>\r\n\t\t\t</div>\r\n\t\t\t<div dojoType="ws.pictures.PictureEditor" id="editor" layoutAlign="client"\r\n                dojoAttachPoint="editor"\r\n                showAttachFile="true" tabindex="104"></div>\r\n\t\t</div>\r\n\t</div>\r\n    <input dojoAttachPoint="focusInput" type="text" style="position:absolute;width:0;height:0;border:none;outline:none;padding: 0;margin: 0;" />\r\n</div>\r\n'),
css:{templateString:""},widgetsInTemplate:!0,_earlyTemplatedStartup:!0,showNewWindowLink:!0,model:null,picturesModel:null,backToString:"setFolder",backToStringOverride:"",inTransition:!1,beaconSuffix:"",isStandAlone:!1,isPopup:!1,callBackTimeout:100,mk:1,nextCid:1,kidTeenAccount:ws.UserContext.ParentalControls=="Y"||ws.UserContext.ParentalControls=="K",preventDomainlessAddressFix:!1,topContactSuggest:null,fromAddr:"",attachUploadDispId:0,attachUploadDispRefObjs:{},attachUploadDispNodes:{},attachUploadFilenameMap:{},
friendlyFromName:Settings.FromDisplayName,identity:null,reportingDLreqID:null,autoSaveDraftSubInterval:null,autoSaveIntervalCounter:0,autoSaveCharCount:0,startup:function(){this.DLreport=this.isPopup&&_ws_isOpenerWS()?opener.ws.reporting.DL:ws.reporting.DL;this.addressModel=new ws.address.AddressModel;this.connect(this.editor,"picturesClick","picturesClick");this.connect(this.editor,"enableRichText","enableRichText");this.connect(this.editor,"positionAttachFileButton","positionAttachFileButton");
this.connect(this.editor,"positionRichTextButton","positionRichTextButton");this.connect(this.editor,"onPerfectSpelling","onPerfectSpelling");this.connect(this.editor,"onImperfectSpelling","onImperfectSpelling");this.connect(this.editor,"onEndSpellCheck","onEndSpellCheck");this.connect(this.editor,"sendMessage","sendMessage");this.connect(this.editor,"cancel","cancel");this.connect(this.editor,"updateToolbar","updateToolbar");this.model instanceof ws.mail.MailModel&&this.connect(this.model,"infoUpdated",
"infoUpdated");Config.EnableSaveAsDraft||this.saveDraftButton.hide();Config.EnableSpellCheck||this.spellCheckButton.hide();if(!this.showNewWindowLink||!ws.settings.allowPopups()||this.isPopup)this.newWindowLink.domNode.style.display="none";this.isPopup&&e.addClass(this.domNode,"composeMessagePopup");this.connect(this.toField,"onResizedSelf","layoutSoon");this.connect(this.ccField,"onResizedSelf","layoutSoon");this.connect(this.bccField,"onResizedSelf","layoutSoon");this.connect(this.editor.toolbarPane,
"onclick","layoutSoon");this.connect(e.global,"onresize","layoutSoon");Config.FixDomainlessAddresses&&Config.FixDomainlessAddresses.length>0&&(this.connect(this.toField,"onBlur",e.hitch(this,"fixDomainlessAddresses",this.toField)),this.connect(this.ccField,"onBlur",e.hitch(this,"fixDomainlessAddresses",this.ccField)),this.connect(this.bccField,"onBlur",e.hitch(this,"fixDomainlessAddresses",this.bccField)),this.connect(this.toField.peoplePicker,"onOpen",function(){this.preventDomainlessAddressFix=
!0}),this.connect(this.toField.peoplePicker,"onClose",function(){this.preventDomainlessAddressFix=!1}));this.editor.picturesModel=this.picturesModel;if(Config.EnableStationery&&e.isFF!=2&&!(Settings.UserHash<Config.UserHashThresholds.stationery))this.editor.initStationery(),this.isPopup||this.editor.createStationeryBtn(),this.stationeryEnabled=!0;this.isStandAlone||ws.browser.addOnBeforeUnload(this,"onBeforeUnload");this.sendAttachAsLinks=!1;!this.form&&!Config.EnableFlashFileUploader&&(this.createBaseAttachUploadForm(),
this.editor.attachButton.appendChild(this.form),this.createEmptyFileInput());this.subscribe("AddressFieldFocusChange",function(a){this.onFocusAddressField=a});this.subscribe("WSEditor/focus","onEditorFocus");this.subscribe("Suite/onKeyOnPress","onKeyPress");this.subscribe("InlineImageRemoved","updateInlineImage");this.subscribe("InlineImageInserted","updateInlineImage");this.subscribe("friendlyNameUpdated","updateDisplayName");this.subscribe("stationery/select","selectStationery");this.subscribe("stationery/clear",
"clearStationery");var a=e.isMac?Config.Strings.CtrlReturnKey:Config.Strings.CtrlEnterKey;this.sendButton.setTip(Config.Strings.ComposeSendButton+" <span>("+a+")</span>");e.attr(this.sendButton,"title",Config.Strings.ComposeSendButton+" ("+a+")");a=e.isMac?Config.Strings.OptKey:Config.Strings.AltKey;this.spellCheckButton.setTip(Config.Strings.CheckSpelling+" <span>("+a+" =)</span>");e.attr(this.spellCheckButton,"title",Config.Strings.CheckSpelling+" ("+a+" =)");e.attr(this.toField,"title",Config.Strings.SelectToRecipients+
" ("+a+" [)");e.attr(this.ccField,"title",Config.Strings.SelectCcRecipients+" ("+a+" ])");e.attr(this.bccField,"title",Config.Strings.SelectBccRecipients+" ("+a+" \\)");ws.lang.setTimeout(this,function(){this.editor.resizeToolBar()},1);(this.isPopup||this.isStandAlone)&&e.addClass(this.domNode,"popupWin")},setAddressFieldValue:function(a,c){c?a.setValue(c.replace("@unknown.domain",""),null,!0):a.setValue("")},selectStationery:function(a,c,d,e){this.editor.insertStationery({url:c,name:a.label,swatchUrl:e,
id:a.id})},clearStationery:function(){this.editor.insertStationery({url:"",name:"",swatchUrl:""})},picturesClick:function(){},openAttachFileDialog:function(){},enableRichText:function(){var a=this.draftMessage&&this.draftMessage.uid;a&&this.model.composeSettingsChanged();if(a||this.isResponse||this.isDirty())this.checkForAttachments(e.hitch(this,function(){var a={to:this.toField.getValue(),cc:this.ccField.getValue(),bcc:this.bccField.getValue(),subject:this.subjectInput.value,originalMessage:this.originalMessage,
draftMessage:this.draftMessage,composeType:this.composeType,preloadAttachments:this.preloadAttachments,sourceAttachments:this.sourceAttachments,isDirty:this.isDirty()},c=this.editor.getContent();a.body=c.replace(/\r\n/g,"<br>").replace(/\n/g,"<br>").replace(/\r/g,"<br>");a.bodyIsCurrentMsg=!0;this._enableRichText(a,null)}));else{var a={},c=this.editor.getContent();c!=null&&(a={to:this.toField.getValue(),subject:this.subjectInput.value,body:c.replace(/\r\n/g,"<br>").replace(/\n/g,"<br>").replace(/\r/g,
"<br>"),bodyIsCurrentMsg:!0});this._enableRichText(a,null)}},_enableRichText:function(a,c){var d=a||{};ws.settings.save({UseRichEditor:!0},{load:e.hitch(this,function(){Settings.UseRichEditor=!0;this.reset(d,c);ws.lang.setTimeout(this,function(){this.editor.resizeToolBar(!0)},1)}),error:function(a){window.ws_ErrLgr&&!a&&ws_ErrLgr.logError(ws_ErrLgr.cat.UserVisErr,"Dialogs.ok shown - Error Handler for settings.save-_enableRichText file:ComposeMessageWidget.js");ws.widget.Dialogs.ok(a||Config.Strings.Settings_SaveError)}})},
handleAttachDialogCancel:function(){},handleAttachDialogDone:function(){},createBaseAttachUploadForm:function(){e.isIE<9?this.form=document.createElement("<form method='post' enctype='multipart/form-data'>"):(this.form=document.createElement("form"),this.form.method="post",this.form.enctype="multipart/form-data");e.addClass(this.form,"fileIputForm")},undo:function(){},onHide:function(){this.cleanupAttachments();this.editor.clean();if(this.autoSaveDraftSubInterval)clearInterval(this.autoSaveDraftSubInterval),
this.autoSaveDraftSubInterval=null},cleanupAttachments:function(){for(var a=[],c=0;c<this.preloadAttachments.length;c++)a.push(this.preloadAttachments[c].id);a.length>0&&this.model.deleteAttachments(a)},moveUploadForm:function(){},setModel:function(a){this.model=a},setPicturesModel:function(a){this.picturesModel=a;this.editor.setPicturesModel(a)},showHideField:function(a,c){var d=this[a.toLowerCase()+"Field"],e=this["show"+a+"Link"];ws.html.setShowing(d.domNode,c);ws.html.setShowing(e,!c);c&&d.focus();
this.layoutSoon()},showCc:function(){this.showHideField("Cc",!0);this.showCcLink.style.display="none"},showBcc:function(){this.showHideField("Bcc",!0);this.showBccLink.style.display="none"},layoutSoon:function(){ws.lang.defer(this,"layout",0,this.id+"Layout")},layout:function(){this.layoutWidget.resize()},onKeyPressInputField:function(a){if(a.keyCode>=65&&a.keyCode<=90)a.keyChar=String.fromCharCode(a.keyCode);this.handleKey(a)},onKeyPress:function(a){this.isShowing()&&this.handleKey(a)},handleKey:function(a){var c=
!1,a=ws.html.fixKeyForMac(a);if(Config.EnableKeyboardShortcuts&&a.altKey&&a.keyChar)switch(a.keyChar.toLowerCase()){case Config.Strings.KeyComposeClose:a.preventDefault(),a.stopPropagation(),ws.lang.setTimeout(this,"cancel",150),c=!0}else if(Config.EnableKeyboardShortcuts&&a.ctrlKey)switch(ws.html.fixKeyCodeForMac(a)){case e.keys.ENTER:this.sendMessage(),c=!0}else if(Config.EnableKeyboardShortcuts&&a.altKey)if(a.keyCode==219)ws.lang.setTimeout(this.toField,"togglePeoplePicker",100),c=!0;else if(a.keyCode==
221)this.showCc(),ws.lang.setTimeout(this.ccField,"togglePeoplePicker",100),c=!0;else if(a.keyCode==220)this.showBcc(),ws.lang.setTimeout(this.bccField,"togglePeoplePicker",100),c=!0;else if(a.keyCode==187||a.keyCode==61&&e.isMoz||a.keyCode==107&&e.isMoz>=5)this.spellCheck(),c=!0;c&&e.stopEvent(a)},onResized:function(){this.positionRichTextButton();this.inherited(arguments)},onEditorFocus:function(){this.onFocusAddressField=null},addEmail:function(a,c){if(!this.onFocusAddressField)this.onFocusAddressField=
this.toField;var d=this.onFocusAddressField;if(c)if(c=="to")d=this.toField;else if(c=="cc")d=this.ccField,this.showCc();else if(c=="bcc")d=this.bccField,this.showBcc();var e=d.getValue(a),e=e.replace(/^\s+/,"");(e=e.replace(/\s+$/,""))?e+=e.charAt(e.length-1)==";"||e.charAt(e.length-1)==","?" "+a+",":", "+a+",":e=a+",";d.focus();d.setValue(e)},isSendConfirmationOnShow:function(){var a=!1;if(this.sendConfirmation){var c=this.stackWidget.getChildren();e.indexOf(c,this.sendConfirmation)!=-1&&(a=!0)}return a},
reset:function(a,c){this.domNode.style.display="block";if(this.sendConfirmation){var d=this.stackWidget.getChildren();e.indexOf(d,this.sendConfirmation)!=-1&&this.stackWidget.removeChild(this.sendConfirmation);this.stackWidget.resize()}this.layoutWidget!=this.stackWidget.selectedChildWidget&&this.stackWidget.selectChild(this.layoutWidget);a=a||{};d="";this.model.sendAddresses&&this.model.sendAddresses.length&&(d=this.model.sendAddresses[0][1]);ws.WebSuite.cmpseMsgWidPersist.selectedFromAddr=a.from||
ws.WebSuite.cmpseMsgWidPersist.lastSelFromAddr||d;this.setupFromAddress();if(a.to&&a.to.indexOf("mailto:")==0&&(d=a.to.substr(7,a.to.length),d=d.split("?"),d.length&&(a.to=d[0],d[1])))for(var d=d[1].split("&"),f=0;d&&f<d.length;f++){var g=d[f].split("=");if(g&&g[0]&&g[1]){if(g[0].toLowerCase()=="cc")a.cc=decodeURIComponent(g[1]);if(g[0].toLowerCase()=="bcc")a.bcc=decodeURIComponent(g[1]);if(g[0].toLowerCase()=="subject")a.subject=decodeURIComponent(g[1]);if(g[0].toLowerCase()=="body")a.body=decodeURIComponent(g[1])}}this.showHideField("Cc",
!!a.cc);this.showHideField("Bcc",!!a.bcc);this.setAddressFieldValue(this.toField,a.to);this.setAddressFieldValue(this.ccField,a.cc);this.setAddressFieldValue(this.bccField,a.bcc);this.subjectInput.value=a.subject||"";this.draftMessage=ws.lang.shallowCopy(a.draftMessage||{},!0);this.originalMessage=ws.lang.shallowCopy(a.originalMessage||{},!0);this.composeType=a.composeType||"";this.initAttachments(a.preloadAttachments,a.sourceAttachments);this.missingAttachmentWarningShown=!1;this.editor.isStationeryMode=
!!a.isStationeryMode;this.editor.stationeryState=a.stationeryState;this.resetStationery();this.showFeedback();this.sendAttachAsLinks=this.spellCheckFailure=this.sendAfterSpellCheck=!1;this.topContactSuggest=this.lastSavedMsgUID=this.inSaveOrSend=null;this.editor.endSpellCheck();this.oneDiffUploadComplete=this.attachmentsDeleted=this.autoSaveMsgInProgress=!1;this.autoSavedAttachmentsCount=0;this.autoSavedAttachments={};this.forceReadSavedMsg=!1;this.toggleButtonState(!0);this.layoutSoon();var i=this.beaconSuffix;
if(!this.isPopup&&a.beaconSuffix)i=a.beaconSuffix;d=a.dontAddSignature;this.model.standAloneMailModel&&(d=!0);this.initBody(a.body,a.quote,d,a.isPopOut,a.bodyIsCurrentMsg,e.hitch(this,function(){e.isFF>=3.6&&(this.editor.htmlModeClick(),this.editor.htmlModeClick());a.isDirty?this.setDirty():this.resetDirty();c&&c();a.skipComposeBeacon||ws.reporting.report("Compose Message - "+i,"Mail");this.editor.isStationeryMode?this.editor.fixEditorForStationery():this.editor.resetStationeryState();this.editor.reset(null,
a.body);this.focusField();this.editor.convertPicturesInMail();this.editor.editControl&&this.editor.editControl.installEventHandlers()}));if(a.backToString&&this.model)this.backToButtonString=a.backToString=="setFolder"?ws.string.substituteParams(Config.Strings.BackToFolder,ws.string.summary(this.model.getCurrentFolder().displayName,17)):a.backToString;a.isPopOut&&e.addOnUnload(this,"cleanupAttachments");if(Settings.UserHash>=Config.AutoSaveToDraftsThreshold&&Settings.EnableAutoSave&&(d=Config.AutoSaveToDraftsInterval,
null!=d&&-1!=d))this.oneDiffUploadComplete=this.attachmentsDeleted=this.autoSaveMsgInProgress=!1,this.autoSavedAttachmentsCount=0,this.autoSavedAttachments={},this.autoSaveCharCount=this.autoSaveIntervalCounter=0,this.autoSaveDraftSubInterval&&clearInterval(this.autoSaveDraftSubInterval),this.autoSaveDraftSubInterval=setInterval(e.hitch(this,"autoSaveMessage"),Config.AutoSaveToDraftsSubInterval*1E3),this.lastSaved=null;ws.lang.setTimeout(this,function(){this.editor.resizeToolBar()},1)},resetStationery:function(){ws.WebSuite.SidePanel&&
(ws.WebSuite.SidePanel.resetStationery(),ws.WebSuite.SidePanel.handleMainStackSelect());this.editor.resetStationeryState();this.editor.fixEditorForStationery()},infoUpdated:function(){this.model.standAloneMailModel&&(this.setupFromAddress(),this.model.getSignature()&&(this.setBodyContent(this.editor.getContent()),this.resetDirty()))},getSigHTML:function(a){return"<div style='clear:both'>"+a+"</div>"},setBodyContent:function(a,c,d,f,g,i){var j=this.editor.useRichMode(),h=e.isMac?"helvetica,arial":
"arial,helvetica";a&&j&&(a="<div style='font-family:"+h+";font-size:10pt;color:black'>"+a+"</div>");var a=a||"",m=this.composeType.indexOf("reply")==0||this.composeType=="forward";this.isResponse=m;var l=j?this.model.getSignature(!0):this.model.getSignature(!1);(d=l&&!d)&&j&&(l=this.getSigHTML(l));var k=this.editor.getBlankLine();c&&j&&(c="<div style='font-family:"+h+";font-size:10pt;color:black'>"+c+"</div>");c=c?k+c:"";h=d?l:"";!f&&!g&&(m&&d?a=c+k+k+h+k+k+a:m?a=c+k+k+k+a:d?(c&&(c=c+k+k),a=c+a+k+
k+h):c&&(a=c));c=!1;this.draftMessage.isDraft&&!j&&(c=!0);this.editor.setContent(a,i,f,c,null,!!this.draftMessage.isDraft)},initBody:function(a,c,d,e,g,i){this.setBodyContent(a,c,d,e,g,i);Settings.ShowCcField&&this.showCc();Settings.ShowBccField&&this.showBcc();this.focusField()},updateToolbar:function(a,c,d){d||c&&this.focusField()},focusField:function(){window.focus();this.toField.getValue()?this.subjectInput.value?this.editor.focus():this.subjectInput.focus():this.toField.focus()},saveFriendlyName:function(){if(this.fromAddressEditBoxDiv.style.display!=
"none")this.model.saveDisplayName(ws.WebSuite.cmpseMsgWidPersist.selectedFromAddr,this.fromAddressEditBox.getValue()),this.fromAddressEditBoxDiv.style.display="none",this.setupFromAddress()},cancelFriendlyEdit:function(){if(this.fromAddressEditBoxDiv.style.display!="none")this.fromAddressEditBoxDiv.style.display="none",this.setupFromAddress()},updateDisplayName:function(){this.setupFromAddress()},processEditBoxKeyPress:function(a){switch(a.keyCode){case e.keys.ENTER:this.saveFriendlyName();break;
case e.keys.ESCAPE:this.cancelFriendlyEdit()}},fromAddressEdit:function(){if(Config.FriendlyNameInCompose)this.fromAddressSpan.style.display="none",this.fromAddressSpan.innerHTML="",this.fromAddressEditBoxDiv.style.display="",this.fromAddressEditBox.setValue(this.getFromDisplay(this.fromSelect.currentValue)),this.fromAddressEditBox.textbox.focus(),ws.html.selectInputText(this.fromAddressEditBox.textbox),this.fromAddressEditBox.textbox.style.color="#000"},setupFromAddress:function(){for(var a=this.model.sendAddresses,
c=[],d=0,e=0;e<a.length;e++){ws.WebSuite.cmpseMsgWidPersist.selectedFromAddr&&ws.WebSuite.cmpseMsgWidPersist.selectedFromAddr.indexOf(a[e][1])!=-1&&(d=e);var g=ws.string.escapeXml(a[e][1]),g="";Config.FriendlyNameInCompose&&(g="<span class='fromA'>"+ws.string.escapeXml(this.getFromDisplay(a[e][1]))+"</span>");g=g+"<span class='fromB'>"+ws.string.escapeXml(a[e][1])+"</span>";c.push({display:g,value:a[e][1],selected:!1})}if(c.length)c[d].selected=!0;this.fromSelect.setOptions(c);if(Config.FriendlyNameInCompose){this.fromAddressSpan.style.display=
"";a=this.getFromDisplay(a[d][1]);if(!a)a=Config.Strings.AddName;this.fromAddressSpan.innerHTML=ws.string.escapeXml(a)}else this.fromAddressSpan.style.display="none",this.fromAddressSpan.innerHTML="";if(this.fromSelect.currentValue)this.fromSelect.currentValueNode.innerHTML=ws.string.escapeXml(this.fromSelect.currentValue);this.fromSelect.sizeMyself();this.connect(this.fromSelect,"valueChanged","handleChange")},handleChange:function(){ws.WebSuite.cmpseMsgWidPersist.selectedFromAddr=this.fromSelect.currentValue;
ws.WebSuite.cmpseMsgWidPersist.lastSelFromAddr=this.fromSelect.currentValue;var a=this.getFromDisplay(ws.WebSuite.cmpseMsgWidPersist.selectedFromAddr);if(!a)a=Config.Strings.AddName;this.fromAddressSpan.innerHTML=ws.string.escapeXml(a);this.fromSelect.currentValueNode.innerHTML=ws.string.escapeXml(ws.WebSuite.cmpseMsgWidPersist.selectedFromAddr);this.fromSelect.sizeMyself()},getFromDisplay:function(a){var c=null,d=this.model.getIdentities();if(a)for(var e=0;e<d.length;e++)a.indexOf(d[e][1])!=-1&&
(c=d[e]);return c?c[2]:Settings.FromDisplayName},confirmClose:function(a,c){var d=ws.WebSuite.composeCanceled?"composeCancel":c,d=d?d:"";this.abortSend();e.isIE&&(e.doc.body.focus(),this.focusInput.focus());this.inTransition?ws.widget.Dialogs.show(Config.Strings.MessageNotSent+"<br>"+Config.Strings.MsgNotSentNavigateAway,[Config.Strings.Yes,Config.Strings.No],e.hitch(this,function(c){if(c==0&&a)this.DLreport.removeEvent(this.reportingDLreqID),this.reportingDLreqID=null,ws.lang.setTimeout(a,this.callBackTimeout)})):
this.isDirty()?Config.EnableSaveAsDraft?(ws.reporting.reportAction("Compose: Save Drafts Dialog shown, reason: "+d),ws.widget.Dialogs.show("<b>"+Config.Strings.DirtyMessageSent+"</b><br>"+Config.Strings.DirtyMessage5+"<br><br>",[Config.Strings.SaveAsDraft,Config.Strings.KeepWriting,Config.Strings.Discard],e.hitch(this,function(c){c==0?(ws.reporting.reportAction("Compose: Save Drafts Dialog, action:'Save as Draft', reason: "+d),this.isPopup&&a?e.subscribe("WSDoneSyncingAfterSave",e.hitch(this,function(){ws.lang.setTimeout(a,
this.callBackTimeout)})):a&&ws.lang.setTimeout(a,this.callBackTimeout),this.saveMessage()):c==2?(ws.reporting.reportAction("Compose: Save Drafts Dialog, action:'Discard', reason: "+d),a&&ws.lang.setTimeout(a,this.callBackTimeout)):ws.reporting.reportAction("Compose: Save Drafts Dialog, action:'Keep Writing', reason: "+d)}),{width:390})):!this.isStandAlone&&this.showNewWindowLink&&ws.settings.allowPopups()?ws.widget.Dialogs.show(Config.Strings.DirtyMessageSent+"<br><br>"+Config.Strings.DirtyMessage2,
[Config.Strings.Yes,Config.Strings.KeepWriting,Config.Strings.No],e.hitch(this,function(c){c==0?this.popOut():c==2&&a&&ws.lang.setTimeout(a,this.callBackTimeout)})):ws.widget.Dialogs.okCancel(Config.Strings.DirtyMessageSent+"<br><br>"+Config.Strings.DirtyMessage3,e.hitch(this,function(c){c&&a&&ws.lang.setTimeout(a,this.callBackTimeout)})):a&&ws.lang.setTimeout(a,this.callBackTimeout)},onSessionExpired:function(a){this.isDirty()?ws.widget.Dialogs.yesNo(Config.Strings.AuthTimeoutMain+"<br><br>"+Config.Strings.DirtyMessage2,
e.hitch(this,function(c){c?(this.resetDirty(),this.popOut(!0,a,!0)):(this.resetDirty(),a&&a())})):a&&a()},onBeforeUnload:function(){return this.isShowing()&&this.isDirty()?Config.EnableSaveAsDraft?Config.Strings.DirtyMessageSaveOrSent:Config.Strings.DirtyMessageSent:null},isDirty:function(){return this.getCurrentStateHash().contentVal!=this.initialStateHash||this.editor.isAuxDirty()},isSubIntervalDirty:function(){return Math.abs(this.getCurrentStateHash().bodyLength-this.autoSaveCharCount)>=Config.AutoSaveToDraftsCharDelta},
setDirty:function(){this.autoSaveCharCount=-Config.AutoSaveToDraftsCharDelta;this.initialStateHash=this.getCurrentStateHash().contentVal+"x"},resetDirty:function(){this.editor.setAuxDirty(!1);var a=this.getCurrentStateHash();this.initialStateHash=a.contentVal;this.autoSaveCharCount=a.bodyLength;this.autoSaveIntervalCounter=0},getCurrentStateHash:function(){var a=!1;if(e.isWebKit||e.isFF)a=!0;var a=this.editor.getPlainContent(a),c=a.length;return{contentVal:this.toField.getValue()+this.ccField.getValue()+
this.bccField.getValue()+this.subjectInput.value+a+this.getAttachmentsHash(),bodyLength:c}},getAttachmentsHash:function(){var a="";e.query(".attachmentBtn",this.attachmentDisplay).forEach(function(c){a+=c.getAttribute("title")});return a},getConcatenatedAddressDisplayForm:function(a){for(var c="",d=0;d<a.length;d++)c+=a[d].userInputForm,d<a.length-1&&(c+="; ");return c},openDraft:function(a,c){this.model.getMessage({folder:a,uid:c,load:e.hitch(this,function(a){var c=this.getConcatenatedAddressDisplayForm(a.to),
g=this.getConcatenatedAddressDisplayForm(a.cc),i=this.getConcatenatedAddressDisplayForm(a.bcc);this.reset({dontAddSignature:!0,draftMessage:a,composeType:"draft",to:c,cc:g,bcc:i,subject:a.subject,body:a.body,backToString:this.backToString,from:a.inputFrom},e.hitch(this,function(){this.editor.handleFeaturesDraft();this.resetDirty()}))})})},syncAftersave:function(a,c){this.model.getMessage({folder:a,uid:c,syncAftersave:!0,load:e.hitch(this,function(a){this.forceReadSavedMsg=!1;this.draftMessage=ws.lang.shallowCopy(a||
{},!0);this.originalMessage={};this.composeType="draft";this.initAttachments();this.editor.updateImageUrlsAfterSave(a.inlineImgIds);this.editor.handleFeaturesDraft();this.resetDirty();e.publish("WSDoneSyncingAfterSave")})})},deleteDraft:function(){this.draftMessage&&this.draftMessage.uid?this.confirmClose(e.hitch(this,function(){this.model.deleteMessages({folder:Config.DraftsFolderName,uids:[this.draftMessage.uid],reason:"deldrft",error:function(a){window.ws_ErrLgr&&!a&&ws_ErrLgr.logError(ws_ErrLgr.cat.UserVisErr,
"Dialogs.ok shown - Error Handler for model.deleteMessages-deleteDraft file:ComposeMessageWidget.js");ws.widget.Dialogs.ok(a||Config.Strings.ErrorDeletingDraft)}});this.resetDirty();this.cancel()}),"draftDeleted"):this.cancel()},deleteAutoSaveDraft:function(){this.model.deleteMessages({folder:Config.DraftsFolderName,uids:[this.draftMessage.uid],reason:"deldrft",error:function(){}});this.resetDirty()},toggleButtonState:function(a){this.sendButton.setEnabled(a);this.spellCheckButton.setEnabled(a);this.saveDraftButton.setEnabled(a);
this.deleteDraftButton.setEnabled(a);this.cancelButton.setEnabled(a);this.newWindowLink.setEnabled(a)},sendMessage:function(){this._sendMessage()||this.toggleButtonState(!0)},_sendMessage:function(){this.toggleButtonState(!1);Config.FixDomainlessAddresses&&Config.FixDomainlessAddresses.length>0&&this.fixDomainlessAddresses();if(Config.ValidateEmailFormat&&this.checkEmailFields())return!1;if(this.showBccParenWarning())return!1;if(this.showMissingAttachmentWarning())return!1;if(!this.sendAfterSpellCheck&&
Settings.SpellCheckBeforeSend&&Config.EnableSpellCheck)return this.editor.endSpellCheck(),this.sendAfterSpellCheck=!0,this.editor.spellCheck(!0),!1;this.spellCheckFailure=!1;if(this.editor.processBeforeSend())return!1;if(this.editor.isReadyForSend())return this.continueSending(!1);else e.publish("WSFeedbackStart",[Config.Strings.ImageEmbed_UploadThenSend,!1,e.hitch(this,"abortSend"),null,Config.Strings.ImageEmbed_StopSend]),this.editor.callWhenReadyForSaveOrSend(e.hitch(this,"continueSending",!0));
return!0},abortSend:function(){this.editor.cancelCallWhenReadyForSaveOrSend();this.toggleButtonState(!0)},continueSending:function(a){a&&e.publish("WSFeedbackEnd",[Config.Strings.ImageEmbed_UploadThenSend]);e.publish("WSFeedbackStart",[Config.Strings.SendingProgress]);this.inTransition=!0;this.reportingDLreqID=this.DLreport.startEvent(this.filledFileInputs.length<1?"send_mail":"send_mail_att");this.DLreport.setData(this.reportingDLreqID,{msgSize:this.editor.getPlainContent().length,op1:this.isPopup?
"popup":"inline"});var c=e.hitch(this,function(a,c,d){this.model.trackdl("-CMW.CSb",this.reportingDLreqID);c="fail";if(d&&(d=="550:13045"||d=="500:13052"||d==Config.Strings.ErrorSendingAttachTooLarge2||d==Config.Strings.ErrorSendingAttachTooLarge))c="userErr";if(a&&(a==Config.Strings.ErrorSendingAttachTooLarge2||a==Config.Strings.ErrorSendingAttachTooLarge||a==Config.Strings.ErrorNoValidRecipient))c="userErr";this.filledFileInputs.length<=0?(this.model.trackdl("-CMW.CSc",this.reportingDLreqID),this.DLreport.endEvent(this.reportingDLreqID,
{opResult:c,errType:"api",errCode:d||a}),ws.widget.Dialogs.ok(a||Config.Strings.ErrorSending),e.publish("WSFeedbackEnd",[Config.Strings.SendingProgress]),this.toggleButtonState(!0),this.inTransition=!1,this.inSaveOrSend=null,this.editor.cleanUp()):(this.model.trackdl("-CMW.CSd",this.reportingDLreqID),this.ss(!0,a,d))}),d="unknown",f="api",g="fail";this.model.trackdl("-CMW.CSa",this.reportingDLreqID);this.saveOrSendMessage({action:"sendMessage",load:e.hitch(this,function(a){this.model.trackdl("-CMW.CSe",
this.reportingDLreqID);var j=!1;if(a.attachmentFailure)j=!0,this.handleFailedAttachment(a,"_sendMessage"),d="attachmentFailure",f="app";else if(a.attachTooLarge){c(a.errorMsg);d="attachmentTooLarge";f="app";g="userErr";return}else if(a.missingImages)j=!0,this.handleMissingTmpImages(a),d="missingImages",f="app";else{if(this.stationeryEnabled){var h=this.editor.stationeryState;if(h&&h.id&&h.name){ws.reporting.reportAction("Stationery Mail Sent (STATIONERY_AOL) - "+h.name);if(typeof Settings.StationeryDefaults!=
"unknown"&&typeof Settings.StationeryDefaults.id!="unknown"&&(Settings.StationeryDefaults.id!=h.id||Settings.StationeryDefaults.name!=h.name))Settings.StationeryDefaults={id:h.id,name:h.name,swatchUrl:h.swatchUrl},ws.settings.saveNow({StationeryDefaults:Settings.StationeryDefaults});this.editor.resetStationeryState()}ws.WebSuite.SidePanel&&ws.WebSuite.SidePanel.hide()}if(this.autoSaveDraftSubInterval)clearInterval(this.autoSaveDraftSubInterval),this.autoSaveDraftSubInterval=null;!j&&this.editor.messageHasEmbeddedImages()&&
ws.reporting.reportAction("Mail Sent with embedded images in it");if(a.topContactSuggest)this.topContactSuggest=a.topContactSuggest;Settings.AutoAddOnSend&&this.checkForNewlyAdded();var m=h=!1;(a=ws.io.getQueryParameter("noSendConf"))&&a==="1"&&this.isStandAlone?h=!0:(Config.EnableShowSendConfPageSetting=="all"||Config.EnableShowSendConfPageSetting=="premium"&&Settings.IsPaying=="1")&&!Settings.ShowSendConfPage?m=!0:(this.setupSendConfirmation(),this.stackWidget.selectChild(this.sendConfirmation),
e.isMac&&e.isFF==3&&(this.stackWidget.selectChild(this.layoutWidget),this.stackWidget.selectChild(this.sendConfirmation)),!this.isPopup&&!this.isStandAlone&&ws.WebSuite.Navigation.updateNavCollapser(!1))}e.publish("WSFeedbackEnd",[Config.Strings.SendingProgress]);this.toggleButtonState(!0);this.inTransition=!1;j?(this.model.trackdl("-CMW.CSg",this.reportingDLreqID),this.DLreport.endEvent(this.reportingDLreqID,{opResult:g,errType:f,errCode:d})):(this.resetDirty(),this.onShowSendConfirmation(),this.model.trackdl("-CMW.CSf",
this.reportingDLreqID),this.DLreport.endEvent(this.reportingDLreqID,{opResult:"success"}));this.inSaveOrSend=null;this.editor.cleanUp();if(h){ws.reporting.reportAction("Mail Sent, noSendConf query param,stand-alone win close)");try{window.close()}catch(l){}}else m&&(ws.reporting.reportAction("Mail Sent, No Send Conf (preference:off)"),this.isPopup&&_ws_isOpenerWS()?window.opener.ws&&window.opener.ws.WebSuite&&window.opener.ws.WebSuite.msgSentFeedbackFromPopout&&window.opener.ws.WebSuite.msgSentFeedbackFromPopout():
e.publish("WSFeedbackStart",[Config.Strings.ComposeSentTitle,!0]),this.isResponse&&ws.WebSuite.composeSrc=="display"?this.closeAfterSuccess(!0):this.closeAfterSuccess())}),error:c});this.model.trackdl("-CMW.CSz",this.reportingDLreqID);return!0},checkForNewlyAdded:function(){var a=null,c=this.addressListToArray(this.toField),d=this.addressListToArray(this.ccField),e=this.addressListToArray(this.bccField),c=c.concat(d,e);if(!this.addressModel)this.addressModel=new ws.address.AddressModel;for(d=0;d<
c.length;d++)if((a=this.addressModel.getRecordByEmail(c[d]))||(a=this.addressModel.getRecordByScreenName(c[d])),!a)break;a||ws.lang.setTimeout(this,function(){this.addressModel.core.loadData()},5E3)},addressListToArray:function(a){c=[];if(a.getValue())for(var c=a.getValue().split(/[\s,;]/),a=0;a<c.length;a++)e.trim(c[a])||c.splice(a--,1);return c},handleFailedAttachment:function(a,c){var d=!1,e="";if(a.bgAttach)for(var g=0;g<this.preloadAttachments.length;g++)if(this.preloadAttachments[g].id==a.bgAttach)d=
!0,e=this.preloadAttachments[g].name,this.preloadAttachments.splice(g,1);d?(d=ws.string.substituteParams(Config.Strings.AttachFailure,e),this.updateAttachmentRow()):d=Config.Strings.ErrorSending;c!=null&&ws.widget.Dialogs.ok(d)},handleMissingTmpImages:function(a){a.missingImages&&this.editor.refetchMissingImages(a.missingImages);a.errorMsg&&ws.widget.Dialogs.ok(a.errorMsg)},onShowSendConfirmation:function(){},saveMessage:function(){this.toggleButtonState(!1);Config.FixDomainlessAddresses&&Config.FixDomainlessAddresses.length>
0&&this.fixDomainlessAddresses();e.publish("WSFeedbackStart",[Config.Strings.SavingProgress]);this.showFeedback();var a=e.hitch(this,function(a){this.filledFileInputs.length<=0?(ws.widget.Dialogs.ok(a||Config.Strings.ErrorSaving),this.toggleButtonState(!0),this.inSaveOrSend=null):this.ss(!1,a)});this.saveOrSendMessage({action:"saveMessage",load:e.hitch(this,function(c){var d=!1;if(c.attachmentFailure)d=!0,this.handleFailedAttachment(c,"saveMessage");else if(c.attachTooLarge){a(c.errorMsg);return}else c.missingImages&&
(d=!0,this.handleMissingTmpImages(c));if(c.savedMsgUID)this.draftMessage.uid=this.lastSavedMsgUID=c.savedMsgUID;e.publish("WSFeedbackEnd",[Config.Strings.SavingProgress]);d||e.publish("WSFeedbackStart",[Config.Strings.MessageSaved,!0]);this.sendButton&&this.toggleButtonState(!0);d||(ws.reporting.reportAction("Save Message"),this.editor&&this.resetDirty());(this.editor&&this.forceReadSavedMsg||this.draftMessage&&this.draftMessage.hasImages||this.draftMessage&&this.draftMessage.hasAttachments)&&this.syncAftersave("Drafts",
c.savedMsgUID);this.toolbar&&this.toolbar.layout();this.inSaveOrSend=null}),error:a})},autoSaveMessage:function(){if(!(!0==this.autoSaveMsgInProgress||null!=this.inSaveOrSend||this.editor.isSpellCheckRunning()||this.preloadAttachments.length>0&&this.hasInflightAttachments())){this.autoSaveIntervalCounter+=Config.AutoSaveToDraftsSubInterval;if(this.autoSaveIntervalCounter>=Config.AutoSaveToDraftsInterval){if(this.autoSaveIntervalCounter=0,!this.isDirty())return}else if(!this.isSubIntervalDirty())return;
this.toggleButtonState(!1);this.autoSaveMsgInProgress=!0;this.showFeedback(Config.Strings.SavingProgress,!0);var a=e.hitch(this,function(){this.handleRevertBackAll();null!=this.lastSavedMsgUID&&this.deleteAutoSaveDraft();this.toggleButtonState(!0);this.showFeedback()});this.doAutoSaveMessage({action:"saveMessage",load:e.hitch(this,function(c){var d=!1;if(c.attachmentFailure||c.attachTooLarge)a(c.errorMsg);else{c.missingImages&&(d=!0,this.handleMissingTmpImages(c));if(Config.EnableDiffAttachmentUpload&&
this.filledFileInputs.length>0){for(var e=0;e<this.filledFileInputs.length;e++)this.autoSavedAttachments[this.filledFileInputs[e].value]=this.filledFileInputs[e];this.autoSavedAttachmentsCount+=this.filledFileInputs.length}if(c.savedMsgUID)this.draftMessage.uid=this.lastSavedMsgUID=c.savedMsgUID;if(!d){var e=new Date,g=Config.Strings.MessageSaved;null!=e&&(g=ws.string.substituteParams(Config.Strings.AutoSavedDrafts,ws.date.formatTime(e,"h:mma")));this.showFeedback(g);this.lastSaved=e}this.autoSaveMsgInProgress=
!1;this.toggleButtonState(!0);d||(ws.reporting.reportAction("Save Message"),this.resetDirty());(this.forceReadSavedMsg||this.draftMessage&&this.draftMessage.hasImages||this.draftMessage&&this.draftMessage.hasAttachments)&&this.syncAftersave("Drafts",c.savedMsgUID)}}),error:a})}},hasInflightAttachments:function(){return function(a){for(var c=0;c<a.length;c++)if(a[c].inflight&&!a[c].cancelled)return!0;return!1}(this.preloadAttachments)},cancelInfightAttachments:function(){(function(a){for(var c=0;c<
a.length;c++)if(a[c].inflight)a[c].cancelled=!0})(this.preloadAttachments)},handlePendingSaveOrSend:function(a){if(a)this.pendingSaveOrSendArgs!=null&&!this.hasInflightAttachments()&&this.saveOrSendMessage(this.pendingSaveOrSendArgs);else if(this.pendingSaveOrSendArgs)this.inSaveOrSend=this.pendingSaveOrSendArgs=null,this.toggleButtonState(!0)},ffiTooLarge:function(){for(var a=0;a<this.filledFileInputs.length;a++)if(this.filledFileInputs[a].tooLarge)return!0;return!1},saveOrSendMessage:function(a){this.inSaveOrSend=
a.action;this.editor.endSpellCheck();if(this.hasInflightAttachments())this.pendingSaveOrSendArgs=a,this.model.trackdl("-CMW.SOSa",this.reportingDLreqID);else{this.pendingSaveOrSendArgs=null;this.editor.prepareForSaveOrSend(this.inSaveOrSend=="sendMessage");for(var c=[],d=0,d=0;d<this.sourceAttachments.length;d++)c.push(this.sourceAttachments[d].id);for(var e=[],d=0;d<this.preloadAttachments.length;d++)e.push({id:this.preloadAttachments[d].id,name:this.preloadAttachments[d].name,size:this.preloadAttachments[d].size});
d=this.draftMessage.inReplyTo||this.originalMessage.messageID;this.mk=Math.random().toString(16).substring(2);this.handleAutoSavedAttachmentDiffUpload(!0);this.model.trackdl("-CMW.SOSb",this.reportingDLreqID);this.model[a.action]({content:{From:this.fromSelect.currentValue,To:this.toField.getValue(),Cc:this.ccField.getValue(),Bcc:this.bccField.getValue(),Subject:this.subjectInput.value,RichBody:this.editor.richMode?this.editor.getRichContent():null,PlainBody:this.editor.getPlainContent(),RichEdit:this.editor.richMode,
ParentMessageID:d,ParentReferences:this.originalMessage.references,ParentInReplyTo:this.originalMessage.inReplyTo,AnswerUID:this.composeType.indexOf("reply")!=-1?this.originalMessage.uid:null,AnswerFolder:this.composeType.indexOf("reply")!=-1?this.originalMessage.folder:null,DraftMsgFolder:this.lastSavedMsgUID?Config.DraftsFolderName:this.draftMessage.folder,DraftMsgUID:this.lastSavedMsgUID||this.draftMessage.uid,SourceMsgUID:this.originalMessage.uid||this.lastSavedMsgUID||this.draftMessage.uid,SourceMsgFolder:this.originalMessage.folder||
(this.lastSavedMsgUID?Config.DraftsFolderName:this.draftMessage.folder),SourceAttachmentIDs:c,PreloadAttachmentIDs:e,SendAttachAsLinks:this.sendAttachAsLinks,ComposeType:this.composeType},mk:this.mk,formNode:this.form,load:a.load,error:a.error})}},doAutoSaveMessage:function(a){this.editor.prepareForSaveOrSend(!1);var c=[],d;for(d=0;d<this.sourceAttachments.length;d++)c.push(this.sourceAttachments[d].id);var e=[];for(d=0;d<this.preloadAttachments.length;d++)e.push({id:this.preloadAttachments[d].id,
name:this.preloadAttachments[d].name,size:this.preloadAttachments[d].size});d=this.draftMessage.inReplyTo||this.originalMessage.messageID;this.handleAutoSavedAttachmentDiffUpload(!1);this.mk=Math.random().toString(16).substring(2);this.model.saveMessage({content:{From:this.fromSelect.currentValue,To:this.toField.getValue(),Cc:this.ccField.getValue(),Bcc:this.bccField.getValue(),Subject:this.subjectInput.value,RichBody:this.editor.richMode?this.editor.getRichContent():null,PlainBody:this.editor.getPlainContent(),
RichEdit:this.editor.richMode,ParentMessageID:d,ParentReferences:this.originalMessage.references,ParentInReplyTo:this.originalMessage.inReplyTo,AnswerUID:this.composeType.indexOf("reply")!=-1?this.originalMessage.uid:null,AnswerFolder:this.composeType.indexOf("reply")!=-1?this.originalMessage.folder:null,DraftMsgFolder:this.lastSavedMsgUID?Config.DraftsFolderName:this.draftMessage.folder,DraftMsgUID:this.lastSavedMsgUID||this.draftMessage.uid,SourceMsgUID:this.originalMessage.uid||this.lastSavedMsgUID||
this.draftMessage.uid,SourceMsgFolder:this.originalMessage.folder||(this.lastSavedMsgUID?Config.DraftsFolderName:this.draftMessage.folder),SourceAttachmentIDs:c,PreloadAttachmentIDs:e,SendAttachAsLinks:this.sendAttachAsLinks,ComposeType:this.composeType,DiffAttachmentUpload:this.oneDiffUploadComplete},mk:this.mk,formNode:this.form,load:a.load,error:a.error})},handleAutoSavedAttachmentDiffUpload:function(a){if(Settings.UserHash>=Config.AutoSaveToDraftsThreshold&&Config.EnableDiffAttachmentUpload&&
Settings.EnableAutoSave&&0<this.autoSavedAttachmentsCount)if(this.attachmentsDeleted||a)this.handleRevertBackAll();else if(this.filledFileInputs.length>0)for(a=this.filledFileInputs.length-1;a>=0;a--)if(this.autoSavedAttachments[this.filledFileInputs[a].value])this.autoSavedAttachments[this.filledFileInputs[a].value].displayInAttachRow=!0,this.filledFileInputs.splice(a,1),this.oneDiffUploadComplete=!0},handleRevertBackAll:function(){var a=0,c;for(c in this.autoSavedAttachments)this.autoSavedAttachments[c].displayInAttachRow=
!1,this.filledFileInputs.splice(a++,0,this.autoSavedAttachments[c]);this.oneDiffUploadComplete=this.attachmentsDeleted=!1;this.autoSavedAttachmentsCount=0;this.autoSavedAttachments={}},ss_dl_report_error:function(a,c,d){if(d&&(d=="550:13045"||d=="500:13052"||d==Config.Strings.ErrorSendingAttachTooLarge2||d==Config.Strings.ErrorSendingAttachTooLarge))a="userErr";this.model.trackdl("-CMW.REa",this.reportingDLreqID);this.DLreport.endEvent(this.reportingDLreqID,{opResult:a,errType:c,errCode:d})},ss:function(a,
c,d){this.model.trackdl("-CMW.SSa",this.reportingDLreqID);ws.io.rpc({action:"SS",content:{m:this.mk},load:e.hitch(this,function(f){if(a){var g="fail";if(f&&f.a&&f.a=="1")c=Config.Strings.ErrorSendingAttachTooLarge2,g="userErr";this.model.trackdl("-CMW.SSb",this.reportingDLreqID);this.ss_dl_report_error(g,"app",d||c||Config.Strings.ErrorSending);ws.widget.Dialogs.ok(c||Config.Strings.ErrorSending);this.toggleButtonState(!0);this.inTransition=!1;this.inSaveOrSend=null}else{this.model.trackdl("-CMW.SSc",
this.reportingDLreqID);if(f&&f.a&&f.a=="1")c=Config.Strings.ErrorSavingAttachTooLarge2;ws.widget.Dialogs.ok(c||Config.Strings.ErrorSaving);this.toggleButtonState(!0);this.inSaveOrSend=null;e.publish("WSFeedbackEnd",[Config.Strings.SendingProgress])}}),error:function(e){a?(this.model.trackdl("-CMW.SSd",this.reportingDLreqID),this.ss_dl_report_error("fail","api",d||c||Config.Strings.ErrorSendingAttachTooLarge),window.ws_ErrLgr&&!e&&ws_ErrLgr.logError(ws_ErrLgr.cat.UserVisErr,"Dialogs.ok shown - Error Handler for Send-ss file:ComposeMessageWidget.js"),
ws.widget.Dialogs.ok(c||Config.Strings.ErrorSendingAttachTooLarge),this.toggleButtonState(!0),this.inTransition=!1):(this.model.trackdl("-CMW.SSe",this.reportingDLreqID),this.showFeedback(),window.ws_ErrLgr&&!e&&ws_ErrLgr.logError(ws_ErrLgr.cat.UserVisErr,"Dialogs.ok shown - Error Handler for Save-ss file:ComposeMessageWidget.js"),ws.widget.Dialogs.ok(c||Config.Strings.ErrorSavingAttachTooLarge),this.toggleButtonState(!0));this.inSaveOrSend=null}});this.model.trackdl("-CMW.SSz",this.reportingDLreqID)},
spellCheck:function(){this.editor.spellChecking||(e.publish("WSFeedbackStart",[Config.Strings.SpellCheckProgress]),ws.reporting.reportAction("Spell Check"));this.editor.toggleSpellCheck()},onEndSpellCheck:function(){this.spellCheckButton.setHighlight(!1);this.sendAfterSpellCheck&&this.spellCheckFailure&&(e.doc.documentElement.focus(),ws.widget.Dialogs.okCancel(Config.Strings.SendConfirmationPrompt,e.hitch(this,function(a){a&&this.sendMessage();this.sendAfterSpellCheck=!1})))},onPerfectSpelling:function(){this.spellCheckFailure=
!1;e.publish("WSFeedbackEnd",[Config.Strings.SpellCheckProgress]);this.sendAfterSpellCheck&&this.sendMessage()},onImperfectSpelling:function(){this.spellCheckFailure=!0;e.publish("WSFeedbackEnd",[Config.Strings.SpellCheckProgress]);this.spellCheckButton.setHighlight(!0);this.sendAfterSpellCheck&&ws.widget.Dialogs.show(Config.Strings.SpellingErrorsFound,[Config.Strings.SendNow,Config.Strings.ReviewErrors],e.hitch(this,function(a){if(a==0)this.spellCheckFailure=!1,this.sendMessage()}),!0)},cancel:function(){this.cancelCB&&
this.cancelCB()},closeAfterSuccess:function(a){a?this.cancel():this.cancelCB&&this.cancelCB(null,!0,!0)},onClickNewWindow:function(){this.popOut()},popOut:function(a,c,d){this.checkForAttachments(e.hitch(this,"_popOut",d),a,c)},_popOut:function(a){window.composeContext={model:this.model,picturesModel:this.picturesModel,callback:e.hitch(this,"popOutComplete")};ws.io.openWindow(Config.BaseMailPagesURL+"ComposeMessage.aspx?ws_popup=true","","status=yes,resizable=yes,left=5,top=5,width=885,height=606",
a)},popOutComplete:function(a){var c={to:this.toField.getValue(),cc:this.ccField.getValue(),bcc:this.bccField.getValue(),subject:this.subjectInput.value,body:e.isWebKit&&this.editor.isEmpty()?"":this.editor.getContent(),originalMessage:this.originalMessage,draftMessage:this.draftMessage,composeType:this.composeType,dontAddSignature:!0,isDirty:this.isDirty(),preloadAttachments:this.preloadAttachments,sourceAttachments:this.sourceAttachments,isPopOut:!0,isStationeryMode:this.editor.isStationeryMode,
stationeryState:this.editor.stationeryState};this.preloadAttachments=[];this.editor.notifyUploadCompletions(a.editor);a.reset(c,e.hitch(this,function(){this.resetDirty();this.cancelCB&&this.cancelCB()}))},checkForAttachments:function(a,c,d){if(this.filledFileInputs.length>0||this.hasInflightAttachments())ws.widget.Dialogs[c?"ok":"okCancel"](Config.Strings.PopOutWithAttachedFilesWarning,e.hitch(this,function(e){if(c||e)this.cancelInfightAttachments(),a();d&&d()}));else a(),d&&d()},initAttachments:function(a,
c){this.fileInputCounter=0;var d;this.maxInlineAttachSize=parseInt(Config.MaxMessageSize);this.preloadAttachments=[];this.attachUploadDispId=0;this.attachUploadDispRefObjs={};this.attachUploadDispNodes={};this.attachUploadFilenameMap={};if(c)this.sourceAttachments=ws.lang.shallowCopy(c,!0);else{this.sourceAttachments=[];var f=this.originalMessage.attachments||this.draftMessage.attachments;if(f&&(this.composeType=="forward"||this.composeType=="draft"))for(d=0;d<f.length;d++)this.sourceAttachments.push(f[d])}if(!Config.EnableFlashFileUploader){if(this.filledFileInputs)for(d=
0;d<this.filledFileInputs.length;d++)e._destroyElement(this.filledFileInputs[d]);this.form||(this.createBaseAttachUploadForm(),this.editor.attachButton.appendChild(this.form));this.emptyFileInput&&e._destroyElement(this.emptyFileInput);this.form&&this.createEmptyFileInput()}this.filledFileInputs=[];for(d=this.attachmentDisplay;d.lastChild!=null;)d.removeChild(d.lastChild);this.updateAttachmentRow()},createEmptyFileInput:function(){this.emptyFileInput=e.create("input",{type:"file",name:"file"+this.fileInputCounter++,
displayInAttachRow:!1,className:"fileIputElement",style:{opacity:0}},this.form);this.connect(this.emptyFileInput,"onchange","onSelectFile")},onSelectFile:function(){var a=this.emptyFileInput;if(a.value!="")a.style.top="-10000px",a.style.left="-10000px",this.filledFileInputs.push(a),this.createEmptyFileInput(),this.updateAttachmentRow()},findRefObjKey:function(a){var c=null,d;for(d in this.attachUploadDispRefObjs)if(a===this.attachUploadDispRefObjs[d]){c=d;break}return c},addRefObj:function(a){var c=
this.findRefObjKey(a),d=!1;c||(c="dispId"+this.attachUploadDispId++,this.attachUploadDispRefObjs[c]=a,d=!0);return{key:c,isNew:d}},updateInlineImage:function(){this.forceReadSavedMsg=this.draftMessage&&typeof this.draftMessage.hasImages!="undefined"?this.draftMessage.hasImages:!0},getFileSizeString:function(){var a=this.filledFileInputs,c,d,e;if(a.length&&(a=a[a.length-1]))if(d=a&&a.files&&a.files.length)c=a.files[0],c=c.fileSize||c.size;c&&(e=c>=1E6?Math.round(c/1E6*10)/10+" MB":c>=1E3?Math.round(c/
1E3)+" KB":c+" Bytes");return e},updateAttachmentRow:function(){var a={},c,d;this.forceReadSavedMsg=this.draftMessage&&typeof this.draftMessage.hasAttachments!="undefined"?this.draftMessage.hasAttachments:!0;var f=e.hitch(this,function(a,c,d){var f=a,g="";if(a.length>=30){var h=a.lastIndexOf(".");h!=-1&&(g=a.substring(h+1));a=a.substring(0,27)+"..."+g}(g=this.getFileSizeString())&&(a+=" ("+g+")");a=new ws.widget.Button({label:a,title:f,className:"attachmentBtn",showArrow:!0,fixSize:!0});e.addClass(a.arrowImg,
"deleteBtn");e.style(a.domNode,{cursor:"default"});e.style(a.arrowImg,{cursor:"pointer"});this.attachmentDisplay.appendChild(a.domNode);a.startup();this.connect(a.arrowImg,"onclick",c);this.attachUploadDispNodes[d]=a.domNode});for(d=0;d<this.sourceAttachments.length;d++)c=this.addRefObj(this.sourceAttachments[d]),a[c.key]=this.attachUploadDispRefObjs[c.key],c.isNew&&f(this.sourceAttachments[d].name,e.hitch(this,"deleteSourceAttachment",c.key),c.key,!1);if(Settings.UserHash>=Config.AutoSaveToDraftsThreshold&&
Config.EnableDiffAttachmentUpload&&Settings.EnableAutoSave&&this.oneDiffUploadComplete&&0<this.autoSavedAttachmentsCount)for(var g in this.autoSavedAttachments)this.autoSavedAttachments[g].displayInAttachRow&&(c=this.addRefObj(this.autoSavedAttachments[g]),a[c.key]=this.attachUploadDispRefObjs[c.key],c.isNew&&f(this.getFileName(g),e.hitch(this,"deleteAutoSavedFileAttachment",g),c.key,!1));for(d=0;d<this.filledFileInputs.length;d++)c=this.addRefObj(this.filledFileInputs[d]),a[c.key]=this.attachUploadDispRefObjs[c.key],
c.isNew&&f(this.getFileName(this.filledFileInputs[d].value),e.hitch(this,"deleteFileAttachment",c.key),c.key,!1);for(d=g=0;d<this.preloadAttachments.length;d++)if(c=this.addRefObj(this.preloadAttachments[d]),a[c.key]=this.attachUploadDispRefObjs[c.key],c.isNew){var i=this.preloadAttachments[d].name;g+=this.preloadAttachments[d].size;if(!this.preloadAttachments[d].inflight&&this.preloadAttachments[d].size>0){var j=this.preloadAttachments[d].size/1024;j<=0&&(j=1);i=ws.string.summary(i,55);i=i+" ("+
j.toFixed(0)+" "+Config.Strings.KilobytesShort+")"}f(i,e.hitch(this,"deletePreloadAttachment",this.preloadAttachments[d].clientId),c.key,!0)}this.attachUploadDispRefObjs=a;var a=0,h;for(h in this.attachUploadDispNodes)this.attachUploadDispRefObjs[h]?a++:(this.attachmentDisplay.removeChild(this.attachUploadDispNodes[h]),delete this.attachUploadDispNodes[h]);ws.html.setShowing(this.attachmentRow,a>0);this.layoutSoon()},getFileName:function(a){return a.indexOf("/")>-1?a.substring(a.lastIndexOf("/")+
1):a.substring(a.lastIndexOf("\\")+1)},deleteSourceAttachment:function(a){for(var c=0;c<this.sourceAttachments.length;c++)this.sourceAttachments[c]===this.attachUploadDispRefObjs[a]&&(this.sourceAttachments.splice(c,1),this.updateAttachmentRow())},deleteFileAttachment:function(a){for(var c=0;c<this.filledFileInputs.length;c++)this.filledFileInputs[c]===this.attachUploadDispRefObjs[a]&&(e._destroyElement(this.filledFileInputs[c]),this.filledFileInputs.splice(c,1),this.updateAttachmentRow())},deleteAutoSavedFileAttachment:function(a){if(this.autoSavedAttachments[a])this.autoSavedAttachments[a].displayInAttachRow=
!1;if(!1==this.attachmentsDeleted)this.attachmentsDeleted=!0;this.updateAttachmentRow()},deletePreloadAttachment:function(a){for(var c=0,d=null,e=0;e<this.preloadAttachments.length;e++)if(this.preloadAttachments[e].clientId==a){d=this.preloadAttachments[e];c=e;break}if(d){this.preloadAttachments.splice(c,1);this.updateAttachmentRow();if(this.uploadIoHandle)this.uploadIoHandle.abort(),this.uploadIoHandle=null;if(d.inflight)d.cancelled=!0,this.handlePendingSaveOrSend(!0)}},createFlashFileUploder:function(){if(!this.flashFileUploder){var a=
encodeURIComponent("?user="+ws.io.getUserUid()+"&a=ComposeMessageImageStore&l="+ws.io.getL7Id()+"&r="+Math.random()),a=Config.BaseARpcPagesURL+"ARPC.aspx"+a,c=e.create("div",{style:{visibility:"hidden",position:"absolute",top:"0px",left:"0px",width:"35px",height:"24px"}}),d=e.create("div",{style:{position:"relative",width:"35px",height:"24px"}});d.innerHTML=".";this.editor.attachButton.appendChild(c);c.appendChild(d);this.flashFileUploder=new q.form.FileUploader({deferredUploading:1,uploadUrl:a,uploadOnChange:!1,
selectMultipleFiles:!0,fileMask:["All Files","*.*"],force:"flash",skipServerCheck:!0,serverTimeout:6E4,devMode:!0,isDebug:!0,useFileReferenceUpload:e.isIE?!0:!1},d);this._supportingWidgets.push(this.flashFileUploder);this.connect(this.flashFileUploder,"onReady",function(){this.flashFileUploder.insideNode.firstChild&&(e.style(this.flashFileUploder.insideNode.firstChild,"opacity",0.01),e.style(c,"visibility","visible"))});this.connect(this.flashFileUploder,"onChange","onFlashUploadFileSelect");this.connect(this.flashFileUploder,
"onProgress","onFlashUploadProgress");this.connect(this.flashFileUploder,"onComplete","onFlashUploadComplete")}},onFlashUploadFileSelect:function(a){var c;if(typeof this.sourceAttachmentsSize=="undefined")for(c=this.sourceAttachmentsSize=0;c<this.sourceAttachments.length;c++)this.sourceAttachmentsSize+=this.sourceAttachments[c].size;var d=this.sourceAttachmentsSize;for(c=0;c<this.preloadAttachments.length;c++)this.preloadAttachments[c].cancelled||(d+=this.preloadAttachments[c].size);for(c=0;c<a.length;c++){if(d+
a[c].size>this.maxInlineAttachSize){a=ws.string.substituteParams(Config.Strings.AttachTooLarge,this.maxInlineAttachSize/1024/1024);ws.widget.OkCancelDialog.alert(a);break}d+=a[c].size;this.preloadAttachments.push({id:"file"+this.fileInputCounter++,clientId:this.nextCid++,name:a[c].name,size:a[c].size,type:a[c].type,inflight:!0,cancelled:!1})}this.updateAttachmentRow();ws.lang.setTimeout(this,function(){this.flashFileUploder.upload({requests:'[{"id":"ATCH","action":"ComposeMessageImageStore"}]'})},
500)},onFlashUploadProgress:function(){},onFlashUploadComplete:function(a){for(var c=function(a){var c=null,d=a.indexOf("id=ATCH.");d>=0&&(c="ATCH."+/[0-9]+/.exec(a.substr(d+8)));return c},d=0;d<a.length;d++){var e=this.attachUploadFilenameMap[a[d].name];if(e){var g=a[d].serverResp,i=null;g&&(i=c(g));if(i&&(e=this.attachUploadDispRefObjs[e]))e.id=i,e.inflight=!1}}},positionAttachFileButton:function(){Config.EnableFlashFileUploader&&!this.flashFileUploder&&(e.require("ws.layers.FileUploader"),e.addOnLoad(this,
"createFlashFileUploder"))},positionRichTextButton:function(){this.editor.richTextButton.style.display=e.isIE&&ws.browser.ns8||Settings.UseRichEditor||Config.PageLocale!="en-us"?"none":""},fetchAndRespond:function(a,c,d){this.model.getMessage({folder:a,uid:c,load:e.hitch(this,function(a){this[d](a)})})},reply:function(a){this.checkAndRestoreImageOrLinks(a);var c;a.containsHchat&&(c=a.to[0].userInputForm.replace(/\@unknown\.domain/i,""));this.composeResponse(a,"reply",Config.Strings.ReplyPrefix,c||
a.replyToAddrs);if(e.isFF&&!this.editor.htmlMode)try{this.editor.textarea.setSelectionRange(0,0)}catch(d){}},containsSenderAddress:function(a,c){if(a&&a.length>0&&c&&c.length>0)for(var d=0;d<c.length;d++)for(var e=c[d][1].toLowerCase(),g=0;g<a.length;g++)if(ret=a[g].userInputForm.toLowerCase().indexOf(e)!=-1)return!0;return!1},replyAll:function(a){this.checkAndRestoreImageOrLinks(a);var c=!1;if(a.folderType=="Inbox"||a.folderType=="NewMail"||a.folderType=="OldMail"||a.folderType=="Personal"||a.folderType==
"Saved"||a.folderType=="AutoSavedRead")var c=this.containsSenderAddress(a.to,this.model.sendAddresses),d=this.containsSenderAddress(a.cc,this.model.sendAddresses),f=this.containsSenderAddress(a.from,this.model.sendAddresses),c=!c&&!d&&!f&&!a.isLikelyForward;var g;a.containsHchat&&(g=a.to[0].userInputForm.replace(/\@unknown\.domain/i,""));this.composeResponse(a,"reply-all",Config.Strings.ReplyPrefix,g||a.replyAllAddrs,a.replyAllCcAddrs);c&&(e.publish("peoplepicker/close"),window.clearTimeout(this.focusBodyTimer),
a=ws.widget.Dialogs.okCancel(Config.Strings.BccReplyConfirm,e.hitch(this,function(a){a?this.focusField():(this.resetDirty(),this.cancel())}),!0),setTimeout(e.hitch(a,"focus"),250));if(e.isFF&&!this.editor.htmlMode)try{this.editor.textarea.setSelectionRange(0,0)}catch(i){}},isImageRemoved:function(a){var c=a.stripImagesKey&&a.body.indexOf(a.stripImagesKey)!=-1;if(c&&(!Settings.DisplayImageWarning||this.addressModel.getRecordByEmail(a.from[0].userInputForm)))c=!1;return c},isLinkRemoved:function(a){var c=
a.stripLinksKey&&a.body.indexOf(a.stripLinksKey)!=-1;if(c&&(!Settings.DisplayLinkWarning||this.addressModel.getRecordByEmail(a.from[0].userInputForm)))c=!1;return c},checkAndRestoreImageOrLinks:function(a){ws.WebSuite.isDispMessageSafe(a.uid)&&this._restoreImages(a);ws.WebSuite.isDispMessageSafe(a.uid,!0)&&this._restoreLinks(a)},restoreImagesAndLinks:function(a){this._restoreImages(a);this._restoreLinks(a)},_restoreImages:function(a){a.body=a.body.replace(RegExp(a.stripImagesKey,"g"),"");a.stripImagesKey=
null;ws.WebSuite.setDispMessageSafe(a.uid)},_restoreLinks:function(a){re=RegExp(a.stripLinksKey,"g");a.body=a.body.replace(re,"");a.stripLinksKey=null;ws.WebSuite.setDispMessageSafe(a.uid,!0)},forward:function(a){this.checkAndRestoreImageOrLinks(a);var c=null;if(this.isImageRemoved(a)&&this.isLinkRemoved(a))c=Config.Strings.ShowImagesAndEnableLinksBeforeSending;else if(this.isImageRemoved(a))c=Config.Strings.ShowImagesBeforeSending;else if(this.isLinkRemoved(a))c=Config.Strings.EnableLinksBeforeSending;
c!=null?ws.widget.Dialogs.okCancel(c,e.hitch(this,function(c){c&&this.restoreImagesAndLinks(a);this.composeResponse(a,"forward",Config.Strings.ForwardPrefix)})):this.composeResponse(a,"forward",Config.Strings.ForwardPrefix);if(e.isFF&&!this.editor.htmlMode)try{this.editor.textarea.setSelectionRange(0,0)}catch(d){}},composeResponse:function(a,c,d,f,g){var i=a.selectedText?"<blockquote style='border-left: 2px solid blue; padding-left: 3px;'>"+a.selectedText+"</blockquote>":"",j=this.buildOrigMessageBodyHeader(a),
h=a.body.replace(RegExp("<div[^>]+AOLImageAttachmentHeader[^\n]+\n\r\n","gi"),""),h=h.replace(RegExp(/<div id="AOLMsgImgInlineRenderPart[\s\S]*?--\>/gim),""),l=[a.displayTo,a.displayCc,a.displayBcc,a.displayFrom].join(";"),k=this.model.getUidData(a.uid);Settings.HasAggregatedAccount&&k&&(l=this.model.identities[k[this.model.columns.Account]][1]);k=null;this.isPopup||(k="Inline Response");this.reset({from:l,to:f,cc:g,subject:d+" "+this.model.getBaseSubject(a.subject),quote:i,body:j+h,originalMessage:a,
composeType:c,backToString:this.backToString,beaconSuffix:k,isStationeryMode:!1},e.hitch(this,function(){this.editor.richMode&&this.editor.getFunmail().finalizeTemplate()}))},buildOrigMessageBodyHeader:function(a){var c=Config.Strings.OriginalMessage+"\n";a.displayFrom&&(c+=Config.Strings.From+": "+a.displayFrom+"\n");if(a.displayTo){var d=a.displayTo.replace(/\@unknown\.domain/i,"");c+=Config.Strings.To+": "+d+"\n"}a.displayCc&&(c+=Config.Strings.Cc+": "+a.displayCc+"\n");c+=Config.Strings.SentOn+
": "+ws.date.formatDateTime(new Date(a.receivedTime),Config.Strings.MsgViewDateFormat)+"\n";a.subject!=null&&a.subject!=""&&(c+=Config.Strings.Subject+": ",c+=a.subject,c+="\n");c+="\n";c=ws.string.escapeXml(c);return c=c.replace(/\n/g,"<br>")},showFeedback:function(a,c){a?ws.html.setShowing(this.feedbackNode,!0):(ws.html.setShowing(this.feedbackNode,!1),this.spinner&&this.spinner.stop());if(c){if(!this.spinner)this.spinner=new ws.Spinner("AutoSave",this.feedbackSpin);this.spinner.spin()}else this.spinner&&
this.spinner.stop();ws.html.setInnerText(this.feedbackMsg,a||"")},checkEmailFields:function(){var a=this.toField.getValue(),c=this.ccField.getValue(),d=this.bccField.getValue();if((!a||a=="")&&(!c||c=="")&&(!d||d==""))return ws.widget.Dialogs.ok(Config.Strings.ErrorNoValidRecipient),!0;var e="";if(this.preventDomainlessAddressFix){if(e=this.isEmailAddress(a))return ws.widget.Dialogs.ok(ws.string.substituteParams(Config.Strings.InvalidAddressInField,e,Config.Strings.To)),!0;if(e=this.isEmailAddress(c))return ws.widget.Dialogs.ok(ws.string.substituteParams(Config.Strings.InvalidAddressInField,
e,Config.Strings.Cc)),!0;if(e=this.isEmailAddress(d))return ws.widget.Dialogs.ok(ws.string.substituteParams(Config.Strings.InvalidAddressInField,e,Config.Strings.Bcc)),!0}else{var g=this.isEmailAddress(a),a=0;g&&g!=""&&(e+="<br/><span style='font-weight:bold'>"+Config.Strings.To+"</span>: "+g+"\n",a++);if((c=this.isEmailAddress(c))&&c!="")e+="<br/><span style='font-weight:bold'>"+Config.Strings.Cc+"</span>: "+c+"\n",a++;if((d=this.isEmailAddress(d))&&d!="")e+="<br/><span style='font-weight:bold'>"+
Config.Strings.Bcc+"</span>: "+d+"\n",a++;d=!1;if(e&&(e.match(",")||a>1))d=!0;a="";if(e&&e!="")return a=d?Config.Strings.WrongEmailAddresses:Config.Strings.WrongEmailAddress,a+=e+ws.string.substituteParams(Config.Strings.CorrectFormat,"<span style='font-style:italic'>","</span>"),ws.widget.Dialogs.ok(a),!0}return!1},isEmailAddress:function(a){var c="";if(a)for(var a=a.split(/[,;]/),d=0;d<a.length;d++){var e=a[d].match(/(.+)@(.+)\.(.+)/);e!=null&&e.length==4||(c&&a[d]!=""&&(c+=","),c+=a[d])}return c},
fixDomainlessAddresses:function(a){if(!this.preventDomainlessAddressFix&&Config.FixDomainlessAddresses&&Config.FixDomainlessAddresses.length>0){var c=ws.UserContext.UserAddress.split("@");if(!(c&&c.length!=2)){var d=c[1],c=Config.FixDomainlessAddresses.toLowerCase().split(",");e.indexOf(c,d.toLowerCase())<0||(c=e.hitch(this,function(a){var c=a.getValue();if(c!=""){for(var c=c.split(/[,;]/),i=0;i<c.length;i++){var j=e.trim(c[i]);if(j!=""){var h=this.addressModel.searchDLName(j);h!=null&&h.composeValue!=
null?j=h.composeValue:j.indexOf("@")<1&&(j=j.replace(/\s+/g,"")+"@"+d)}c[i]=j}a.setValue(c.join(", "))}}),a?c(a):(c(this.toField),c(this.ccField),c(this.bccField)))}}},showBccParenWarning:function(){var a=this.toField.getValue()+this.ccField.getValue()+this.bccField.getValue();if(a.indexOf("(")!=-1||a.indexOf(")")!=-1)return ws.widget.Dialogs.ok(Config.Strings.ProductName+Config.Strings.BccParenthesesWarning,e.hitch(this,"showBcc")),!0;return!1},showMissingAttachmentWarning:function(){if(!ws.lang.isEmptyArray(this.sourceAttachments)||
!ws.lang.isEmptyArray(this.filledFileInputs)||!ws.lang.isEmptyArray(this.preloadAttachments))return!1;else if(this.missingAttachmentWarningShown)return!1;for(var a=this.editor.getPlainContent().toLowerCase(),c=a.indexOf(Config.Strings.OriginalMessage.toLowerCase()),a=c==-1?this.subjectInput.value+" "+a:a.substring(0,c),c=Config.Strings.attachmentWordList.split(","),d=0;d<c.length;d++)if(a.indexOf(c[d].toLowerCase())!=-1)return ws.widget.Dialogs.okCancel(ws.string.substituteParams(Config.Strings.MissingAttachmentWarning,
"<br><br>",c[d]),e.hitch(this,function(a){a&&this.sendMessage()}),!0),this.missingAttachmentWarningShown=!0;return!1},setupSendConfirmation:function(){if(this.sendConfirmation){var a=this.stackWidget.getChildren();e.indexOf(a,this.sendConfirmation)==-1&&this.stackWidget.addChild(this.sendConfirmation)}else this.sendConfirmation=new ws.mail.SendConfirmationPage({composeWidget:this,cancelCB:e.hitch(this,"closeAfterSuccess")}),this.stackWidget.addChild(this.sendConfirmation);a=this.backToStringOverride||
this.backToButtonString||Config.Strings.Back;this.backToButtonString=null;var c=ws.string.escapeXml(this.subjectInput.value||"");this.sendConfirmation.setupSendConfirmation(a,c,this.isResponse,this.topContactSuggest);this.resetStationery()},sendIM:function(a){ws.presence._launchIM(a,!1)},launchStationery:function(){},setField:function(a,c){var d=c.replace(/^\s+/,"").replace(/\s+$/,"");if(d!=""){var e=this[a.toLowerCase()+"Field"],g=e.getValue().replace(/^\s+/,"").replace(/\s+$/,"");a.toLowerCase()==
"cc"?this.showCc():a.toLowerCase()=="bcc"&&this.showBcc();g?g+=g.charAt(g.length-1)==";"||g.charAt(g.length-1)==","?" "+d+",":", "+d+",":g=d+",";e.setValue(g)}},uninitialize:function(){this.sendConfirmation&&this.sendConfirmation.destroyRecursive()}}));e._hasResource["ws.layers.ComposeMessage"]||(e._hasResource["ws.layers.ComposeMessage"]=!0,e.provide("ws.layers.ComposeMessage"))}}});
